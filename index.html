<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikacija za Radne Naloge - Vi≈°ekorisniƒçka verzija</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            200: '#99f6e4',
                            300: '#5eead4',
                            400: '#2dd4bf',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                        },
                        'header': '#1a5f5f',
                    }
                }
            }
        }
    </script>
    <style>
        /* Minimax-style design */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        /* Crna crta za odvajanje naloga */
        .nalog-divider td {
            border-bottom: 2px solid #1f2937 !important;
        }
        
        /* Hover za tablice */
        table th {
            background-color: #f8fafc !important;
            font-weight: 600 !important;
            text-transform: uppercase !important;
            font-size: 0.7rem !important;
            letter-spacing: 0.05em !important;
            padding: 0.75rem 1rem !important;
            color: #64748b !important;
            border-bottom: 1px solid #e2e8f0;
        }
        table td {
            padding: 0.75rem 1rem !important;
            font-size: 0.875rem !important;
            color: #374151;
            border-bottom: 1px solid #f1f5f9;
        }
        table {
            font-size: 0.875rem;
            border-collapse: collapse;
        }
        
        /* Ljep≈°i scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* Smooth transitions */
        button, a, input, select {
            transition: all 0.15s ease;
        }
        
        /* Konzistentni gumbi */
        button.bg-primary-600, button.bg-primary-700 {
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* Card shadows */
        .card-shadow {
            box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
        }
        .card-shadow:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            #root main,
            #root main * {
                visibility: visible;
            }
            header, nav, button {
                display: none !important;
            }
            #root main {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
            .page-break-after {
                page-break-after: always;
                break-after: page;
            }
            .page-break-after:last-child {
                page-break-after: auto;
                break-after: auto;
            }
            @page {
                margin: 1cm;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Searchable Select za kupce (jer ih ima 2000+)
        function KlijentSelect({ kupci, value, onChange, disabled, required, displayName, small }) {
            const [isOpen, setIsOpen] = useState(false);
            const [search, setSearch] = useState('');
            const [dropdownStyle, setDropdownStyle] = useState({});
            const wrapperRef = useRef(null);
            const buttonRef = useRef(null);
            
            // Pronaƒëi naziv odabranog klijenta
            const selectedKupac = value ? kupci.find(k => String(k.id) === String(value)) : null;
            
            // Ako nije pronaƒëen ali imamo displayName, prika≈æi ga
            const displayText = selectedKupac ? selectedKupac.naziv : (displayName || 'Odaberi klijenta');
            
            // Filtriraj kupce prema pretrazi
            const filtered = search.length >= 1 
                ? kupci.filter(k => k.naziv.toLowerCase().includes(search.toLowerCase())).slice(0, 50)
                : kupci.slice(0, 50);
            
            // Zatvori dropdown kad se klikne vani
            useEffect(() => {
                function handleClickOutside(event) {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                }
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            // Izraƒçunaj poziciju dropdowna kad se otvori
            useEffect(() => {
                if (isOpen && buttonRef.current) {
                    const rect = buttonRef.current.getBoundingClientRect();
                    setDropdownStyle({
                        position: 'fixed',
                        top: rect.bottom + 4,
                        left: rect.left,
                        width: rect.width,
                        zIndex: 9999
                    });
                }
            }, [isOpen]);
            
            const handleSelect = (kupac) => {
                onChange(kupac.id);
                setSearch('');
                setIsOpen(false);
            };
            
            return (
                <div ref={wrapperRef} className="relative">
                    <div 
                        ref={buttonRef}
                        className={`w-full border rounded ${small ? 'px-2 py-1 text-sm' : 'px-3 py-2'} bg-white cursor-pointer flex justify-between items-center ${disabled ? 'bg-gray-100' : ''}`}
                        onClick={() => !disabled && setIsOpen(!isOpen)}
                    >
                        <span className={`${(selectedKupac || displayName) ? 'text-gray-900' : 'text-gray-400'} truncate`}>
                            {displayText}
                        </span>
                        <span className="text-gray-400 ml-1">‚ñº</span>
                    </div>
                    
                    {isOpen && (
                        <div style={dropdownStyle} className="bg-white border rounded-lg shadow-lg max-h-64 overflow-hidden">
                            <div className="p-2 border-b sticky top-0 bg-white">
                                <input
                                    type="text"
                                    placeholder="Pretra≈æi kupce..."
                                    value={search}
                                    onChange={(e) => setSearch(e.target.value)}
                                    className="w-full border rounded px-3 py-2 text-sm"
                                    autoFocus
                                    onClick={(e) => e.stopPropagation()}
                                />
                            </div>
                            <div className="overflow-y-auto max-h-48">
                                {filtered.length === 0 ? (
                                    <div className="px-3 py-2 text-gray-500 text-sm">Nema rezultata</div>
                                ) : (
                                    filtered.map(k => (
                                        <div
                                            key={k.id}
                                            className={`px-3 py-2 cursor-pointer hover:bg-primary-50 text-sm ${value && String(k.id) === String(value) ? 'bg-primary-100' : ''}`}
                                            onClick={() => handleSelect(k)}
                                        >
                                            {k.naziv}
                                        </div>
                                    ))
                                )}
                                {filtered.length === 50 && (
                                    <div className="px-3 py-2 text-gray-400 text-xs text-center border-t">
                                        Prikazano prvih 50 - upi≈°i za preciznije rezultate
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {/* Hidden input za form validation */}
                    {required && <input type="hidden" value={value || ''} required />}
                </div>
            );
        }

        // Autocomplete za artikle
        function ArtiklAutocomplete({ artikli, value, onChange, disabled }) {
            const [isOpen, setIsOpen] = useState(false);
            const [search, setSearch] = useState('');
            const [dropdownStyle, setDropdownStyle] = useState({});
            const wrapperRef = useRef(null);
            const buttonRef = useRef(null);
            
            const selectedArtikl = value ? artikli.find(a => String(a.id) === String(value)) : null;
            
            // Filtriraj artikle - po poƒçetku naziva
            const filtered = search.length >= 1 
                ? artikli.filter(a => a.naziv.toLowerCase().startsWith(search.toLowerCase())).slice(0, 30)
                : artikli.slice(0, 30);
            
            useEffect(() => {
                function handleClickOutside(event) {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                }
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            // Izraƒçunaj poziciju dropdowna kad se otvori
            useEffect(() => {
                if (isOpen && buttonRef.current) {
                    const rect = buttonRef.current.getBoundingClientRect();
                    setDropdownStyle({
                        position: 'fixed',
                        top: rect.bottom + 4,
                        left: rect.left,
                        width: 288,
                        zIndex: 9999
                    });
                }
            }, [isOpen]);
            
            const handleSelect = (artikl) => {
                onChange(artikl.id);
                setSearch('');
                setIsOpen(false);
            };
            
            return (
                <div ref={wrapperRef} className="relative">
                    <div 
                        ref={buttonRef}
                        className={`w-full border rounded px-1 py-1 text-xs bg-white cursor-pointer flex justify-between items-center ${disabled ? 'bg-gray-100' : ''}`}
                        onClick={() => !disabled && setIsOpen(!isOpen)}
                    >
                        <span className={`${selectedArtikl ? 'text-gray-900' : 'text-gray-400'} truncate`}>
                            {selectedArtikl ? selectedArtikl.naziv : '-- odaberi --'}
                        </span>
                        <span className="text-gray-400 ml-1 text-xs">‚ñº</span>
                    </div>
                    
                    {isOpen && (
                        <div style={dropdownStyle} className="bg-white border rounded-lg shadow-lg max-h-64 overflow-hidden">
                            <div className="p-2 border-b sticky top-0 bg-white">
                                <input
                                    type="text"
                                    placeholder="Upi≈°i poƒçetna slova..."
                                    value={search}
                                    onChange={(e) => setSearch(e.target.value)}
                                    className="w-full border rounded px-2 py-1 text-xs"
                                    autoFocus
                                    onClick={(e) => e.stopPropagation()}
                                />
                            </div>
                            <div className="overflow-y-auto max-h-48">
                                {filtered.length === 0 ? (
                                    <div className="px-2 py-2 text-gray-500 text-xs">Nema rezultata</div>
                                ) : (
                                    filtered.map(a => (
                                        <div
                                            key={a.id}
                                            className={`px-2 py-1.5 cursor-pointer hover:bg-primary-50 text-xs ${value && String(a.id) === String(value) ? 'bg-primary-100' : ''}`}
                                            onClick={() => handleSelect(a)}
                                        >
                                            <div className="font-medium">{a.naziv}</div>
                                            {a.sifra && <div className="text-gray-400">≈†ifra: {a.sifra}</div>}
                                        </div>
                                    ))
                                )}
                                {filtered.length === 30 && (
                                    <div className="px-2 py-1 text-gray-400 text-xs text-center border-t">
                                        Upi≈°i vi≈°e slova za preciznije rezultate
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Komponenta za pretra≈æivanje artikala
        function ArtiklSelect({ artikli, value, onChange, disabled }) {
            const [isOpen, setIsOpen] = useState(false);
            const [search, setSearch] = useState('');
            const wrapperRef = useRef(null);
            
            // Pronaƒëi naziv odabranog artikla
            const selectedArtikl = value ? artikli.find(a => String(a.id) === String(value)) : null;
            
            // Filtriraj artikle prema pretrazi (po prvim slovima)
            const filtered = search.length >= 1 
                ? artikli.filter(a => a.naziv.toLowerCase().startsWith(search.toLowerCase())).slice(0, 30)
                : artikli.slice(0, 30);
            
            // Zatvori dropdown kad se klikne vani
            useEffect(() => {
                function handleClickOutside(event) {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                }
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);
            
            const handleSelect = (artikl) => {
                onChange(artikl.id);
                setSearch('');
                setIsOpen(false);
            };
            
            return (
                <div ref={wrapperRef} className="relative">
                    <div 
                        className={`w-full border rounded px-1 py-1 text-xs bg-white cursor-pointer flex justify-between items-center ${disabled ? 'bg-gray-100' : ''}`}
                        onClick={() => !disabled && setIsOpen(!isOpen)}
                    >
                        <span className={selectedArtikl ? 'text-gray-900 truncate' : 'text-gray-400'}>
                            {selectedArtikl ? selectedArtikl.naziv : 'Odaberi artikl'}
                        </span>
                        <span className="text-gray-400 text-xs">‚ñº</span>
                    </div>
                    
                    {isOpen && (
                        <div className="absolute z-50 w-64 mt-1 bg-white border rounded-lg shadow-lg max-h-64 overflow-hidden">
                            <div className="p-2 border-b sticky top-0 bg-white">
                                <input
                                    type="text"
                                    placeholder="Upi≈°i poƒçetna slova..."
                                    value={search}
                                    onChange={(e) => setSearch(e.target.value)}
                                    className="w-full border rounded px-2 py-1 text-xs"
                                    autoFocus
                                    onClick={(e) => e.stopPropagation()}
                                />
                            </div>
                            <div className="overflow-y-auto max-h-48">
                                {filtered.length === 0 ? (
                                    <div className="px-2 py-2 text-gray-500 text-xs">Nema rezultata</div>
                                ) : (
                                    filtered.map(a => (
                                        <div
                                            key={a.id}
                                            className={`px-2 py-1 cursor-pointer hover:bg-primary-50 text-xs ${value && String(a.id) === String(value) ? 'bg-primary-100' : ''}`}
                                            onClick={() => handleSelect(a)}
                                        >
                                            <div className="font-medium">{a.naziv}</div>
                                            {a.kategorija && <div className="text-gray-400 text-xs">{a.kategorija}</div>}
                                        </div>
                                    ))
                                )}
                                {filtered.length === 30 && (
                                    <div className="px-2 py-1 text-gray-400 text-xs text-center border-t">
                                        Upi≈°i vi≈°e slova za preciznije rezultate
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // MaterijalSelect komponenta s pretragom (fixed pozicioniranje za modal)
        function MaterijalSelect({ materijali = [], value, onChange, disabled }) {
            const [isOpen, setIsOpen] = useState(false);
            const [search, setSearch] = useState('');
            const [dropdownStyle, setDropdownStyle] = useState({});
            const wrapperRef = useRef(null);
            const buttonRef = useRef(null);
            
            // Pronaƒëi odabrani materijal
            const selectedMaterijal = value ? (materijali || []).find(m => String(m.id) === String(value)) : null;
            
            // Filtriraj materijale prema pretrazi
            const matList = materijali || [];
            const filtered = search.length >= 1 
                ? matList.filter(m => 
                    m.naziv.toLowerCase().includes(search.toLowerCase()) ||
                    (m.kategorija && m.kategorija.toLowerCase().includes(search.toLowerCase()))
                  ).slice(0, 30)
                : matList.slice(0, 30);
            
            // Zatvori dropdown kad se klikne vani
            useEffect(() => {
                function handleClickOutside(event) {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                }
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);
            
            const openDropdown = () => {
                if (disabled) return;
                if (buttonRef.current) {
                    const rect = buttonRef.current.getBoundingClientRect();
                    setDropdownStyle({
                        position: 'fixed',
                        top: rect.bottom + 2,
                        left: rect.left,
                        width: Math.max(rect.width, 320),
                        zIndex: 99999
                    });
                }
                setIsOpen(!isOpen);
            };
            
            const handleSelect = (materijal) => {
                onChange(materijal);
                setSearch('');
                setIsOpen(false);
            };
            
            return (
                <div ref={wrapperRef} className="relative flex-1">
                    <div 
                        ref={buttonRef}
                        className={`w-full border rounded px-2 py-1 text-sm bg-white cursor-pointer flex justify-between items-center ${disabled ? 'bg-gray-100' : ''}`}
                        onClick={openDropdown}
                    >
                        <span className={selectedMaterijal ? 'text-gray-900 truncate' : 'text-gray-400'}>
                            {selectedMaterijal 
                                ? `${selectedMaterijal.naziv} (${selectedMaterijal.jedinicaMjere || 'kom'})` 
                                : '-- Odaberi materijal --'}
                        </span>
                        <span className="text-gray-400 text-xs ml-1">‚ñº</span>
                    </div>
                    
                    {isOpen && (
                        <div 
                            className="bg-white border rounded-lg shadow-xl max-h-72 overflow-hidden"
                            style={dropdownStyle}
                        >
                            <div className="p-2 border-b sticky top-0 bg-white">
                                <input
                                    type="text"
                                    placeholder="üîç Pretra≈æi materijale..."
                                    value={search}
                                    onChange={(e) => setSearch(e.target.value)}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    autoFocus
                                    onClick={(e) => e.stopPropagation()}
                                />
                            </div>
                            <div className="overflow-y-auto max-h-56">
                                {filtered.length === 0 ? (
                                    <div className="px-3 py-3 text-gray-500 text-sm text-center">
                                        {matList.length === 0 ? 'Nema materijala u bazi - dodaj ih u tab Materijali' : 'Nema rezultata'}
                                    </div>
                                ) : (
                                    filtered.map(m => (
                                        <div
                                            key={m.id}
                                            className={`px-3 py-2 cursor-pointer hover:bg-primary-50 text-sm border-b border-gray-100 ${value && String(m.id) === String(value) ? 'bg-primary-100' : ''}`}
                                            onClick={() => handleSelect(m)}
                                        >
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <div className="font-medium text-gray-900">{m.naziv}</div>
                                                    {m.kategorija && <div className="text-xs text-gray-500">{m.kategorija}</div>}
                                                </div>
                                                <div className="text-right text-xs">
                                                    <div className="text-gray-600">{m.jedinicaMjere || 'kom'}</div>
                                                    <div className={`font-medium ${parseFloat(m.zaliha || 0) <= parseFloat(m.minZaliha || 0) ? 'text-red-600' : 'text-green-600'}`}>
                                                        {parseFloat(m.zaliha || 0).toFixed(2)}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                                {filtered.length === 30 && (
                                    <div className="px-2 py-1 text-gray-400 text-xs text-center border-t bg-gray-50">
                                        Upi≈°i vi≈°e slova za preciznije rezultate
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Komponenta za prikaz postupaka s checkboxovima, koliƒçinom i cijenom
        function PostupciChecklist({ postupci, nalogId, userId, onUpdate, korisnici = [], isAdmin = false }) {
            const [loading, setLoading] = useState({});
            const [selectedUser, setSelectedUser] = useState({});
            
            const togglePostupak = async (postupakId, forceZavrsen = null, zavrsenBy = null) => {
                if (loading[postupakId]) return;
                
                setLoading(prev => ({ ...prev, [postupakId]: true }));
                
                try {
                    const payload = {};
                    if (forceZavrsen !== null) payload.zavrsen = forceZavrsen;
                    if (zavrsenBy) payload.zavrsenBy = zavrsenBy;
                    
                    const result = await apiCall(`nalog-postupci/${postupakId}`, 'PUT', payload, userId);
                    if (result.success && onUpdate) {
                        onUpdate(postupakId, result.postupak);
                    }
                } catch (error) {
                    console.error('Gre≈°ka pri a≈æuriranju postupka:', error);
                    alert('Gre≈°ka pri a≈æuriranju postupka');
                } finally {
                    setLoading(prev => ({ ...prev, [postupakId]: false }));
                    setSelectedUser(prev => ({ ...prev, [postupakId]: null }));
                }
            };
            
            const handleUserSelect = (postupakId, korisnikId) => {
                setSelectedUser(prev => ({ ...prev, [postupakId]: korisnikId }));
            };
            
            const oznacZaDrugog = (postupakId) => {
                const korisnikId = selectedUser[postupakId];
                if (korisnikId) {
                    togglePostupak(postupakId, true, korisnikId);
                }
            };
            
            if (!postupci || postupci.length === 0) return null;
            
            const zavrseno = postupci.filter(p => p.zavrsen).length;
            const ukupnoPostupaka = postupci.length;
            const postotak = ukupnoPostupaka > 0 ? Math.round((zavrseno / ukupnoPostupaka) * 100) : 0;
            
            // Izraƒçunaj ukupnu vrijednost postupaka
            const ukupnaVrijednost = postupci.reduce((sum, p) => {
                const kol = parseFloat(p.kolicina) || 1;
                const cij = parseFloat(p.cijena) || 0;
                return sum + (kol * cij);
            }, 0);
            
            return (
                <div className="space-y-3">
                    {/* Progress bar */}
                    <div className="flex items-center gap-3">
                        <div className="flex-1 bg-gray-200 rounded-full h-3">
                            <div 
                                className={`h-3 rounded-full transition-all duration-300 ${
                                    postotak === 100 ? 'bg-green-500' : 'bg-primary-500'
                                }`}
                                style={{ width: `${postotak}%` }}
                            />
                        </div>
                        <span className={`text-sm font-medium ${postotak === 100 ? 'text-green-600' : 'text-gray-600'}`}>
                            {zavrseno}/{ukupnoPostupaka} ({postotak}%)
                        </span>
                    </div>
                    
                    {/* Postupci lista */}
                    <div className="space-y-2">
                        {postupci.map((p, idx) => {
                            const kolicina = parseFloat(p.kolicina) || 1;
                            const cijena = parseFloat(p.cijena) || 0;
                            const ukupno = kolicina * cijena;
                            
                            return (
                                <div 
                                    key={p.id || idx}
                                    className={`p-3 rounded-lg border transition-all ${
                                        p.zavrsen 
                                            ? 'bg-green-50 border-green-200' 
                                            : 'bg-white border-gray-200 hover:border-blue-300'
                                    }`}
                                >
                                    <div className="flex items-start gap-3">
                                        <button
                                            onClick={() => p.id && togglePostupak(p.id)}
                                            disabled={loading[p.id] || !p.id}
                                            className={`w-6 h-6 rounded border-2 flex items-center justify-center transition-all flex-shrink-0 mt-0.5 ${
                                                p.zavrsen 
                                                    ? 'bg-green-500 border-green-500 text-white' 
                                                    : 'border-gray-300 hover:border-primary-500'
                                            } ${loading[p.id] ? 'opacity-50' : ''}`}
                                        >
                                            {loading[p.id] ? (
                                                <span className="animate-spin text-xs">‚è≥</span>
                                            ) : p.zavrsen ? (
                                                <span className="text-sm">‚úì</span>
                                            ) : null}
                                        </button>
                                        
                                        <div className="flex-1 min-w-0">
                                            <div className="flex items-center justify-between gap-2">
                                                <span className={`font-medium ${p.zavrsen ? 'text-green-700 line-through' : 'text-gray-800'}`}>
                                                    {idx + 1}. {p.naziv}
                                                </span>
                                                {ukupno > 0 && (
                                                    <span className={`text-sm font-semibold ${p.zavrsen ? 'text-green-600' : 'text-primary-600'}`}>
                                                        {ukupno.toFixed(2)} EUR
                                                    </span>
                                                )}
                                            </div>
                                            
                                            {/* Detalji: koliƒçina, cijena, vrijeme */}
                                            {(cijena > 0 || p.trajanjeMin) && (
                                                <div className="text-xs text-gray-500 mt-1 flex gap-3">
                                                    {kolicina !== 1 && <span>Kol: {kolicina}</span>}
                                                    {cijena > 0 && <span>√ó {cijena.toFixed(2)} EUR</span>}
                                                    {p.trajanjeMin && <span>‚è± {p.trajanjeMin} min</span>}
                                                </div>
                                            )}
                                            
                                            {/* Tko je zavr≈°io */}
                                            {p.zavrsen && p.zavrsenByIme && (
                                                <div className="text-xs text-green-600 mt-1">
                                                    ‚úì {p.zavrsenByIme} ‚Ä¢ {p.zavrsenAt ? new Date(p.zavrsenAt).toLocaleString('hr-HR') : ''}
                                                </div>
                                            )}
                                            
                                            {/* Admin: oznaƒçi za drugog korisnika */}
                                            {isAdmin && !p.zavrsen && korisnici.length > 0 && (
                                                <div className="mt-2 flex items-center gap-2">
                                                    <select
                                                        value={selectedUser[p.id] || ''}
                                                        onChange={(e) => handleUserSelect(p.id, e.target.value)}
                                                        className="text-xs border rounded px-2 py-1"
                                                    >
                                                        <option value="">Oznaƒçi za...</option>
                                                        {korisnici.map(k => (
                                                            <option key={k.id} value={k.id}>
                                                                {k.ime} {k.prezime}
                                                            </option>
                                                        ))}
                                                    </select>
                                                    {selectedUser[p.id] && (
                                                        <button
                                                            onClick={() => oznacZaDrugog(p.id)}
                                                            disabled={loading[p.id]}
                                                            className="text-xs bg-primary-500 text-white px-2 py-1 rounded hover:bg-primary-600"
                                                        >
                                                            Oznaƒçi
                                                        </button>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    
                    {/* Ukupna vrijednost postupaka */}
                    {ukupnaVrijednost > 0 && (
                        <div className="text-right text-sm font-semibold text-gray-700 pt-2 border-t">
                            Ukupno postupci: {ukupnaVrijednost.toFixed(2)} EUR
                        </div>
                    )}
                </div>
            );
        }

        // !!! PROMIJEN OVO SA SVOJOM DOMENOM !!!
        const API_URL = '/radni_novo/api-radni-nalozi.php';
        
        // API funkcija
        const apiCall = async (endpoint, method = 'GET', data = null, userId = null) => {
            const headers = { 'Content-Type': 'application/json' };
            if (userId) headers['X-User-Id'] = userId;
            
            const options = { method, headers };
            if (data && (method === 'POST' || method === 'PUT')) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`${API_URL}/${endpoint}`, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        };

        // Helper funkcije
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}.${month}.${year}`;
        };

        const parseDate = (dateString) => {
            if (!dateString) return '';
            const [day, month, year] = dateString.split('.');
            return `${year}-${month}-${day}`;
        };

        const getNextNalogBroj = (existingNalozi) => {
            if (existingNalozi.length === 0) return 'RN-1';
            const brojevi = existingNalozi
                .map(n => {
                    const match = n.broj.match(/RN-(\d+)/);
                    return match ? parseInt(match[1]) : 0;
                })
                .filter(num => num > 0);
            const maxBroj = brojevi.length > 0 ? Math.max(...brojevi) : 0;
            return `RN-${maxBroj + 1}`;
        };

        const getUkupnaCijena = (nalog) => {
            if (!nalog.artikli || nalog.artikli.length === 0) return 0;
            return nalog.artikli.reduce((sum, a) => {
                const kolicina = parseFloat(a.kolicina) || 0;
                const cijena = parseFloat(a.cijena) || 0;
                return sum + (kolicina * cijena);
            }, 0);
        };

        // Login komponenta
        function LoginForm({ setCurrentUser }) {
            const [korisnickoIme, setKorisnickoIme] = useState('');
            const [lozinka, setLozinka] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                
                try {
                    console.log('üîê Poku≈°aj prijave za:', korisnickoIme);
                    
                    const response = await apiCall('login', 'POST', { korisnickoIme, lozinka });
                    
                    console.log('üì• Login odgovor:', response);
                    
                    if (response && response.id) {
                        // VA≈ΩNO: Konvertuj u string
                        const userIdString = String(response.id);
                        
                        localStorage.setItem('userId', userIdString);
                        localStorage.setItem('currentUser', JSON.stringify(response));
                        
                        console.log('‚úÖ Spremljeno! userId:', userIdString);
                        
                        // Pozovi callback koji ƒáe uƒçitati podatke
                        setCurrentUser(response);
                    } else {
                        console.error('‚ùå Login neuspje≈°an - nema ID');
                        setError('Pogre≈°no korisniƒçko ime ili lozinka');
                    }
                } catch (error) {
                    console.error('‚ùå Gre≈°ka:', error);
                    setError('Gre≈°ka pri prijavi: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-primary-600 to-header flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-primary-600 rounded-xl mx-auto mb-4 flex items-center justify-center">
                                <span className="text-3xl">üìã</span>
                            </div>
                            <h1 className="text-2xl font-bold text-gray-800 mb-1">Radni Nalozi</h1>
                            <p className="text-gray-500 text-sm">Prijavite se u sustav</p>
                        </div>
                        
                        <form onSubmit={handleLogin} className="space-y-5">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">Korisniƒçko ime</label>
                                <input
                                    type="text"
                                    value={korisnickoIme}
                                    onChange={(e) => setKorisnickoIme(e.target.value)}
                                    className="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none"
                                    required
                                    autoFocus
                                    disabled={loading}
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">Lozinka</label>
                                <input
                                    type="password"
                                    value={lozinka}
                                    onChange={(e) => setLozinka(e.target.value)}
                                    className="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none"
                                    required
                                    disabled={loading}
                                />
                            </div>

                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                                    {error}
                                </div>
                            )}

                            <button
                                type="submit"
                                className="w-full bg-primary-600 text-white py-3 rounded-lg hover:bg-primary-700 transition-colors font-semibold disabled:opacity-50"
                                disabled={loading}
                            >
                                {loading ? 'Prijava u tijeku...' : 'Prijava'}
                            </button>
                        </form>

                        <div className="mt-6 pt-6 border-t border-gray-200">
                            <p className="text-xs text-gray-500 text-center">
                                Zadani pristup: admin / admin123
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        // App komponenta
        function App() {
            const [activeTab, setActiveTab] = useState('radni-nalozi');
            const [currentUser, setCurrentUser] = useState(null);
            const [loading, setLoading] = useState(true);
            
            const [korisnici, setKorisnici] = useState([]);
            const [kupci, setKupci] = useState([]);
            const [artikli, setArtikli] = useState([]);
            const [postupci, setPostupci] = useState([]);
            const [materijali, setMaterijali] = useState([]);
            const [radniNalozi, setRadniNalozi] = useState([]);
            const [podsjetnici, setPodsjetnici] = useState([]);

            // Funkcija za osvje≈æavanje radnih naloga
            const refreshRadniNalozi = async () => {
                if (!userId) return;
                try {
                    const [naloziData, kupciData] = await Promise.all([
                        apiCall('nalozi', 'GET', null, userId),
                        apiCall('kupci', 'GET', null, userId)
                    ]);
                    const naloziSaKontaktima = naloziData.map(nalog => {
                        const klijent = kupciData.find(k => k.id == nalog.klijentId);
                        return {
                            ...nalog,
                            kontaktOsoba: klijent?.kontakt || nalog.kontaktOsoba || '',
                            telefon: klijent?.telefon || nalog.telefon || '',
                            email: klijent?.email || nalog.email || ''
                        };
                    });
                    setRadniNalozi(naloziSaKontaktima);
                    setKupci(kupciData);
                } catch (error) {
                    console.error('Gre≈°ka pri osvje≈æavanju naloga:', error);
                }
            };

            // Osvje≈æi naloge kad se prebaci na tab radni-nalozi
            useEffect(() => {
                if (activeTab === 'radni-nalozi' && userId) {
                    refreshRadniNalozi();
                }
            }, [activeTab]);

            const loadData = async (userId) => {
                if (!userId) {
                    console.error('‚ùå userId nedostaje!');
                    return;
                }
                
                console.log('üìä Uƒçitavam podatke sa userId:', userId);
                
                setLoading(true);
                try {
                    const [korisniciData, kupciData, artikliData, postupciData, materijaliData, naloziData, podsjetniciData] = await Promise.all([
                        apiCall('korisnici', 'GET', null, userId).catch(err => { console.error('Korisnici gre≈°ka:', err); return []; }),
                        apiCall('kupci', 'GET', null, userId).catch(err => { console.error('Klijenti gre≈°ka:', err); return []; }),
                        apiCall('artikli', 'GET', null, userId).catch(err => { console.error('Artikli gre≈°ka:', err); return []; }),
                        apiCall('postupci', 'GET', null, userId).catch(err => { console.error('Postupci gre≈°ka:', err); return []; }),
                        apiCall('materijali', 'GET', null, userId).catch(err => { console.error('Materijali gre≈°ka:', err); return []; }),
                        apiCall('nalozi', 'GET', null, userId).catch(err => { console.error('Nalozi gre≈°ka:', err); return []; }),
                        apiCall('podsjetnici', 'GET', null, userId).catch(err => { console.error('Podsjetnici gre≈°ka:', err); return []; })
                    ]);
                    
                    console.log('‚úÖ Podaci uƒçitani:', {
                        korisnici: korisniciData.length,
                        kupci: kupciData.length,
                        artikli: artikliData.length,
                        postupci: postupciData.length,
                        materijali: materijaliData.length,
                        nalozi: naloziData.length,
                        podsjetnici: podsjetniciData.length
                    });
                    
                    // Obogati naloge sa kontakt podacima iz klijenata
                    const naloziSaKontaktima = naloziData.map(nalog => {
                        const klijent = kupciData.find(k => k.id == nalog.klijentId);
                        return {
                            ...nalog,
                            kontaktOsoba: klijent?.kontakt || nalog.kontaktOsoba || '',
                            telefon: klijent?.telefon || nalog.telefon || '',
                            email: klijent?.email || nalog.email || ''
                        };
                    });
                    
                    setKorisnici(korisniciData);
                    setKupci(kupciData);
                    console.log('üî• POSTAVLJAM ARTIKLE:', artikliData.slice(0, 2));
                    setArtikli(artikliData);
                    setPostupci(postupciData);
                    setMaterijali(materijaliData);
                    setRadniNalozi(naloziSaKontaktima);
                    setPodsjetnici(podsjetniciData);
                } catch (error) {
                    console.error('‚ùå Gre≈°ka pri uƒçitavanju:', error);
                    alert('Gre≈°ka pri uƒçitavanju. Provjerite server.');
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                const storedUserId = localStorage.getItem('userId');
                const storedUser = localStorage.getItem('currentUser');
                
                console.log('üöÄ Inicijalizacija - userId:', storedUserId);
                
                if (storedUser && storedUserId) {
                    try {
                        const user = JSON.parse(storedUser);
                        console.log('üë§ Korisnik pronaƒëen:', user.ime);
                        setCurrentUser(user);
                        loadData(storedUserId);
                    } catch (e) {
                        console.error('‚ùå Error parsing user:', e);
                        localStorage.clear();
                        setLoading(false);
                    }
                } else {
                    console.log('‚ö†Ô∏è Nema spremljenog korisnika');
                    setLoading(false);
                }
            }, []);

            const tabs = [
                { id: 'radni-nalozi', naziv: 'Radni Nalozi', icon: 'üìã' },
                { id: 'zavrseni-nalozi', naziv: 'Zavr≈°eni nalozi', icon: '‚úÖ' },
                { id: 'kupci', naziv: 'Kupci', icon: 'üë•' },
                { id: 'artikli', naziv: 'Artikli', icon: 'üì¶' },
                { id: 'postupci', naziv: 'Postupci', icon: '‚öôÔ∏è' },
                { id: 'materijali', naziv: 'Materijali', icon: 'üß±' },
                { id: 'izvjestaji', naziv: 'Izvje≈°taji', icon: 'üìä' },
                ...(currentUser?.uloga === 'admin' ? [
                    { id: 'podsjetnici', naziv: 'Podsjetnici', icon: 'üìå' },
                    { id: 'korisnici', naziv: 'Korisnici', icon: 'üîê' }
                ] : [])
            ];

            const handleLogout = () => {
                setCurrentUser(null);
                localStorage.clear();
                setKorisnici([]);
                setKupci([]);
                setArtikli([]);
                setPostupci([]);
                setMaterijali([]);
                setRadniNalozi([]);
            };
            
            const handleTabChange = async (tabId) => {
                setActiveTab(tabId);
                // Osvje≈æi materijale kad se otvori tab
                if (tabId === 'materijali' && currentUser) {
                    try {
                        const freshMaterijali = await apiCall('materijali', 'GET', null, String(currentUser.id));
                        setMaterijali(freshMaterijali);
                    } catch (error) {
                        console.error('Gre≈°ka pri osvje≈æavanju materijala:', error);
                    }
                }
                // Osvje≈æi podsjetnike kad se otvori tab
                if (tabId === 'podsjetnici' && currentUser) {
                    try {
                        const freshPodsjetnici = await apiCall('podsjetnici', 'GET', null, String(currentUser.id));
                        setPodsjetnici(freshPodsjetnici);
                    } catch (error) {
                        console.error('Gre≈°ka pri osvje≈æavanju podsjetnika:', error);
                    }
                }
            };
            
            const handleLoginSuccess = (user) => {
                setCurrentUser(user);
                const userIdString = String(user.id);
                loadData(userIdString);
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-4xl mb-4">‚è≥</div>
                            <div className="text-xl text-gray-600">Uƒçitavanje...</div>
                        </div>
                    </div>
                );
            }

            if (!currentUser) {
                return <LoginForm setCurrentUser={handleLoginSuccess} />;
            }

            const userId = localStorage.getItem('userId') || String(currentUser.id);

            return (
                <div className="min-h-screen">
                    <header className="bg-header text-white p-4 shadow-lg">
                        <div className="container mx-auto flex justify-between items-center">
                            <h1 className="text-xl font-semibold tracking-wide">Radni Nalozi</h1>
                            <div className="flex items-center gap-4">
                                <div className="text-right">
                                    <div className="font-medium">{currentUser.ime} {currentUser.prezime || ''}</div>
                                    <div className="text-xs text-primary-200">{currentUser.uloga === 'admin' ? 'Administrator' : 'Korisnik'}</div>
                                </div>
                                <button
                                    onClick={handleLogout}
                                    className="bg-white/10 hover:bg-white/20 px-4 py-2 rounded text-sm font-medium"
                                >
                                    Odjava
                                </button>
                            </div>
                        </div>
                    </header>

                    <nav className="bg-white border-b sticky top-0 z-10">
                        <div className="container mx-auto px-4">
                            <div className="flex space-x-1 overflow-x-auto">
                                {tabs.map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => handleTabChange(tab.id)}
                                        className={`px-5 py-3 font-medium whitespace-nowrap text-sm transition-colors ${
                                            activeTab === tab.id
                                                ? 'border-b-2 border-primary-600 text-primary-700 bg-primary-50'
                                                : 'text-gray-600 hover:text-primary-600 hover:bg-gray-50'
                                        }`}
                                    >
                                        <span className="mr-2">{tab.icon}</span>
                                        {tab.naziv}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    <main className="container mx-auto p-4">
                        {activeTab === 'radni-nalozi' && (
                            <RadniNaloziTab 
                                radniNalozi={radniNalozi}
                                setRadniNalozi={setRadniNalozi}
                                kupci={kupci}
                                artikli={artikli}
                                postupci={postupci}
                                materijali={materijali}
                                setMaterijali={setMaterijali}
                                userId={userId}
                                isAdmin={currentUser?.uloga === 'admin'}
                            />
                        )}
                        {activeTab === 'zavrseni-nalozi' && (
                            <ZavrseniNaloziTab 
                                radniNalozi={radniNalozi}
                                setRadniNalozi={setRadniNalozi}
                                kupci={kupci}
                                artikli={artikli}
                                postupci={postupci}
                                materijali={materijali}
                                userId={userId}
                            />
                        )}
                        {activeTab === 'kupci' && (
                            <KupciTab 
                                kupci={kupci} 
                                setKupci={setKupci}
                                userId={userId}
                            />
                        )}
                        {activeTab === 'artikli' && (
                            <ArtikliTab 
                                artikli={artikli} 
                                setArtikli={setArtikli}
                                postupci={postupci}
                                materijali={materijali}
                                userId={userId}
                            />
                        )}
                        {activeTab === 'postupci' && (
                            <PostupciTab 
                                postupci={postupci} 
                                setPostupci={setPostupci}
                                userId={userId}
                            />
                        )}
                        {activeTab === 'materijali' && (
                            <MaterijaliTab 
                                materijali={materijali} 
                                setMaterijali={setMaterijali}
                                userId={userId}
                            />
                        )}
                        {activeTab === 'podsjetnici' && (
                            <PodsjetniciTab 
                                podsjetnici={podsjetnici} 
                                setPodsjetnici={setPodsjetnici}
                                radniNalozi={radniNalozi}
                                userId={userId}
                                isAdmin={currentUser?.uloga === 'admin'}
                            />
                        )}
                        {activeTab === 'izvjestaji' && (
                            <IzvjestajiTab 
                                radniNalozi={radniNalozi}
                                kupci={kupci}
                                artikli={artikli}
                                postupci={postupci}
                            />
                        )}
                        {activeTab === 'korisnici' && currentUser?.uloga === 'admin' && (
                            <KorisniciTab 
                                korisnici={korisnici} 
                                setKorisnici={setKorisnici} 
                                currentUser={currentUser}
                                userId={userId}
                            />
                        )}
                    </main>
                </div>
            );
        }

        // PodsjetniciTab komponenta
        function PodsjetniciTab({ podsjetnici, setPodsjetnici, radniNalozi, userId, isAdmin }) {
            const [showForm, setShowForm] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [saving, setSaving] = useState(false);
            const [selectedNalogId, setSelectedNalogId] = useState('');
            const [selectedArtiklId, setSelectedArtiklId] = useState('');
            const [formData, setFormData] = useState({
                tekst: '',
                prioritet: 'srednji',
                rok: ''
            });

            // Filtriraj samo aktivne naloge (u tijeku)
            const aktivniNalozi = radniNalozi.filter(n => n.status !== 'zavrsen');
            
            // Dohvati artikle za odabrani nalog
            const artikliZaNalog = selectedNalogId 
                ? (aktivniNalozi.find(n => String(n.id) === selectedNalogId)?.artikli || [])
                : [];

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.tekst.trim()) return;
                if (!editingId && !selectedNalogId) {
                    alert('Odaberite nalog');
                    return;
                }
                if (!editingId && !selectedArtiklId) {
                    alert('Odaberite artikl');
                    return;
                }
                
                // Provjeri da nalog ima klijenta
                if (!editingId) {
                    const nalog = aktivniNalozi.find(n => String(n.id) === selectedNalogId);
                    if (!nalog?.klijentNaziv) {
                        alert('Nalog nema odabranog klijenta');
                        return;
                    }
                }
                
                setSaving(true);
                try {
                    if (editingId) {
                        await apiCall(`podsjetnici/${editingId}`, 'PUT', formData, userId);
                        setPodsjetnici(podsjetnici.map(p => 
                            p.id === editingId ? { ...p, ...formData } : p
                        ));
                    } else {
                        const nalog = aktivniNalozi.find(n => String(n.id) === selectedNalogId);
                        const artikl = selectedArtiklId ? artikliZaNalog.find(a => String(a.id) === selectedArtiklId) : null;
                        
                        const result = await apiCall('podsjetnici', 'POST', {
                            ...formData,
                            nalogId: selectedNalogId,
                            nalogArtiklId: selectedArtiklId || null
                        }, userId);
                        
                        const newPodsjetnik = { 
                            id: result.id, 
                            ...formData,
                            nalogId: parseInt(selectedNalogId),
                            nalogArtiklId: selectedArtiklId ? parseInt(selectedArtiklId) : null,
                            nalogBroj: nalog?.broj,
                            nalogNaziv: nalog?.nazivNaloga,
                            artiklNaziv: artikl?.naziv,
                            klijentNaziv: nalog?.klijentNaziv,
                            zavrsen: false,
                            createdAt: new Date().toISOString()
                        };
                        setPodsjetnici([newPodsjetnik, ...podsjetnici]);
                    }
                    resetForm();
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                } finally {
                    setSaving(false);
                }
            };

            const toggleZavrsen = async (podsjetnik) => {
                try {
                    await apiCall(`podsjetnici/${podsjetnik.id}`, 'PUT', { zavrsen: !podsjetnik.zavrsen }, userId);
                    setPodsjetnici(podsjetnici.map(p => 
                        p.id === podsjetnik.id ? { 
                            ...p, 
                            zavrsen: !p.zavrsen,
                            zavrsenAt: !p.zavrsen ? new Date().toISOString() : null
                        } : p
                    ));
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleDelete = async (id) => {
                try {
                    await apiCall(`podsjetnici/${id}`, 'DELETE', null, userId);
                    // DELETE sada oznaƒçava kao zavr≈°en (soft delete)
                    setPodsjetnici(podsjetnici.map(p => 
                        p.id === id ? { 
                            ...p, 
                            zavrsen: true,
                            zavrsenAt: new Date().toISOString()
                        } : p
                    ));
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleHardDelete = async (id) => {
                if (!confirm('Trajno obrisati ovaj podsjetnik?')) return;
                try {
                    await apiCall(`podsjetnici/${id}?hard=1`, 'DELETE', null, userId);
                    setPodsjetnici(podsjetnici.filter(p => p.id !== id));
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleEdit = (p) => {
                setFormData({
                    tekst: p.tekst || '',
                    prioritet: p.prioritet || 'srednji',
                    rok: p.rok || ''
                });
                setEditingId(p.id);
                setShowForm(true);
            };

            const resetForm = () => {
                setFormData({ tekst: '', prioritet: 'srednji', rok: '' });
                setSelectedNalogId('');
                setSelectedArtiklId('');
                setEditingId(null);
                setShowForm(false);
            };

            const aktivniBroj = podsjetnici.filter(p => !p.zavrsen).length;

            const getPrioritetBadge = (prioritet) => {
                switch(prioritet) {
                    case 'visok': return <span className="px-2 py-0.5 text-xs rounded bg-red-100 text-red-700 font-medium">‚ö° HITNO</span>;
                    case 'nizak': return <span className="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-500 font-medium">mo≈æe ƒçekati</span>;
                    default: return null; // srednji ne prikazuje badge
                }
            };

            const isKasni = (rok) => {
                if (!rok) return false;
                const rokDate = new Date(rok);
                const danas = new Date();
                rokDate.setHours(0,0,0,0);
                danas.setHours(0,0,0,0);
                return danas > rokDate;
            };

            return (
                <div className="space-y-4">
                    {/* Header */}
                    <div className="flex justify-between items-center">
                        <h2 className="text-xl font-semibold text-gray-800">üìå Podsjetnici ({aktivniBroj} aktivnih)</h2>
                        <button
                            onClick={() => setShowForm(true)}
                            className="bg-primary-600 text-white px-4 py-2 rounded hover:bg-primary-700 text-sm font-medium"
                        >
                            + Novi podsjetnik
                        </button>
                    </div>

                    {/* Forma */}
                    {showForm && (
                        <div className="bg-white rounded-lg shadow-sm border p-4">
                            <h3 className="text-lg font-semibold mb-3">{editingId ? 'Uredi podsjetnik' : 'Novi podsjetnik'}</h3>
                            <form onSubmit={handleSubmit} className="space-y-3">
                                {!editingId && (
                                    <>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Nalog *</label>
                                            <select
                                                value={selectedNalogId}
                                                onChange={(e) => {
                                                    setSelectedNalogId(e.target.value);
                                                    setSelectedArtiklId('');
                                                }}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                                disabled={saving}
                                            >
                                                <option value="">-- Odaberi nalog --</option>
                                                {aktivniNalozi.map(n => (
                                                    <option key={n.id} value={n.id}>
                                                        {n.broj} - {n.nazivNaloga || n.klijentNaziv}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Artikl *</label>
                                            <select
                                                value={selectedArtiklId}
                                                onChange={(e) => setSelectedArtiklId(e.target.value)}
                                                className="w-full border rounded px-3 py-2"
                                                disabled={saving || !selectedNalogId}
                                                required
                                            >
                                                <option value="">-- Odaberi artikl --</option>
                                                {artikliZaNalog.map((a, idx) => (
                                                    <option key={a.id || idx} value={a.id}>
                                                        {a.naziv} ({a.kolicina} {a.jedinica || 'kom'})
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                    {selectedNalogId && (() => {
                                        const nalog = aktivniNalozi.find(n => String(n.id) === selectedNalogId);
                                        return nalog?.klijentNaziv ? (
                                            <div className="text-sm bg-blue-50 border border-blue-200 rounded px-3 py-2">
                                                <span className="text-blue-700 font-medium">üë• Klijent:</span> {nalog.klijentNaziv}
                                            </div>
                                        ) : null;
                                    })()}
                                    </>
                                )}
                                <div>
                                    <label className="block text-sm font-medium mb-1">Opis zadatka *</label>
                                    <textarea
                                        value={formData.tekst}
                                        onChange={(e) => setFormData({ ...formData, tekst: e.target.value })}
                                        className="w-full border rounded px-3 py-2"
                                        rows="2"
                                        placeholder="≈†to treba napraviti..."
                                        required
                                        disabled={saving}
                                    />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Prioritet</label>
                                        <select
                                            value={formData.prioritet}
                                            onChange={(e) => setFormData({ ...formData, prioritet: e.target.value })}
                                            className="w-full border rounded px-3 py-2"
                                            disabled={saving}
                                        >
                                            <option value="srednji">Normalno</option>
                                            <option value="visok">‚ö° HITNO</option>
                                            <option value="nizak">Mo≈æe ƒçekati</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Rok (opcionalno)</label>
                                        <input
                                            type="date"
                                            value={formData.rok}
                                            onChange={(e) => setFormData({ ...formData, rok: e.target.value })}
                                            className="w-full border rounded px-3 py-2"
                                            disabled={saving}
                                        />
                                    </div>
                                </div>
                                <div className="flex justify-end space-x-2">
                                    <button
                                        type="button"
                                        onClick={resetForm}
                                        className="px-4 py-2 border rounded hover:bg-gray-100"
                                        disabled={saving}
                                    >
                                        Odustani
                                    </button>
                                    <button
                                        type="submit"
                                        className="px-4 py-2 bg-primary-600 text-white rounded hover:bg-primary-700"
                                        disabled={saving}
                                    >
                                        {saving ? 'Spremanje...' : 'Spremi'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    {/* Svi podsjetnici */}
                    <div className="bg-white rounded-lg shadow">
                        {podsjetnici.length === 0 ? (
                            <div className="p-8 text-center text-gray-400">
                                <div className="text-4xl mb-2">‚úÖ</div>
                                <p>Nema podsjetnika</p>
                            </div>
                        ) : (
                            <div className="divide-y">
                                {[...podsjetnici].sort((a, b) => {
                                    // Aktivni na vrhu, zavr≈°eni dolje
                                    if (a.zavrsen !== b.zavrsen) return a.zavrsen ? 1 : -1;
                                    // Meƒëu aktivnima - visok prioritet na vrhu
                                    if (!a.zavrsen && !b.zavrsen) {
                                        const prioritetOrder = { visok: 0, srednji: 1, nizak: 2 };
                                        return (prioritetOrder[a.prioritet] || 1) - (prioritetOrder[b.prioritet] || 1);
                                    }
                                    return 0;
                                }).map(p => (
                                    <div key={p.id} className={`p-4 flex items-start gap-3 hover:bg-gray-50 ${p.zavrsen ? 'bg-gray-50' : isKasni(p.rok) ? 'bg-red-50' : ''}`}>
                                        {p.zavrsen ? (
                                            <button
                                                onClick={() => toggleZavrsen(p)}
                                                className="mt-1 w-6 h-6 rounded-full bg-green-500 text-white flex items-center justify-center text-sm hover:bg-green-600"
                                                title="Vrati na aktivne"
                                            >
                                                ‚úì
                                            </button>
                                        ) : (
                                            <button
                                                onClick={() => handleDelete(p.id)}
                                                className="mt-1 w-6 h-6 rounded-full border-2 border-gray-300 hover:border-green-500 hover:bg-green-50 flex items-center justify-center text-transparent hover:text-green-500 transition-colors"
                                                title="Oznaƒçi kao zavr≈°eno"
                                            >
                                                ‚úì
                                            </button>
                                        )}
                                        <div className="flex-1">
                                            {/* Nalog/Artikl info */}
                                            <div className="flex items-center gap-2 mb-1 flex-wrap">
                                                <span className={`px-2 py-0.5 text-xs rounded ${p.zavrsen ? 'bg-gray-100 text-gray-500' : 'bg-primary-100 text-primary-700'} font-medium`}>
                                                    üìã {p.nalogBroj} {p.nalogNaziv && `- ${p.nalogNaziv}`}
                                                </span>
                                                {p.klijentNaziv && (
                                                    <span className={`px-2 py-0.5 text-xs rounded ${p.zavrsen ? 'bg-gray-100 text-gray-500' : 'bg-blue-100 text-blue-700'} font-medium`}>
                                                        üë• {p.klijentNaziv}
                                                    </span>
                                                )}
                                                {p.artiklNaziv ? (
                                                    <span className={`px-2 py-0.5 text-xs rounded ${p.zavrsen ? 'bg-gray-100 text-gray-500' : 'bg-purple-100 text-purple-700'}`}>
                                                        üì¶ {p.artiklNaziv}
                                                    </span>
                                                ) : p.nalogArtiklId ? (
                                                    <span className="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-500 italic">
                                                        üì¶ artikl obrisan
                                                    </span>
                                                ) : (
                                                    <span className="text-xs text-gray-400 italic">cijeli nalog</span>
                                                )}
                                            </div>
                                            {!p.zavrsen && (
                                                <div className="flex items-center gap-2 mb-1">
                                                    {getPrioritetBadge(p.prioritet)}
                                                    {p.rok && (
                                                        <span className={`text-xs ${isKasni(p.rok) ? 'text-red-600 font-bold' : 'text-gray-500'}`}>
                                                            üìÖ {new Date(p.rok).toLocaleString('hr-HR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'})}
                                                            {isKasni(p.rok) && ' ‚ö†Ô∏è KASNI'}
                                                        </span>
                                                    )}
                                                </div>
                                            )}
                                            <p className={p.zavrsen ? 'text-gray-400 line-through' : 'text-gray-900'}>{p.tekst}</p>
                                            {p.zavrsen ? (
                                                <p className="text-xs text-gray-400 mt-1">
                                                    Zavr≈°io: {p.zavrsioIme || '?'} ‚Ä¢ {p.zavrsenAt ? new Date(p.zavrsenAt).toLocaleString('hr-HR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'}) : ''}
                                                </p>
                                            ) : p.kreiraoIme && (
                                                <p className="text-xs text-gray-400 mt-1">
                                                    Kreirao: {p.kreiraoIme} ‚Ä¢ {p.createdAt ? new Date(p.createdAt).toLocaleString('hr-HR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'}) : ''}
                                                </p>
                                            )}
                                        </div>
                                        <div className="flex gap-1">
                                            {!p.zavrsen && (
                                                <button
                                                    onClick={() => handleEdit(p)}
                                                    className="text-primary-600 hover:text-primary-800 px-2 py-1 text-sm"
                                                    title="Uredi"
                                                >
                                                    ‚úèÔ∏è
                                                </button>
                                            )}
                                            {isAdmin && (
                                                <button
                                                    onClick={() => handleHardDelete(p.id)}
                                                    className="text-red-400 hover:text-red-600 px-2 py-1 text-sm"
                                                    title="Trajno obri≈°i"
                                                >
                                                    üóëÔ∏è
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // IzvjestajiTab komponenta
        function IzvjestajiTab({ radniNalozi, kupci, artikli, postupci }) {
            const [datumOd, setDatumOd] = useState('');
            const [datumDo, setDatumDo] = useState('');
            const [filterStatus, setFilterStatus] = useState('svi');
            const [showIstekliRokovi, setShowIstekliRokovi] = useState(false);
            const [expandedRows, setExpandedRows] = useState([]);

            const getKupacNaziv = (id) => {
                const kupac = kupci.find(k => String(k.id) === String(id));
                return kupac ? kupac.naziv : 'N/A';
            };

            const toggleRow = (id) => {
                setExpandedRows(prev => 
                    prev.includes(id) 
                        ? prev.filter(rowId => rowId !== id)
                        : [...prev, id]
                );
            };

            // Filtriranje radnih naloga
            const filteredNalozi = radniNalozi.filter(nalog => {
                const datumMatch = (!datumOd || nalog.datum >= datumOd) && 
                                  (!datumDo || nalog.datum <= datumDo);
                const statusMatch = filterStatus === 'svi' || nalog.status === filterStatus;
                const istekliRokMatch = !showIstekliRokovi || 
                    (nalog.rokIzrade && 
                     new Date(nalog.rokIzrade) < new Date() && 
                     nalog.status !== 'zavrsen');
                return datumMatch && statusMatch && istekliRokMatch;
            });

            // Statistike
            const statistike = {
                ukupno: filteredNalozi.length,
                otvoren: filteredNalozi.filter(n => n.status === 'otvoren').length,
                u_tijeku: filteredNalozi.filter(n => n.status === 'u_tijeku').length,
                zavrsen: filteredNalozi.filter(n => n.status === 'zavrsen').length,
                istekliRokovi: filteredNalozi.filter(n => 
                    n.rokIzrade && 
                    new Date(n.rokIzrade) < new Date() && 
                    n.status !== 'zavrsen'
                ).length,
                ukupnaVrijednost: filteredNalozi.reduce((sum, n) => sum + getUkupnaCijena(n), 0)
            };

            const resetFilters = () => {
                setDatumOd('');
                setDatumDo('');
                setFilterStatus('svi');
                setShowIstekliRokovi(false);
            };

            const printReport = () => {
                window.print();
            };

            return (
                <div className="space-y-4">
                    <div className="flex justify-between items-center">
                        <h2 className="text-xl font-semibold text-gray-800">üìä Izvje≈°taji</h2>
                        <button
                            onClick={printReport}
                            className="no-print bg-primary-600 text-white px-4 py-2 rounded hover:bg-primary-700 flex items-center gap-2 text-sm font-medium"
                        >
                            üñ®Ô∏è Ispis
                        </button>
                    </div>

                    {/* Filteri */}
                    <div className="no-print bg-white rounded-lg shadow-sm border p-5">
                        <h3 className="text-sm font-semibold mb-4 text-gray-700 uppercase tracking-wide">Filteri</h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">Datum od</label>
                                <input
                                    type="date"
                                    value={datumOd}
                                    onChange={(e) => setDatumOd(e.target.value)}
                                    className="w-full border rounded px-3 py-2"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Datum do</label>
                                <input
                                    type="date"
                                    value={datumDo}
                                    onChange={(e) => setDatumDo(e.target.value)}
                                    className="w-full border rounded-lg px-3 py-2"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Status</label>
                                <select
                                    value={filterStatus}
                                    onChange={(e) => setFilterStatus(e.target.value)}
                                    className="w-full border rounded-lg px-3 py-2"
                                >
                                    <option value="svi">Svi statusi</option>
                                    <option value="u_tijeku">U tijeku</option>
                                    <option value="zavrsen">Zavr≈°en</option>
                                </select>
                            </div>
                        </div>
                        <div className="mt-4 flex items-center justify-between">
                            <label className="flex items-center cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={showIstekliRokovi}
                                    onChange={(e) => setShowIstekliRokovi(e.target.checked)}
                                    className="mr-2 w-4 h-4 text-red-600"
                                />
                                <span className="text-sm font-medium text-gray-700">
                                    Prika≈æi samo naloge s isteklim rokovima
                                </span>
                            </label>
                            <button
                                onClick={resetFilters}
                                className="text-primary-600 hover:text-primary-800 text-sm font-medium"
                            >
                                ‚Ü∫ Resetiraj filtere
                            </button>
                        </div>
                    </div>

                    {/* Statistike */}
                    <div className="grid grid-cols-1 md:grid-cols-6 gap-4">
                        <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg p-6 shadow-lg">
                            <div className="text-3xl font-bold mb-2">{statistike.ukupno}</div>
                            <div className="text-blue-100">Ukupno naloga</div>
                        </div>
                        <div className="bg-gradient-to-br from-gray-400 to-gray-500 text-white rounded-lg p-6 shadow-lg">
                            <div className="text-3xl font-bold mb-2">{statistike.otvoren}</div>
                            <div className="text-gray-100">Otvoreni</div>
                        </div>
                        <div className="bg-gradient-to-br from-yellow-400 to-yellow-500 text-white rounded-lg p-6 shadow-lg">
                            <div className="text-3xl font-bold mb-2">{statistike.u_tijeku}</div>
                            <div className="text-yellow-100">U tijeku</div>
                        </div>
                        <div className="bg-gradient-to-br from-green-400 to-green-500 text-white rounded-lg p-6 shadow-lg">
                            <div className="text-3xl font-bold mb-2">{statistike.zavrsen}</div>
                            <div className="text-green-100">Zavr≈°eni</div>
                        </div>
                        <div className="bg-gradient-to-br from-red-500 to-red-600 text-white rounded-lg p-6 shadow-lg">
                            <div className="text-3xl font-bold mb-2">{statistike.istekliRokovi}</div>
                            <div className="text-red-100">Istekli rokovi</div>
                        </div>
                        <div className="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg p-6 shadow-lg">
                            <div className="text-2xl font-bold mb-2">{statistike.ukupnaVrijednost.toFixed(2)} EUR</div>
                            <div className="text-purple-100">Ukupna vrijednost</div>
                        </div>
                    </div>

                    {/* Tablica naloga */}
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <div className="px-6 py-4 border-b bg-gray-50">
                            <h3 className="text-lg font-semibold">
                                Radni nalozi ({filteredNalozi.length})
                            </h3>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase w-8"></th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Broj</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Naziv naloga</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Datum</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Klijent</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Ukupna cijena</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredNalozi.length === 0 ? (
                                        <tr>
                                            <td colSpan="7" className="px-6 py-8 text-center text-gray-500">
                                                Nema naloga koji odgovaraju filterima
                                            </td>
                                        </tr>
                                    ) : (
                                        filteredNalozi.map(nalog => (
                                            <React.Fragment key={nalog.id}>
                                                <tr 
                                                    className="hover:bg-gray-50 cursor-pointer"
                                                    onClick={() => toggleRow(nalog.id)}
                                                >
                                                    <td className="px-6 py-4 text-center">
                                                        <span className="text-primary-600 font-bold text-lg">
                                                            {expandedRows.includes(nalog.id) ? '‚àí' : '+'}
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap font-medium">{nalog.broj}</td>
                                                    <td className="px-6 py-4">
                                                        <span className="text-gray-700 font-medium">
                                                            {nalog.nazivNaloga || '-'}
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap">{formatDate(nalog.datum)}</td>
                                                    <td className="px-6 py-4">{getKupacNaziv(nalog.klijentId)}</td>
                                                    <td className="px-6 py-4 text-right">
                                                        <span className="font-semibold text-gray-900">
                                                            {getUkupnaCijena(nalog).toFixed(2)} EUR
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap">
                                                        <span className={`px-2 py-1 rounded text-xs font-medium ${
                                                            nalog.status === 'otvoren' ? 'bg-gray-100 text-gray-800' :
                                                            nalog.status === 'u_tijeku' ? 'bg-yellow-100 text-yellow-800' :
                                                            'bg-green-100 text-green-800'
                                                        }`}>
                                                            {nalog.status === 'otvoren' ? 'Otvoren' :
                                                             nalog.status === 'u_tijeku' ? 'U tijeku' : 'Zavr≈°en'}
                                                        </span>
                                                    </td>
                                                </tr>
                                                {expandedRows.includes(nalog.id) && (
                                                    <>
                                                        {nalog.opisProblema && (
                                                            <tr className="bg-gray-50">
                                                                <td></td>
                                                                <td colSpan="6" className="px-6 py-3">
                                                                    <div className="text-sm">
                                                                        <span className="font-medium text-gray-700">Opis problema: </span>
                                                                        <span className="text-gray-600">{nalog.opisProblema}</span>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        )}
                                                        {nalog.artikli && nalog.artikli.length > 0 && (
                                                            <>
                                                                <tr className="bg-gray-50">
                                                                    <td></td>
                                                                    <td colSpan="6" className="px-6 py-2">
                                                                        <div className="text-sm font-semibold text-gray-700">Artikli:</div>
                                                                    </td>
                                                                </tr>
                                                                {nalog.artikli.map((artikl, idx) => (
                                                                    <tr key={idx} className="bg-gray-50 border-l-4 border-blue-300">
                                                                        <td></td>
                                                                        <td className="px-6 py-3 text-sm" colSpan="2">
                                                                            <div className="font-medium text-gray-900">
                                                                                {artikl.naziv}
                                                                            </div>
                                                                            {artikl.format && (
                                                                                <div className="text-xs text-gray-600 mt-0.5">
                                                                                    <span className="font-medium">Format:</span> {artikl.format}
                                                                                </div>
                                                                            )}
                                                                            {artikl.opis && (
                                                                                <div className="text-xs text-gray-600 mt-0.5">
                                                                                    <span className="font-medium">Opis:</span> {artikl.opis}
                                                                                </div>
                                                                            )}
                                                                        </td>
                                                                        <td className="px-6 py-3 text-sm" colSpan="4">
                                                                            <div>
                                                                                <span className="text-gray-600">Koliƒçina: {artikl.kolicina}</span>
                                                                                {artikl.cijena && (
                                                                                    <>
                                                                                        <span className="text-gray-600 ml-3">| Cijena: {parseFloat(artikl.cijena).toFixed(2)} EUR</span>
                                                                                        <span className="text-gray-900 font-semibold ml-3">| Ukupno: {(parseFloat(artikl.kolicina) * parseFloat(artikl.cijena)).toFixed(2)} EUR</span>
                                                                                    </>
                                                                                )}
                                                                            </div>
                                                                            {artikl.napomena && (
                                                                                <div className="mt-1 text-gray-600 italic text-xs">
                                                                                    <span className="font-medium">Napomena: </span>
                                                                                    {artikl.napomena}
                                                                                </div>
                                                                            )}
                                                                        </td>
                                                                    </tr>
                                                                ))}
                                                                <tr className="bg-primary-50 border-t-2 border-blue-300">
                                                                    <td></td>
                                                                    <td colSpan="6" className="px-6 py-3 text-right">
                                                                        <span className="font-bold text-gray-800 text-lg">
                                                                            UKUPNO: {getUkupnaCijena(nalog).toFixed(2)} EUR
                                                                        </span>
                                                                    </td>
                                                                </tr>
                                                            </>
                                                        )}
                                                        {nalog.postupci && nalog.postupci.length > 0 && (
                                                            <tr className="bg-gray-50">
                                                                <td></td>
                                                                <td colSpan="6" className="px-6 py-4">
                                                                    <div className="text-sm">
                                                                        <div className="font-medium text-gray-700 mb-2">Postupci:</div>
                                                                        <PostupciChecklist 
                                                                            postupci={nalog.postupci}
                                                                            nalogId={nalog.id}
                                                                            userId={userId}
                                                                            onUpdate={(postupakId, updatedPostupak) => {
                                                                                setRadniNalozi(prev => prev.map(n => {
                                                                                    if (n.id === nalog.id) {
                                                                                        return {
                                                                                            ...n,
                                                                                            postupci: n.postupci.map(p => 
                                                                                                p.id === postupakId 
                                                                                                    ? { ...p, ...updatedPostupak }
                                                                                                    : p
                                                                                            )
                                                                                        };
                                                                                    }
                                                                                    return n;
                                                                                }));
                                                                            }}
                                                                        />
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        )}
                                                    </>
                                                )}
                                            </React.Fragment>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        // KupciTab komponenta
        function KupciTab({ kupci, setKupci, userId }) {
            const [showForm, setShowForm] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [saving, setSaving] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 50;
            const [formData, setFormData] = useState({
                naziv: '',
                adresa: '',
                grad: '',
                postanskiBroj: '',
                oib: '',
                kontaktOsoba: '',
                telefon: '',
                email: ''
            });

            // Filtriraj kupce prema pretrazi
            const filteredKupci = kupci.filter(k => {
                const search = searchTerm.toLowerCase();
                return (
                    (k.naziv && k.naziv.toLowerCase().includes(search)) ||
                    (k.oib && k.oib.includes(search)) ||
                    (k.minimax_id && k.minimax_id.toString().includes(search)) ||
                    (k.telefon && k.telefon.includes(search)) ||
                    (k.email && k.email.toLowerCase().includes(search)) ||
                    (k.grad && k.grad.toLowerCase().includes(search)) ||
                    (k.kontaktOsoba && k.kontaktOsoba.toLowerCase().includes(search))
                );
            });

            // Paginacija
            const totalPages = Math.ceil(filteredKupci.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedKupci = filteredKupci.slice(startIndex, startIndex + itemsPerPage);

            // Reset stranice kad se promijeni pretraga
            useEffect(() => {
                setCurrentPage(1);
            }, [searchTerm]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setSaving(true);
                
                try {
                    if (editingId) {
                        await apiCall(`kupci/${editingId}`, 'PUT', formData, userId);
                        setKupci(kupci.map(k => k.id === editingId ? { ...formData, id: editingId } : k));
                    } else {
                        const result = await apiCall('kupci', 'POST', formData, userId);
                        setKupci([...kupci, { ...formData, id: result.id }]);
                    }
                    resetForm();
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                } finally {
                    setSaving(false);
                }
            };

            const handleDelete = async (id) => {
                if (!confirm('Jeste li sigurni?')) return;
                try {
                    await apiCall(`kupci/${id}`, 'DELETE', null, userId);
                    setKupci(kupci.filter(k => k.id !== id));
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleEdit = (kupac) => {
                setFormData(kupac);
                setEditingId(kupac.id);
            };

            const resetForm = () => {
                setFormData({ naziv: '', adresa: '', grad: '', postanskiBroj: '', oib: '', kontaktOsoba: '', telefon: '', email: '', minimax_id: '' });
                setEditingId(null);
                setShowForm(false);
            };

            const renderKupacForm = (isInline = false) => (
                <div className={isInline ? "bg-blue-50 border-2 border-blue-300 p-3" : "bg-white rounded-lg shadow-sm border p-4"}>
                    <h3 className="text-sm font-semibold mb-2">{editingId ? 'Uredi Kupca' : 'Novi Kupac'}</h3>
                    <form onSubmit={handleSubmit} className="space-y-2">
                        <div className="grid grid-cols-3 gap-2">
                            <div>
                                <label className="block text-xs font-medium mb-0.5">Naziv *</label>
                                <input
                                    type="text"
                                    value={formData.naziv}
                                    onChange={(e) => setFormData({ ...formData, naziv: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    required
                                    disabled={saving}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium mb-0.5">OIB</label>
                                <input
                                    type="text"
                                    value={formData.oib}
                                    onChange={(e) => setFormData({ ...formData, oib: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    maxLength="11"
                                    disabled={saving}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium mb-0.5">Minimax ID</label>
                                <input
                                    type="text"
                                    value={formData.minimax_id || ''}
                                    onChange={(e) => setFormData({ ...formData, minimax_id: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm bg-gray-50"
                                    placeholder="Auto sync"
                                    disabled={saving}
                                />
                            </div>
                        </div>
                        <div className="grid grid-cols-3 gap-2">
                            <div>
                                <label className="block text-xs font-medium mb-0.5">Kontakt osoba</label>
                                <input
                                    type="text"
                                    value={formData.kontaktOsoba}
                                    onChange={(e) => setFormData({ ...formData, kontaktOsoba: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    disabled={saving}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium mb-0.5">Telefon</label>
                                <input
                                    type="text"
                                    value={formData.telefon}
                                    onChange={(e) => setFormData({ ...formData, telefon: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    disabled={saving}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium mb-0.5">Email</label>
                                <input
                                    type="email"
                                    value={formData.email}
                                    onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    disabled={saving}
                                />
                            </div>
                        </div>
                        <div className="grid grid-cols-3 gap-2">
                            <div>
                                <label className="block text-xs font-medium mb-0.5">Adresa</label>
                                <input
                                    type="text"
                                    value={formData.adresa}
                                    onChange={(e) => setFormData({ ...formData, adresa: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    disabled={saving}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium mb-0.5">Grad</label>
                                <input
                                    type="text"
                                    value={formData.grad}
                                    onChange={(e) => setFormData({ ...formData, grad: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    disabled={saving}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium mb-0.5">Po≈°tanski broj</label>
                                <input
                                    type="text"
                                    value={formData.postanskiBroj}
                                    onChange={(e) => setFormData({ ...formData, postanskiBroj: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    disabled={saving}
                                />
                            </div>
                        </div>
                        <div className="flex justify-end space-x-2 pt-1">
                            <button
                                type="button"
                                onClick={resetForm}
                                className="px-3 py-1 border rounded hover:bg-gray-100 text-sm"
                                disabled={saving}
                            >
                                Odustani
                            </button>
                            <button
                                type="submit"
                                className="px-3 py-1 bg-primary-600 text-white rounded hover:bg-primary-700 text-sm"
                                disabled={saving}
                            >
                                {saving ? 'Spremanje...' : 'Spremi'}
                            </button>
                        </div>
                    </form>
                </div>
            );

            return (
                <div className="space-y-3">
                    {/* Header s pretragom */}
                    <div className="flex justify-between items-center gap-4">
                        <h2 className="text-xl font-semibold text-gray-800">üë• Kupci ({kupci.length})</h2>
                        <div className="flex-1 max-w-md">
                            <input
                                type="text"
                                placeholder="üîç Pretra≈æi kupce (naziv, OIB, telefon, email, grad...)"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="w-full border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none"
                            />
                        </div>
                        <button
                            onClick={() => { resetForm(); setShowForm(true); }}
                            className="bg-primary-600 text-white px-4 py-2 rounded hover:bg-primary-700 text-sm font-medium"
                        >
                            + Novo
                        </button>
                    </div>

                    {/* Info o pretrazi */}
                    {searchTerm && (
                        <div className="text-sm text-gray-600">
                            Pronaƒëeno: {filteredKupci.length} kupaca za "{searchTerm}"
                            <button 
                                onClick={() => setSearchTerm('')}
                                className="ml-2 text-primary-600 hover:underline"
                            >
                                Oƒçisti
                            </button>
                        </div>
                    )}

                    {/* Forma za NOVI kupac - na vrhu */}
                    {showForm && !editingId && renderKupacForm(false)}

                    {/* Tablica - kompaktna */}
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <table className="min-w-full text-xs">
                            <thead className="bg-gray-100">
                                <tr>
                                    <th className="px-2 py-2 text-left font-medium text-gray-600">NAZIV</th>
                                    <th className="px-2 py-2 text-left font-medium text-gray-600">OIB</th>
                                    <th className="px-2 py-2 text-left font-medium text-gray-600">ADRESA</th>
                                    <th className="px-2 py-2 text-left font-medium text-gray-600">PO≈†TA</th>
                                    <th className="px-2 py-2 text-left font-medium text-gray-600">MJESTO</th>
                                    <th className="px-2 py-2 text-left font-medium text-gray-600">MINIMAX</th>
                                    <th className="px-2 py-2 text-left font-medium text-gray-600">KONTAKT</th>
                                    <th className="px-2 py-2 text-left font-medium text-gray-600">TELEFON</th>
                                    <th className="px-2 py-2 text-right font-medium text-gray-600">AKCIJE</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {paginatedKupci.length === 0 ? (
                                    <tr>
                                        <td colSpan="9" className="px-2 py-4 text-center text-gray-500">
                                            {searchTerm ? 'Nema rezultata za pretragu' : 'Nema kupaca'}
                                        </td>
                                    </tr>
                                ) : (
                                    paginatedKupci.map(kupac => (
                                        <React.Fragment key={kupac.id}>
                                            <tr className="hover:bg-primary-50">
                                                <td className="px-2 py-1 font-medium text-gray-900 max-w-xs truncate" title={kupac.naziv}>
                                                    {kupac.naziv}
                                                </td>
                                                <td className="px-2 py-1 text-gray-600">{kupac.oib || '-'}</td>
                                                <td className="px-2 py-1 text-gray-600 max-w-xs truncate" title={kupac.adresa}>
                                                    {kupac.adresa || '-'}
                                                </td>
                                                <td className="px-2 py-1 text-gray-600">{kupac.postanskiBroj || '-'}</td>
                                                <td className="px-2 py-1 text-gray-600">{kupac.mjesto || '-'}</td>
                                                <td className="px-2 py-1 text-gray-600">
                                                    {kupac.minimax_id ? (
                                                        <span className="text-green-600" title="Povezan s Minimaxom">‚úì</span>
                                                    ) : (
                                                        <span className="text-gray-400">-</span>
                                                    )}
                                                </td>
                                                <td className="px-2 py-1 text-gray-600">{kupac.kontakt || '-'}</td>
                                                <td className="px-2 py-1 text-gray-600">{kupac.telefon || '-'}</td>
                                                <td className="px-2 py-1 text-right whitespace-nowrap">
                                                    <button
                                                        onClick={() => handleEdit(kupac)}
                                                        className="text-primary-600 hover:text-blue-900 mr-2"
                                                    >
                                                        Uredi
                                                    </button>
                                                    <button
                                                        onClick={() => handleDelete(kupac.id)}
                                                        className="text-red-600 hover:text-red-900"
                                                    >
                                                        Obri≈°i
                                                    </button>
                                                </td>
                                            </tr>
                                            {/* Inline edit forma */}
                                            {editingId === kupac.id && (
                                                <tr>
                                                    <td colSpan="9" className="p-0">
                                                        {renderKupacForm(true)}
                                                    </td>
                                                </tr>
                                            )}
                                        </React.Fragment>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>

                    {/* Paginacija */}
                    {totalPages > 1 && (
                        <div className="flex items-center justify-between bg-white rounded-lg shadow px-4 py-2">
                            <div className="text-sm text-gray-600">
                                Prikazano {startIndex + 1}-{Math.min(startIndex + itemsPerPage, filteredKupci.length)} od {filteredKupci.length}
                            </div>
                            <div className="flex gap-1">
                                <button
                                    onClick={() => setCurrentPage(1)}
                                    disabled={currentPage === 1}
                                    className="px-2 py-1 border rounded text-sm disabled:opacity-50 hover:bg-gray-100"
                                >
                                    ¬´¬´
                                </button>
                                <button
                                    onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                                    disabled={currentPage === 1}
                                    className="px-2 py-1 border rounded text-sm disabled:opacity-50 hover:bg-gray-100"
                                >
                                    ¬´
                                </button>
                                <span className="px-3 py-1 text-sm">
                                    {currentPage} / {totalPages}
                                </span>
                                <button
                                    onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                                    disabled={currentPage === totalPages}
                                    className="px-2 py-1 border rounded text-sm disabled:opacity-50 hover:bg-gray-100"
                                >
                                    ¬ª
                                </button>
                                <button
                                    onClick={() => setCurrentPage(totalPages)}
                                    disabled={currentPage === totalPages}
                                    className="px-2 py-1 border rounded text-sm disabled:opacity-50 hover:bg-gray-100"
                                >
                                    ¬ª¬ª
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ArtikliTab komponenta
        function ArtikliTab({ artikli, setArtikli, postupci, materijali, userId }) {
            const [showForm, setShowForm] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [saving, setSaving] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterKategorija, setFilterKategorija] = useState('');
            const [showKategorijeAdmin, setShowKategorijeAdmin] = useState(false);
            const [kategorijeList, setKategorijeList] = useState([]);
            const [novaKategorija, setNovaKategorija] = useState('');
            const [editingKategorija, setEditingKategorija] = useState(null);
            const [kpdResults, setKpdResults] = useState([]);
            const [sifraError, setSifraError] = useState('');
            const [barcodeError, setBarcodeError] = useState('');
            const [formData, setFormData] = useState({
                sifra: '',
                barcode: '',
                naziv: '',
                kategorijaId: '',
                jedinicaMjere: '',
                cijena: '',
                kpdSifra: '',
                kpdNaziv: '',
                kpdSearch: '',
                postupci: [],  // predefinirani postupci za artikl
                materijali: []  // potrebni materijali za izradu artikla
            });

            // Uƒçitaj kategorije iz baze
            useEffect(() => {
                loadKategorije();
            }, []);

            const loadKategorije = async () => {
                try {
                    const data = await apiCall('artikl-kategorije', 'GET', null, userId);
                    setKategorijeList(data || []);
                } catch (error) {
                    // Ako endpoint ne postoji, izvuci iz artikala
                    const katFromArtikli = [...new Set(artikli.map(a => a.kategorija).filter(k => k && k.trim()))].sort();
                    setKategorijeList(katFromArtikli.map((k, i) => ({ id: i+1, naziv: k })));
                }
            };

            // Izvuci sve kategorije (za kompatibilnost)
            const kategorije = kategorijeList.map(k => k.naziv).sort();

            const handleAddKategorija = async () => {
                if (!novaKategorija.trim()) return;
                try {
                    const result = await apiCall('artikl-kategorije', 'POST', { naziv: novaKategorija.trim() }, userId);
                    setKategorijeList([...kategorijeList, { id: result.id, naziv: novaKategorija.trim() }]);
                    setNovaKategorija('');
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleUpdateKategorija = async (id, noviNaziv) => {
                if (!noviNaziv.trim()) return;
                try {
                    const stariNaziv = kategorijeList.find(k => k.id === id)?.naziv;
                    await apiCall(`artikl-kategorije/${id}`, 'PUT', { naziv: noviNaziv.trim(), stariNaziv }, userId);
                    setKategorijeList(kategorijeList.map(k => k.id === id ? { ...k, naziv: noviNaziv.trim() } : k));
                    // A≈æuriraj artikle s tom kategorijom
                    setArtikli(artikli.map(a => a.kategorija === stariNaziv ? { ...a, kategorija: noviNaziv.trim() } : a));
                    setEditingKategorija(null);
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleDeleteKategorija = async (id) => {
                const kat = kategorijeList.find(k => k.id === id);
                const artikliSKategorijom = artikli.filter(a => a.kategorija === kat?.naziv).length;
                if (artikliSKategorijom > 0) {
                    if (!confirm(`Kategorija "${kat.naziv}" ima ${artikliSKategorijom} artikala. Artikli ƒáe ostati bez kategorije. Nastaviti?`)) return;
                }
                try {
                    await apiCall(`artikl-kategorije/${id}`, 'DELETE', null, userId);
                    setKategorijeList(kategorijeList.filter(k => k.id !== id));
                    // Ukloni kategoriju s artikala
                    setArtikli(artikli.map(a => a.kategorija === kat?.naziv ? { ...a, kategorija: '' } : a));
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            // Filtriraj artikle
            const filteredArtikli = artikli.filter(a => {
                const search = searchTerm.toLowerCase();
                const matchSearch = !searchTerm || 
                    (a.naziv && a.naziv.toLowerCase().includes(search)) ||
                    (a.kategorija && a.kategorija.toLowerCase().includes(search));
                const matchKategorija = !filterKategorija || a.kategorija === filterKategorija;
                return matchSearch && matchKategorija;
            });

            // Grupiraj po kategorijama
            console.log('üîç GROUPING - artikli:', artikli.length);
            console.log('üîç GROUPING - filteredArtikli:', filteredArtikli.length);
            if (filteredArtikli.length > 0) {
                console.log('üîç Prvi artikl:', {
                    naziv: filteredArtikli[0].naziv,
                    kategorija: filteredArtikli[0].kategorija,
                    kategorijaId: filteredArtikli[0].kategorijaId
                });
            }
            const groupedArtikli = filteredArtikli.reduce((acc, artikl) => {
                const kat = artikl.kategorija || 'Bez kategorije';
                console.log(`üì¶ Grupiranje: ${artikl.naziv} ‚Üí kategorija="${kat}"`);
                if (!acc[kat]) acc[kat] = [];
                acc[kat].push(artikl);
                return acc;
            }, {});
            console.log('üîç GROUPED:', Object.keys(groupedArtikli));

            // Sortiraj kategorije (Bez kategorije na kraj)
            const sortedKategorije = Object.keys(groupedArtikli).sort((a, b) => {
                if (a === 'Bez kategorije') return 1;
                if (b === 'Bez kategorije') return -1;
                return a.localeCompare(b, 'hr');
            });

            const handleSubmit = async (e) => {
                e.preventDefault();
                setSaving(true);
                
                const artiklData = {
                    sifra: formData.sifra || null,
                    barcode: formData.barcode || null,
                    naziv: formData.naziv,
                    kategorijaId: formData.kategorijaId ? parseInt(formData.kategorijaId) : null,
                    jedinicaMjere: formData.jedinicaMjere,
                    cijena: formData.cijena ? parseFloat(formData.cijena) : 0,
                    kpdSifra: formData.kpdSifra || null,
                    kpdNaziv: formData.kpdNaziv || null,
                    postupci: formData.postupci.filter(p => p.postupakId), // samo postupci s odabranim ID-om
                    materijali: formData.materijali.filter(m => m.materijalId) // samo materijali s odabranim ID-om
                };
                
                try {
                    if (editingId) {
                        await apiCall(`artikli/${editingId}`, 'PUT', artiklData, userId);
                        // Spremi materijale za artikl
                        await apiCall('artikl-materijali', 'POST', { artiklId: editingId, materijali: artiklData.materijali }, userId);
                        
                        // Dohvati naziv kategorije
                        const kategorijaObj = kategorijeList.find(k => k.id === parseInt(artiklData.kategorijaId));
                        const kategorijaDisplay = kategorijaObj ? kategorijaObj.naziv : '';
                        
                        setArtikli(artikli.map(a => a.id === editingId ? { 
                            ...artiklData, 
                            id: editingId,
                            kategorija: kategorijaDisplay  // Dodaj naziv kategorije za prikaz
                        } : a));
                    } else {
                        const result = await apiCall('artikli', 'POST', artiklData, userId);
                        // Spremi materijale za novi artikl
                        if (artiklData.materijali.length > 0) {
                            await apiCall('artikl-materijali', 'POST', { artiklId: result.id, materijali: artiklData.materijali }, userId);
                        }
                        
                        // Dohvati naziv kategorije
                        const kategorijaObj = kategorijeList.find(k => k.id === parseInt(artiklData.kategorijaId));
                        const kategorijaDisplay = kategorijaObj ? kategorijaObj.naziv : '';
                        
                        setArtikli([...artikli, { 
                            ...artiklData, 
                            id: result.id,
                            kategorija: kategorijaDisplay  // Dodaj naziv kategorije za prikaz
                        }]);
                    }
                    resetForm();
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                } finally {
                    setSaving(false);
                }
            };

            const handleDelete = async (id) => {
                if (!confirm('Jeste li sigurni?')) return;
                try {
                    await apiCall(`artikli/${id}`, 'DELETE', null, userId);
                    setArtikli(artikli.filter(a => a.id !== id));
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleEdit = async (artikl) => {
                // Uƒçitaj materijale za artikl
                let artiklMaterijali = [];
                try {
                    artiklMaterijali = await apiCall(`artikl-materijali/${artikl.id}`, 'GET', null, userId);
                } catch (e) {
                    console.log('Nema materijala za artikl');
                }
                
                setFormData({
                    sifra: artikl.sifra || '',
                    barcode: artikl.barcode || '',
                    naziv: artikl.naziv || '',
                    kategorijaId: artikl.kategorijaId || '',
                    jedinicaMjere: artikl.jedinicaMjere || '',
                    cijena: artikl.cijena || '',
                    kpdSifra: artikl.kpdSifra || '',
                    kpdNaziv: artikl.kpdNaziv || '',
                    kpdSearch: '',
                    postupci: artikl.postupci || [],
                    materijali: artiklMaterijali || []
                });
                setKpdResults([]);
                setEditingId(artikl.id);
            };

            const resetForm = () => {
                setFormData({ sifra: '', barcode: '', naziv: '', kategorijaId: '', jedinicaMjere: '', cijena: '', kpdSifra: '', kpdNaziv: '', kpdSearch: '', postupci: [], materijali: [] });
                setKpdResults([]);
                setSifraError('');
                setBarcodeError('');
                setEditingId(null);
                setShowForm(false);
            };

            // Funkcije za upravljanje postupcima artikla
            const addArtiklPostupak = () => {
                setFormData({
                    ...formData,
                    postupci: [...formData.postupci, { postupakId: '', defaultKolicina: 1, defaultCijena: 0 }]
                });
            };

            const updateArtiklPostupak = (index, field, value) => {
                const updated = [...formData.postupci];
                updated[index][field] = value;
                
                // Ako se odabire postupak, postavi default cijenu
                if (field === 'postupakId' && value) {
                    const postupak = postupci.find(p => String(p.id) === String(value));
                    if (postupak) {
                        updated[index].defaultCijena = postupak.cijena || 0;
                        updated[index].naziv = postupak.naziv;
                    }
                }
                
                setFormData({ ...formData, postupci: updated });
            };

            const removeArtiklPostupak = (index) => {
                setFormData({
                    ...formData,
                    postupci: formData.postupci.filter((_, i) => i !== index)
                });
            };

            // Funkcije za materijale artikla
            const addArtiklMaterijal = () => {
                setFormData({
                    ...formData,
                    materijali: [...formData.materijali, { materijalId: '', kolicina: 1 }]
                });
            };

            const updateArtiklMaterijal = (index, field, value) => {
                const updated = [...formData.materijali];
                updated[index][field] = value;
                
                // Ako se odabire materijal, postavi naziv
                if (field === 'materijalId' && value) {
                    const mat = materijali.find(m => String(m.id) === String(value));
                    if (mat) {
                        updated[index].naziv = mat.naziv;
                        updated[index].jedinicaMjere = mat.jedinicaMjere;
                        updated[index].cijena = mat.cijena;
                    }
                }
                
                setFormData({ ...formData, materijali: updated });
            };

            const removeArtiklMaterijal = (index) => {
                setFormData({
                    ...formData,
                    materijali: formData.materijali.filter((_, i) => i !== index)
                });
            };

            return (
                <div className="space-y-3">
                    {/* Header s pretragom */}
                    <div className="flex justify-between items-center gap-4">
                        <h2 className="text-xl font-semibold text-gray-800">üì¶ Artikli ({artikli.length})</h2>
                        <div className="flex-1 flex gap-2 max-w-xl">
                            <input
                                type="text"
                                placeholder="üîç Pretra≈æi artikle..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="flex-1 border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none"
                            />
                            <select
                                value={filterKategorija}
                                onChange={(e) => setFilterKategorija(e.target.value)}
                                className="border rounded px-3 py-2 text-sm"
                            >
                                <option value="">Sve kategorije</option>
                                {kategorije.map(k => (
                                    <option key={k} value={k}>{k}</option>
                                ))}
                            </select>
                        </div>
                        <div className="flex gap-2">
                            <button
                                onClick={() => setShowKategorijeAdmin(!showKategorijeAdmin)}
                                className={`px-3 py-2 rounded text-sm ${showKategorijeAdmin ? 'bg-purple-600 text-white' : 'bg-purple-100 text-purple-700 hover:bg-purple-200'}`}
                            >
                                üìÅ Kategorije ({kategorijeList.length})
                            </button>
                            <button
                                onClick={() => setShowForm(true)}
                                className="bg-primary-600 text-white px-4 py-2 rounded hover:bg-primary-700 text-sm font-medium"
                            >
                                + Novo
                            </button>
                        </div>
                    </div>

                    {/* Administracija kategorija */}
                    {showKategorijeAdmin && (
                        <div className="bg-purple-50 rounded-lg shadow-sm p-4 border border-purple-200">
                            <h3 className="text-base font-semibold mb-3 text-purple-900">üìÅ Upravljanje kategorijama</h3>
                            
                            {/* Dodaj novu kategoriju */}
                            <div className="flex gap-2 mb-3">
                                <input
                                    type="text"
                                    placeholder="Nova kategorija..."
                                    value={novaKategorija}
                                    onChange={(e) => setNovaKategorija(e.target.value)}
                                    className="flex-1 border rounded px-2 py-1 text-sm"
                                    onKeyPress={(e) => e.key === 'Enter' && handleAddKategorija()}
                                />
                                <button
                                    onClick={handleAddKategorija}
                                    className="bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700"
                                    disabled={!novaKategorija.trim()}
                                >
                                    + Dodaj
                                </button>
                            </div>

                            {/* Lista kategorija */}
                            <div className="space-y-1 max-h-48 overflow-y-auto">
                                {kategorijeList.length === 0 ? (
                                    <p className="text-sm text-gray-500 italic">Nema kategorija</p>
                                ) : (
                                    kategorijeList.map(kat => (
                                        <div key={kat.id} className="flex items-center gap-2 bg-white rounded px-2 py-1 border">
                                            {editingKategorija === kat.id ? (
                                                <>
                                                    <input
                                                        type="text"
                                                        defaultValue={kat.naziv}
                                                        className="flex-1 border rounded px-2 py-1 text-sm"
                                                        autoFocus
                                                        onBlur={(e) => handleUpdateKategorija(kat.id, e.target.value)}
                                                        onKeyPress={(e) => e.key === 'Enter' && handleUpdateKategorija(kat.id, e.target.value)}
                                                    />
                                                    <button
                                                        onClick={() => setEditingKategorija(null)}
                                                        className="text-gray-500 hover:text-gray-700 text-sm"
                                                    >
                                                        ‚úï
                                                    </button>
                                                </>
                                            ) : (
                                                <>
                                                    <span className="flex-1 text-sm">{kat.naziv}</span>
                                                    <span className="text-xs text-gray-400">
                                                        ({artikli.filter(a => a.kategorija === kat.naziv).length})
                                                    </span>
                                                    <button
                                                        onClick={() => setEditingKategorija(kat.id)}
                                                        className="text-primary-600 hover:text-primary-800 text-xs"
                                                    >
                                                        Uredi
                                                    </button>
                                                    <button
                                                        onClick={() => handleDeleteKategorija(kat.id)}
                                                        className="text-red-600 hover:text-red-800 text-xs"
                                                    >
                                                        Obri≈°i
                                                    </button>
                                                </>
                                            )}
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    )}

                    {/* Info o pretrazi */}
                    {(searchTerm || filterKategorija) && (
                        <div className="text-sm text-gray-600">
                            Pronaƒëeno: {filteredArtikli.length} artikala
                            <button 
                                onClick={() => { setSearchTerm(''); setFilterKategorija(''); }}
                                className="ml-2 text-primary-600 hover:underline"
                            >
                                Oƒçisti filtere
                            </button>
                        </div>
                    )}

                    {/* Forma za NOVI artikl - na vrhu */}
                    {showForm && !editingId && (
                        <div className="bg-white rounded-lg shadow-sm border p-4">
                            <h3 className="text-lg font-semibold mb-3">Novi Artikl</h3>
                            <form onSubmit={handleSubmit} className="space-y-3">
                                <div className="grid grid-cols-4 gap-3">
                                    <div>
                                        <label className="block text-xs font-medium mb-1">≈†ifra (Minimax)</label>
                                        <input
                                            type="text"
                                            value={formData.sifra}
                                            onChange={async (e) => {
                                                const newSifra = e.target.value;
                                                setFormData({ ...formData, sifra: newSifra });
                                                setSifraError('');
                                                
                                                // Provjeri da li ≈°ifra veƒá postoji (samo ako nije prazna)
                                                if (newSifra && newSifra.trim()) {
                                                    const exists = artikli.some(a => 
                                                        a.sifra === newSifra && (!editingId || a.id !== editingId)
                                                    );
                                                    if (exists) {
                                                        setSifraError('≈†ifra veƒá postoji!');
                                                    }
                                                }
                                            }}
                                            className={`w-full border rounded px-2 py-1 text-sm font-mono ${sifraError ? 'border-red-500' : ''}`}
                                            placeholder="npr. DT-001"
                                            disabled={saving}
                                        />
                                        {sifraError && <p className="text-xs text-red-600 mt-1">{sifraError}</p>}
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium mb-1">Barcode</label>
                                        <input
                                            type="text"
                                            value={formData.barcode}
                                            onChange={async (e) => {
                                                const newBarcode = e.target.value;
                                                setFormData({ ...formData, barcode: newBarcode });
                                                setBarcodeError('');
                                                
                                                // Provjeri da li barcode veƒá postoji
                                                if (newBarcode && newBarcode.trim()) {
                                                    const exists = artikli.some(a => 
                                                        a.barcode === newBarcode && (!editingId || a.id !== editingId)
                                                    );
                                                    if (exists) {
                                                        setBarcodeError('Barcode veƒá postoji!');
                                                    }
                                                }
                                            }}
                                            className={`w-full border rounded px-2 py-1 text-sm font-mono ${barcodeError ? 'border-red-500' : ''}`}
                                            placeholder="npr. 3800123456789"
                                            disabled={saving}
                                        />
                                        {barcodeError && <p className="text-xs text-red-600 mt-1">{barcodeError}</p>}
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium mb-1">Naziv *</label>
                                        <input
                                            type="text"
                                            value={formData.naziv}
                                            onChange={(e) => setFormData({ ...formData, naziv: e.target.value })}
                                            className="w-full border rounded px-2 py-1 text-sm"
                                            required
                                            disabled={saving}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium mb-1">Kategorija</label>
                                        <select
                                            value={formData.kategorijaId}
                                            onChange={async (e) => {
                                                const kategorijaId = e.target.value;
                                                setFormData({ ...formData, kategorijaId });
                                                
                                                // Automatski dohvati sljedeƒáu ≈°ifru ZA OVU kategoriju
                                                // ALI SAMO ako korisnik nije veƒá upisao neku ≈°ifru
                                                if (kategorijaId && !editingId && !formData.sifra) {
                                                    try {
                                                        const response = await fetch(`${API_URL}/artikli-next-sifra?kategorijaId=${kategorijaId}`);
                                                        const data = await response.json();
                                                        if (data.sifra) {
                                                            setFormData(prev => ({ ...prev, sifra: data.sifra, kategorijaId }));
                                                        }
                                                    } catch (error) {
                                                        console.error('Gre≈°ka pri dohvatu sljedeƒáe ≈°ifre:', error);
                                                    }
                                                }
                                            }}
                                            className="w-full border rounded px-2 py-1 text-sm"
                                            disabled={saving}
                                            required
                                        >
                                            <option value="">-- Odaberi kategoriju --</option>
                                            {kategorijeList.map(k => (
                                                <option key={k.id} value={k.id}>{k.naziv}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-xs font-medium mb-1">Jedinica mjere</label>
                                        <input
                                            type="text"
                                            value={formData.jedinicaMjere}
                                            onChange={(e) => setFormData({ ...formData, jedinicaMjere: e.target.value })}
                                            className="w-full border rounded px-2 py-1 text-sm"
                                            placeholder="kom, kg, m2..."
                                            disabled={saving}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium mb-1">Cijena (EUR)</label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            value={formData.cijena}
                                            onChange={(e) => setFormData({ ...formData, cijena: e.target.value })}
                                            className="w-full border rounded px-2 py-1 text-sm"
                                            disabled={saving}
                                        />
                                    </div>
                                </div>
                                
                                {/* KPD 2025 ≈°ifra */}
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <label className="block text-xs font-medium mb-1 text-blue-900">üìã KPD 2025 ≈°ifra (za Fiskalizaciju 2.0)</label>
                                    <div className="relative">
                                        <input
                                            type="text"
                                            value={formData.kpdSearch || formData.kpdSifra || ''}
                                            onChange={(e) => {
                                                setFormData({ ...formData, kpdSearch: e.target.value, kpdSifra: '', kpdNaziv: '' });
                                                if (e.target.value.length >= 2) {
                                                    fetch(`${API_URL}/kpd?search=${encodeURIComponent(e.target.value)}&limit=15`)
                                                        .then(r => r.json())
                                                        .then(data => setKpdResults(data))
                                                        .catch(() => setKpdResults([]));
                                                } else {
                                                    setKpdResults([]);
                                                }
                                            }}
                                            className="w-full border rounded px-2 py-1 text-sm"
                                            placeholder="Tra≈æi po ≈°ifri ili nazivu..."
                                            disabled={saving}
                                        />
                                        {kpdResults.length > 0 && (
                                            <div className="absolute z-50 w-full bg-white border rounded shadow-lg mt-1 max-h-48 overflow-y-auto">
                                                {kpdResults.map(k => (
                                                    <div
                                                        key={k.sifra}
                                                        className="px-2 py-1.5 hover:bg-blue-100 cursor-pointer border-b text-xs"
                                                        onClick={() => {
                                                            setFormData({ 
                                                                ...formData, 
                                                                kpdSifra: k.sifra, 
                                                                kpdNaziv: k.naziv,
                                                                kpdSearch: ''
                                                            });
                                                            setKpdResults([]);
                                                        }}
                                                    >
                                                        <span className="font-mono font-bold text-blue-700">{k.sifra}</span>
                                                        <span className="text-gray-600 ml-2">{k.naziv}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    {formData.kpdSifra && (
                                        <div className="mt-2 flex items-center gap-2">
                                            <span className="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs font-mono font-bold">
                                                {formData.kpdSifra}
                                            </span>
                                            <span className="text-xs text-gray-700">{formData.kpdNaziv}</span>
                                            <button
                                                type="button"
                                                onClick={() => setFormData({ ...formData, kpdSifra: '', kpdNaziv: '', kpdSearch: '' })}
                                                className="text-red-500 hover:text-red-700 text-xs ml-auto"
                                            >
                                                ‚úï Ukloni
                                            </button>
                                        </div>
                                    )}
                                </div>

                                {/* Predefinirani postupci za artikl */}
                                <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                                    <div className="flex items-center gap-2 mb-2">
                                        <label className="text-xs font-medium text-green-900">‚öôÔ∏è Predefinirani postupci</label>
                                        <button
                                            type="button"
                                            onClick={addArtiklPostupak}
                                            className="text-green-600 hover:text-green-800 text-xs bg-green-100 px-2 py-0.5 rounded"
                                            disabled={saving}
                                        >
                                            + Dodaj postupak
                                        </button>
                                        <span className="text-xs text-gray-500 ml-2">(automatski se dodaju kad se artikl doda na nalog)</span>
                                    </div>
                                    {formData.postupci.length === 0 ? (
                                        <p className="text-xs text-gray-500 italic">Nema predefiniranih postupaka</p>
                                    ) : (
                                        <div className="space-y-1">
                                            {formData.postupci.map((p, index) => (
                                                <div key={index} className="flex items-center gap-2 bg-white rounded px-2 py-1 border border-green-200">
                                                    <select
                                                        value={p.postupakId || ''}
                                                        onChange={(e) => updateArtiklPostupak(index, 'postupakId', e.target.value)}
                                                        className="flex-1 border rounded px-2 py-1 text-xs"
                                                        disabled={saving}
                                                    >
                                                        <option value="">Odaberi postupak</option>
                                                        {postupci.map(post => (
                                                            <option key={post.id} value={post.id}>{post.naziv}</option>
                                                        ))}
                                                    </select>
                                                    <div className="flex items-center gap-1">
                                                        <span className="text-xs text-gray-500">Kol:</span>
                                                        <input
                                                            type="number"
                                                            step="0.01"
                                                            min="0"
                                                            value={p.defaultKolicina || 1}
                                                            onChange={(e) => updateArtiklPostupak(index, 'defaultKolicina', parseFloat(e.target.value) || 1)}
                                                            className="w-16 border rounded px-1 py-1 text-xs text-center"
                                                            disabled={saving}
                                                        />
                                                    </div>
                                                    <div className="flex items-center gap-1">
                                                        <span className="text-xs text-gray-500">‚Ç¨:</span>
                                                        <input
                                                            type="number"
                                                            step="0.01"
                                                            min="0"
                                                            value={p.defaultCijena || 0}
                                                            onChange={(e) => updateArtiklPostupak(index, 'defaultCijena', parseFloat(e.target.value) || 0)}
                                                            className="w-20 border rounded px-1 py-1 text-xs text-center"
                                                            disabled={saving}
                                                        />
                                                    </div>
                                                    <button
                                                        type="button"
                                                        onClick={() => removeArtiklPostupak(index)}
                                                        className="text-red-500 hover:text-red-700"
                                                        disabled={saving}
                                                    >
                                                        ‚úï
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {/* Materijali potrebni za izradu artikla */}
                                <div className="bg-primary-50 border border-primary-200 rounded-lg p-3">
                                    <div className="flex items-center gap-2 mb-2">
                                        <label className="text-xs font-medium text-primary-900">üß± Materijali za izradu</label>
                                        <button
                                            type="button"
                                            onClick={addArtiklMaterijal}
                                            className="text-primary-600 hover:text-primary-800 text-xs bg-primary-100 px-2 py-0.5 rounded"
                                            disabled={saving}
                                        >
                                            + Dodaj materijal
                                        </button>
                                        <span className="text-xs text-gray-500 ml-2">(rasknji≈æenje pri izradi)</span>
                                    </div>
                                    {formData.materijali.length === 0 ? (
                                        <p className="text-xs text-gray-500 italic">Nema definiranih materijala</p>
                                    ) : (
                                        <div className="space-y-1">
                                            {formData.materijali.map((m, index) => (
                                                <div key={index} className="flex items-center gap-2 bg-white rounded px-2 py-1 border border-primary-200">
                                                    <select
                                                        value={m.materijalId || ''}
                                                        onChange={(e) => updateArtiklMaterijal(index, 'materijalId', e.target.value)}
                                                        className="flex-1 border rounded px-2 py-1 text-xs"
                                                        disabled={saving}
                                                    >
                                                        <option value="">Odaberi materijal</option>
                                                        {materijali.map(mat => (
                                                            <option key={mat.id} value={mat.id}>
                                                                {mat.naziv} ({mat.jedinicaMjere})
                                                            </option>
                                                        ))}
                                                    </select>
                                                    <div className="flex items-center gap-1">
                                                        <span className="text-xs text-gray-500">Kol:</span>
                                                        <input
                                                            type="number"
                                                            step="0.0001"
                                                            min="0"
                                                            value={m.kolicina || 1}
                                                            onChange={(e) => updateArtiklMaterijal(index, 'kolicina', parseFloat(e.target.value) || 1)}
                                                            className="w-20 border rounded px-1 py-1 text-xs text-center"
                                                            disabled={saving}
                                                        />
                                                        {m.jedinicaMjere && (
                                                            <span className="text-xs text-gray-500">{m.jedinicaMjere}</span>
                                                        )}
                                                    </div>
                                                    {m.cijena > 0 && (
                                                        <span className="text-xs text-primary-700">
                                                            = {(parseFloat(m.kolicina || 1) * parseFloat(m.cijena || 0)).toFixed(2)} ‚Ç¨
                                                        </span>
                                                    )}
                                                    <button
                                                        type="button"
                                                        onClick={() => removeArtiklMaterijal(index)}
                                                        className="text-red-500 hover:text-red-700"
                                                        disabled={saving}
                                                    >
                                                        ‚úï
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <div className="flex justify-end space-x-2">
                                    <button
                                        type="button"
                                        onClick={resetForm}
                                        className="px-3 py-1 border rounded hover:bg-gray-100 text-sm"
                                        disabled={saving}
                                    >
                                        Odustani
                                    </button>
                                    <button
                                        type="submit"
                                        className="px-3 py-1 bg-primary-600 text-white rounded hover:bg-primary-700 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                        disabled={saving || sifraError || barcodeError}
                                        title={sifraError || barcodeError ? 'Ispravite gre≈°ke prije spremanja' : ''}
                                    >
                                        {saving ? 'Spremanje...' : 'Spremi'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    {/* Artikli grupirani po kategorijama */}
                    <div className="space-y-3">
                        {sortedKategorije.length === 0 ? (
                            <div className="bg-white rounded-lg shadow-sm border p-4 text-center text-gray-500">
                                Nema artikala
                            </div>
                        ) : (
                            sortedKategorije.map(kategorija => (
                                <div key={kategorija} className="bg-white rounded-lg shadow overflow-hidden">
                                    <div className="bg-gray-100 px-3 py-2 font-semibold text-sm text-gray-700 border-b">
                                        üìÅ {kategorija} ({groupedArtikli[kategorija].length})
                                    </div>
                                    <table className="min-w-full text-xs">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-2 py-1 text-left font-medium text-gray-600 w-24">≈†IFRA</th>
                                                <th className="px-2 py-1 text-left font-medium text-gray-600 w-32">BARCODE</th>
                                                <th className="px-2 py-1 text-left font-medium text-gray-600">NAZIV</th>
                                                <th className="px-2 py-1 text-left font-medium text-gray-600 w-24">JED.</th>
                                                <th className="px-2 py-1 text-right font-medium text-gray-600 w-24">CIJENA</th>
                                                <th className="px-2 py-1 text-left font-medium text-gray-600 w-28">KPD</th>
                                                <th className="px-2 py-1 text-center font-medium text-gray-600 w-24">POSTUPCI</th>
                                                <th className="px-2 py-1 text-right font-medium text-gray-600 w-28">AKCIJE</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {groupedArtikli[kategorija].map(artikl => (
                                                <React.Fragment key={artikl.id}>
                                                    <tr className="hover:bg-primary-50">
                                                        <td className="px-2 py-1 font-mono text-gray-600">{artikl.sifra || '-'}</td>
                                                        <td className="px-2 py-1 font-mono text-gray-600">{artikl.barcode || '-'}</td>
                                                        <td className="px-2 py-1 text-gray-900">{artikl.naziv}</td>
                                                        <td className="px-2 py-1 text-gray-600">{artikl.jedinicaMjere || '-'}</td>
                                                        <td className="px-2 py-1 text-right text-gray-900">
                                                            {parseFloat(artikl.cijena || 0).toFixed(2)} ‚Ç¨
                                                        </td>
                                                        <td className="px-2 py-1">
                                                            {artikl.kpdSifra ? (
                                                                <span className="font-mono text-blue-700 text-xs" title={artikl.kpdNaziv || ''}>
                                                                    {artikl.kpdSifra}
                                                                </span>
                                                            ) : (
                                                                <span className="text-gray-400">-</span>
                                                            )}
                                                        </td>
                                                        <td className="px-2 py-1 text-center">
                                                            {artikl.postupci && artikl.postupci.length > 0 ? (
                                                                <span className="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs" title={artikl.postupci.map(p => p.naziv).join(', ')}>
                                                                    {artikl.postupci.length} ‚öôÔ∏è
                                                                </span>
                                                            ) : (
                                                                <span className="text-gray-400">-</span>
                                                            )}
                                                        </td>
                                                        <td className="px-2 py-1 text-right whitespace-nowrap">
                                                            <button
                                                                onClick={() => handleEdit(artikl)}
                                                                className="text-primary-600 hover:text-blue-900 mr-2"
                                                            >
                                                                Uredi
                                                            </button>
                                                            <button
                                                                onClick={() => handleDelete(artikl.id)}
                                                                className="text-red-600 hover:text-red-900"
                                                            >
                                                                Obri≈°i
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    {/* Inline edit forma */}
                                                    {editingId === artikl.id && (
                                                        <tr>
                                                            <td colSpan="8" className="p-0">
                                                                <div className="bg-blue-50 border-2 border-blue-300 p-3">
                                                                    <h3 className="text-sm font-semibold mb-2">Uredi Artikl: {artikl.naziv}</h3>
                                                                    <form onSubmit={handleSubmit} className="space-y-2">
                                                                        <div className="grid grid-cols-7 gap-2">
                                                                            <div>
                                                                                <label className="block text-xs font-medium mb-0.5">≈†ifra</label>
                                                                                <input
                                                                                    type="text"
                                                                                    value={formData.sifra}
                                                                                    onChange={(e) => setFormData({ ...formData, sifra: e.target.value })}
                                                                                    className="w-full border rounded px-2 py-1 text-xs font-mono"
                                                                                    disabled={saving}
                                                                                />
                                                                            </div>
                                                                            <div>
                                                                                <label className="block text-xs font-medium mb-0.5">Barcode</label>
                                                                                <input
                                                                                    type="text"
                                                                                    value={formData.barcode}
                                                                                    onChange={(e) => setFormData({ ...formData, barcode: e.target.value })}
                                                                                    className="w-full border rounded px-2 py-1 text-xs font-mono"
                                                                                    disabled={saving}
                                                                                />
                                                                            </div>
                                                                            <div className="col-span-2">
                                                                                <label className="block text-xs font-medium mb-0.5">Naziv *</label>
                                                                                <input
                                                                                    type="text"
                                                                                    value={formData.naziv}
                                                                                    onChange={(e) => setFormData({ ...formData, naziv: e.target.value })}
                                                                                    className="w-full border rounded px-2 py-1 text-xs"
                                                                                    required
                                                                                    disabled={saving}
                                                                                />
                                                                            </div>
                                                                            <div>
                                                                                <label className="block text-xs font-medium mb-0.5">Kategorija</label>
                                                                                <select
                                                                                    value={formData.kategorijaId}
                                                                                    onChange={(e) => setFormData({ ...formData, kategorijaId: e.target.value })}
                                                                                    className="w-full border rounded px-2 py-1 text-xs"
                                                                                    disabled={saving}
                                                                                >
                                                                                    <option value="">-- Odaberi --</option>
                                                                                    {kategorijeList.map(k => (
                                                                                        <option key={k.id} value={k.id}>{k.naziv}</option>
                                                                                    ))}
                                                                                </select>
                                                                            </div>
                                                                            <div>
                                                                                <label className="block text-xs font-medium mb-0.5">Jed.</label>
                                                                                <input
                                                                                    type="text"
                                                                                    value={formData.jedinicaMjere}
                                                                                    onChange={(e) => setFormData({ ...formData, jedinicaMjere: e.target.value })}
                                                                                    className="w-full border rounded px-2 py-1 text-xs"
                                                                                    disabled={saving}
                                                                                />
                                                                            </div>
                                                                            <div>
                                                                                <label className="block text-xs font-medium mb-0.5">Cijena ‚Ç¨</label>
                                                                                <input
                                                                                    type="number"
                                                                                    step="0.01"
                                                                                    value={formData.cijena}
                                                                                    onChange={(e) => setFormData({ ...formData, cijena: e.target.value })}
                                                                                    className="w-full border rounded px-2 py-1 text-xs"
                                                                                    disabled={saving}
                                                                                />
                                                                            </div>
                                                                        </div>
                                                                        
                                                                        {/* KPD ≈°ifra - inline */}
                                                                        <div className="grid grid-cols-2 gap-2">
                                                                            <div className="relative">
                                                                                <label className="block text-xs font-medium mb-0.5 text-blue-800">üìã KPD 2025</label>
                                                                                <input
                                                                                    type="text"
                                                                                    value={formData.kpdSearch || formData.kpdSifra || ''}
                                                                                    onChange={(e) => {
                                                                                        setFormData({ ...formData, kpdSearch: e.target.value, kpdSifra: '', kpdNaziv: '' });
                                                                                        if (e.target.value.length >= 2) {
                                                                                            fetch(`${API_URL}/kpd?search=${encodeURIComponent(e.target.value)}&limit=10`)
                                                                                                .then(r => r.json())
                                                                                                .then(data => setKpdResults(data))
                                                                                                .catch(() => setKpdResults([]));
                                                                                        } else {
                                                                                            setKpdResults([]);
                                                                                        }
                                                                                    }}
                                                                                    className="w-full border rounded px-2 py-1 text-xs"
                                                                                    placeholder="Tra≈æi KPD..."
                                                                                    disabled={saving}
                                                                                />
                                                                                {kpdResults.length > 0 && (
                                                                                    <div className="absolute z-50 w-full bg-white border rounded shadow-lg mt-1 max-h-32 overflow-y-auto">
                                                                                        {kpdResults.map(k => (
                                                                                            <div
                                                                                                key={k.sifra}
                                                                                                className="px-2 py-1 hover:bg-blue-100 cursor-pointer text-xs"
                                                                                                onClick={() => {
                                                                                                    setFormData({ ...formData, kpdSifra: k.sifra, kpdNaziv: k.naziv, kpdSearch: '' });
                                                                                                    setKpdResults([]);
                                                                                                }}
                                                                                            >
                                                                                                <span className="font-mono font-bold text-blue-700">{k.sifra}</span>
                                                                                                <span className="text-gray-600 ml-1">{k.naziv.substring(0, 40)}...</span>
                                                                                            </div>
                                                                                        ))}
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                            <div>
                                                                                {formData.kpdSifra && (
                                                                                    <div className="bg-blue-100 rounded px-2 py-1 mt-4 text-xs">
                                                                                        <span className="font-mono font-bold">{formData.kpdSifra}</span>
                                                                                        <span className="text-gray-600 ml-1">{formData.kpdNaziv?.substring(0, 30)}...</span>
                                                                                        <button type="button" onClick={() => setFormData({ ...formData, kpdSifra: '', kpdNaziv: '' })} className="ml-2 text-red-500">‚úï</button>
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        </div>
                                                                        
                                                                        {/* Predefinirani postupci za artikl */}
                                                                        <div className="bg-green-50 border border-green-200 rounded-lg p-2 mt-2">
                                                                            <div className="flex items-center gap-2 mb-2">
                                                                                <label className="text-xs font-medium text-green-900">‚öôÔ∏è Predefinirani postupci</label>
                                                                                <button
                                                                                    type="button"
                                                                                    onClick={addArtiklPostupak}
                                                                                    className="text-green-600 hover:text-green-800 text-xs bg-green-100 px-2 py-0.5 rounded"
                                                                                    disabled={saving}
                                                                                >
                                                                                    + Dodaj postupak
                                                                                </button>
                                                                            </div>
                                                                            {formData.postupci.length === 0 ? (
                                                                                <p className="text-xs text-gray-500 italic">Nema predefiniranih postupaka</p>
                                                                            ) : (
                                                                                <div className="space-y-1">
                                                                                    {formData.postupci.map((p, index) => (
                                                                                        <div key={index} className="flex items-center gap-2 bg-white rounded px-2 py-1 border border-green-200">
                                                                                            <select
                                                                                                value={p.postupakId || ''}
                                                                                                onChange={(e) => updateArtiklPostupak(index, 'postupakId', e.target.value)}
                                                                                                className="flex-1 border rounded px-2 py-1 text-xs"
                                                                                                disabled={saving}
                                                                                            >
                                                                                                <option value="">Odaberi postupak</option>
                                                                                                {postupci.map(post => (
                                                                                                    <option key={post.id} value={post.id}>{post.naziv}</option>
                                                                                                ))}
                                                                                            </select>
                                                                                            <div className="flex items-center gap-1">
                                                                                                <span className="text-xs text-gray-500">Kol:</span>
                                                                                                <input
                                                                                                    type="number"
                                                                                                    step="0.01"
                                                                                                    min="0"
                                                                                                    value={p.defaultKolicina || 1}
                                                                                                    onChange={(e) => updateArtiklPostupak(index, 'defaultKolicina', parseFloat(e.target.value) || 1)}
                                                                                                    className="w-16 border rounded px-1 py-1 text-xs text-center"
                                                                                                    disabled={saving}
                                                                                                />
                                                                                            </div>
                                                                                            <div className="flex items-center gap-1">
                                                                                                <span className="text-xs text-gray-500">‚Ç¨:</span>
                                                                                                <input
                                                                                                    type="number"
                                                                                                    step="0.01"
                                                                                                    min="0"
                                                                                                    value={p.defaultCijena || 0}
                                                                                                    onChange={(e) => updateArtiklPostupak(index, 'defaultCijena', parseFloat(e.target.value) || 0)}
                                                                                                    className="w-20 border rounded px-1 py-1 text-xs text-center"
                                                                                                    disabled={saving}
                                                                                                />
                                                                                            </div>
                                                                                            <button
                                                                                                type="button"
                                                                                                onClick={() => removeArtiklPostupak(index)}
                                                                                                className="text-red-500 hover:text-red-700"
                                                                                                disabled={saving}
                                                                                            >
                                                                                                ‚úï
                                                                                            </button>
                                                                                        </div>
                                                                                    ))}
                                                                                </div>
                                                                            )}
                                                                        </div>

                                                                        {/* Materijali potrebni za izradu artikla */}
                                                                        <div className="bg-primary-50 border border-primary-200 rounded-lg p-2 mt-2">
                                                                            <div className="flex items-center gap-2 mb-2">
                                                                                <label className="text-xs font-medium text-primary-900">üß± Materijali za izradu</label>
                                                                                <button
                                                                                    type="button"
                                                                                    onClick={addArtiklMaterijal}
                                                                                    className="text-primary-600 hover:text-primary-800 text-xs bg-primary-100 px-2 py-0.5 rounded"
                                                                                    disabled={saving}
                                                                                >
                                                                                    + Dodaj materijal
                                                                                </button>
                                                                            </div>
                                                                            {formData.materijali.length === 0 ? (
                                                                                <p className="text-xs text-gray-500 italic">Nema materijala</p>
                                                                            ) : (
                                                                                <div className="space-y-1">
                                                                                    {formData.materijali.map((m, index) => (
                                                                                        <div key={index} className="flex items-center gap-2 bg-white rounded px-2 py-1 border border-primary-200">
                                                                                            <select
                                                                                                value={m.materijalId || ''}
                                                                                                onChange={(e) => updateArtiklMaterijal(index, 'materijalId', e.target.value)}
                                                                                                className="flex-1 border rounded px-2 py-1 text-xs"
                                                                                                disabled={saving}
                                                                                            >
                                                                                                <option value="">Odaberi materijal</option>
                                                                                                {materijali.map(mat => (
                                                                                                    <option key={mat.id} value={mat.id}>{mat.naziv}</option>
                                                                                                ))}
                                                                                            </select>
                                                                                            <div className="flex items-center gap-1">
                                                                                                <span className="text-xs text-gray-500">Kol:</span>
                                                                                                <input
                                                                                                    type="number"
                                                                                                    step="0.01"
                                                                                                    min="0"
                                                                                                    value={m.kolicina || 1}
                                                                                                    onChange={(e) => updateArtiklMaterijal(index, 'kolicina', parseFloat(e.target.value) || 1)}
                                                                                                    className="w-20 border rounded px-1 py-1 text-xs text-center"
                                                                                                    disabled={saving}
                                                                                                />
                                                                                            </div>
                                                                                            <button
                                                                                                type="button"
                                                                                                onClick={() => removeArtiklMaterijal(index)}
                                                                                                className="text-red-500 hover:text-red-700"
                                                                                                disabled={saving}
                                                                                            >
                                                                                                ‚úï
                                                                                            </button>
                                                                                        </div>
                                                                                    ))}
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                        
                                                                        <div className="flex justify-end space-x-2 pt-1">
                                                                            <button
                                                                                type="button"
                                                                                onClick={resetForm}
                                                                                className="px-3 py-1 border rounded hover:bg-gray-100 text-sm"
                                                                                disabled={saving}
                                                                            >
                                                                                Odustani
                                                                            </button>
                                                                            <button
                                                                                type="submit"
                                                                                className="px-3 py-1 bg-primary-600 text-white rounded hover:bg-primary-700 text-sm"
                                                                                disabled={saving}
                                                                            >
                                                                                {saving ? 'Spremanje...' : 'Spremi'}
                                                                            </button>
                                                                        </div>
                                                                    </form>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    )}
                                                </React.Fragment>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        }

        // PostupciTab komponenta
        function PostupciTab({ postupci, setPostupci, userId }) {
            const [showForm, setShowForm] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [saving, setSaving] = useState(false);
            const [formData, setFormData] = useState({
                naziv: '',
                opis: '',
                trajanje: ''
            });

            const handleSubmit = async (e) => {
                e.preventDefault();
                setSaving(true);
                
                const postupakData = {
                    naziv: formData.naziv,
                    opis: formData.opis,
                    trajanje: formData.trajanje ? parseInt(formData.trajanje) : null
                };
                
                try {
                    if (editingId) {
                        await apiCall(`postupci/${editingId}`, 'PUT', postupakData, userId);
                        setPostupci(postupci.map(p => p.id === editingId ? { ...postupakData, id: editingId } : p));
                    } else {
                        const result = await apiCall('postupci', 'POST', postupakData, userId);
                        setPostupci([...postupci, { ...postupakData, id: result.id }]);
                    }
                    resetForm();
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                } finally {
                    setSaving(false);
                }
            };

            const handleDelete = async (id) => {
                if (!confirm('Jeste li sigurni?')) return;
                try {
                    await apiCall(`postupci/${id}`, 'DELETE', null, userId);
                    setPostupci(postupci.filter(p => p.id !== id));
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleEdit = (postupak) => {
                setFormData(postupak);
                setEditingId(postupak.id);
            };

            const resetForm = () => {
                setFormData({ naziv: '', opis: '', trajanje: '' });
                setEditingId(null);
                setShowForm(false);
            };

            const renderPostupakForm = (isInline = false) => (
                <div className={isInline ? "bg-blue-50 border-2 border-blue-300 p-3" : "bg-white rounded-lg shadow-sm border p-4"}>
                    <h3 className="text-sm font-semibold mb-2">{editingId ? 'Uredi Postupak' : 'Novi Postupak'}</h3>
                    <form onSubmit={handleSubmit} className="space-y-2">
                        <div className="grid grid-cols-3 gap-2">
                            <div>
                                <label className="block text-xs font-medium mb-0.5">Naziv *</label>
                                <input
                                    type="text"
                                    value={formData.naziv}
                                    onChange={(e) => setFormData({ ...formData, naziv: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    required
                                    disabled={saving}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium mb-0.5">Trajanje (min)</label>
                                <input
                                    type="number"
                                    value={formData.trajanje}
                                    onChange={(e) => setFormData({ ...formData, trajanje: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    disabled={saving}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium mb-0.5">Opis</label>
                                <input
                                    type="text"
                                    value={formData.opis}
                                    onChange={(e) => setFormData({ ...formData, opis: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    disabled={saving}
                                />
                            </div>
                        </div>
                        <div className="flex justify-end space-x-2 pt-1">
                            <button
                                type="button"
                                onClick={resetForm}
                                className="px-3 py-1 border rounded hover:bg-gray-100 text-sm"
                                disabled={saving}
                            >
                                Odustani
                            </button>
                            <button
                                type="submit"
                                className="px-3 py-1 bg-primary-600 text-white rounded hover:bg-primary-700 text-sm"
                                disabled={saving}
                            >
                                {saving ? 'Spremanje...' : 'Spremi'}
                            </button>
                        </div>
                    </form>
                </div>
            );

            return (
                <div className="space-y-4">
                    <div className="flex justify-between items-center">
                        <h2 className="text-xl font-semibold text-gray-800">‚öôÔ∏è Postupci</h2>
                        <button
                            onClick={() => { resetForm(); setShowForm(true); }}
                            className="bg-primary-600 text-white px-4 py-2 rounded hover:bg-primary-700 text-sm font-medium"
                        >
                            + Novo
                        </button>
                    </div>

                    {/* Forma za NOVI postupak - na vrhu */}
                    {showForm && !editingId && renderPostupakForm(false)}

                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Naziv</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trajanje</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Akcije</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {postupci.length === 0 ? (
                                    <tr>
                                        <td colSpan="3" className="px-6 py-4 text-center text-gray-500">
                                            Nema postupaka
                                        </td>
                                    </tr>
                                ) : (
                                    postupci.map(postupak => (
                                        <React.Fragment key={postupak.id}>
                                            <tr className="hover:bg-gray-50">
                                                <td className="px-6 py-4 font-medium">{postupak.naziv}</td>
                                                <td className="px-6 py-4">{postupak.trajanje ? `${postupak.trajanje} min` : '-'}</td>
                                                <td className="px-6 py-4 text-right text-sm">
                                                    <button
                                                        onClick={() => handleEdit(postupak)}
                                                        className="text-primary-600 hover:text-blue-900 mr-3"
                                                    >
                                                        Uredi
                                                    </button>
                                                    <button
                                                        onClick={() => handleDelete(postupak.id)}
                                                        className="text-red-600 hover:text-red-900"
                                                    >
                                                        Obri≈°i
                                                    </button>
                                                </td>
                                            </tr>
                                            {/* Inline edit forma */}
                                            {editingId === postupak.id && (
                                                <tr>
                                                    <td colSpan="3" className="p-0">
                                                        {renderPostupakForm(true)}
                                                    </td>
                                                </tr>
                                            )}
                                        </React.Fragment>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // MaterijaliTab komponenta
        function MaterijaliTab({ materijali, setMaterijali, userId }) {
            const [showForm, setShowForm] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [hasKnjizenja, setHasKnjizenja] = useState(false);
            const [saving, setSaving] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterKategorija, setFilterKategorija] = useState('');
            const [formData, setFormData] = useState({
                naziv: '',
                kategorija: '',
                jedinicaMjere: 'kom',
                cijena: '',
                zaliha: '',
                minZaliha: ''
            });
            
            // Kartica materijala
            const [showKartica, setShowKartica] = useState(false);
            const [karticaMaterijal, setKarticaMaterijal] = useState(null);
            const [povijest, setPovijest] = useState([]);
            const [loadingPovijest, setLoadingPovijest] = useState(false);
            const [dodajZalihuKol, setDodajZalihuKol] = useState('');
            const [dodajZalihuNapomena, setDodajZalihuNapomena] = useState('');
            const [savingZaliha, setSavingZaliha] = useState(false);
            const [tipKnjizenja, setTipKnjizenja] = useState('ULAZ');

            // Otvori karticu materijala
            const openKartica = async (materijal) => {
                setKarticaMaterijal(materijal);
                setShowKartica(true);
                setLoadingPovijest(true);
                setDodajZalihuKol('');
                setDodajZalihuNapomena('');
                setTipKnjizenja('ULAZ');
                
                try {
                    const data = await apiCall(`materijal-knjizenja/${materijal.id}`, 'GET', null, userId);
                    setPovijest(data || []);
                } catch (error) {
                    console.error('Gre≈°ka pri uƒçitavanju knji≈æenja:', error);
                    setPovijest([]);
                } finally {
                    setLoadingPovijest(false);
                }
            };

            // Dodaj knji≈æenje (ULAZ ili KOREKCIJA)
            const handleDodajKnjizenje = async () => {
                const kol = parseFloat(dodajZalihuKol);
                if (!kol || kol === 0) {
                    alert('Unesi koliƒçinu!');
                    return;
                }
                
                setSavingZaliha(true);
                try {
                    const result = await apiCall('materijal-knjizenja', 'POST', {
                        materijalId: karticaMaterijal.id,
                        tip: tipKnjizenja,
                        kolicina: kol,
                        napomena: dodajZalihuNapomena
                    }, userId);
                    
                    // A≈æuriraj lokalno
                    const updatedMaterijal = { ...karticaMaterijal, zaliha: result.novaZaliha };
                    setMaterijali(materijali.map(m => m.id === karticaMaterijal.id ? updatedMaterijal : m));
                    setKarticaMaterijal(updatedMaterijal);
                    setDodajZalihuKol('');
                    setDodajZalihuNapomena('');
                    
                    // Osvje≈æi povijest
                    const data = await apiCall(`materijal-knjizenja/${karticaMaterijal.id}`, 'GET', null, userId);
                    setPovijest(data || []);
                    
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                } finally {
                    setSavingZaliha(false);
                }
            };

            // Izvuci kategorije
            const kategorije = [...new Set(materijali.map(m => m.kategorija).filter(k => k && k.trim()))].sort();

            // Filtriraj materijale
            const filteredMaterijali = materijali.filter(m => {
                const search = searchTerm.toLowerCase();
                const matchSearch = !searchTerm || 
                    (m.naziv && m.naziv.toLowerCase().includes(search)) ||
                    (m.kategorija && m.kategorija.toLowerCase().includes(search));
                const matchKategorija = !filterKategorija || m.kategorija === filterKategorija;
                return matchSearch && matchKategorija;
            });

            // Grupiraj po kategorijama
            const groupedMaterijali = filteredMaterijali.reduce((acc, m) => {
                const kat = m.kategorija || 'Bez kategorije';
                if (!acc[kat]) acc[kat] = [];
                acc[kat].push(m);
                return acc;
            }, {});

            const sortedKategorije = Object.keys(groupedMaterijali).sort((a, b) => {
                if (a === 'Bez kategorije') return 1;
                if (b === 'Bez kategorije') return -1;
                return a.localeCompare(b, 'hr');
            });

            const handleSubmit = async (e) => {
                e.preventDefault();
                setSaving(true);
                
                // Ako je upisana nova kategorija koja ne postoji, kreiraj je prvo
                let kategorijaId = null;
                if (formData.kategorija && formData.kategorija.trim()) {
                    // Provjeri postoji li kategorija
                    const postojecaKat = kategorije.find(k => k.toLowerCase() === formData.kategorija.toLowerCase());
                    
                    if (!postojecaKat) {
                        // Nova kategorija - kreiraj je
                        try {
                            const result = await apiCall('materijal-kategorije', 'POST', { 
                                naziv: formData.kategorija.trim() 
                            }, userId);
                            kategorijaId = result.id;
                        } catch (error) {
                            console.error('Gre≈°ka pri kreiranju kategorije:', error);
                        }
                    } else {
                        // Dohvati ID postojeƒáe kategorije
                        try {
                            const allKategorije = await apiCall('materijal-kategorije', 'GET', null, userId);
                            const kat = allKategorije.find(k => k.naziv.toLowerCase() === formData.kategorija.toLowerCase());
                            if (kat) kategorijaId = kat.id;
                        } catch (error) {
                            console.error('Gre≈°ka pri dohvatu kategorija:', error);
                        }
                    }
                }
                
                const data = {
                    naziv: formData.naziv,
                    kategorija: formData.kategorija,
                    kategorijaId: kategorijaId,
                    jedinicaMjere: formData.jedinicaMjere,
                    cijena: formData.cijena ? parseFloat(formData.cijena) : 0,
                    minZaliha: formData.minZaliha ? parseFloat(formData.minZaliha) : 0
                };
                
                try {
                    if (editingId) {
                        await apiCall(`materijali/${editingId}`, 'PUT', data, userId);
                        setMaterijali(materijali.map(m => m.id === editingId ? { ...data, id: editingId } : m));
                    } else {
                        const result = await apiCall('materijali', 'POST', data, userId);
                        setMaterijali([...materijali, { ...data, id: result.id }]);
                    }
                    resetForm();
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                } finally {
                    setSaving(false);
                }
            };

            const handleDelete = async (id) => {
                if (!confirm('Jeste li sigurni?')) return;
                try {
                    await apiCall(`materijali/${id}`, 'DELETE', null, userId);
                    setMaterijali(materijali.filter(m => m.id !== id));
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleEdit = async (m) => {
                // Provjeri ima li knji≈æenja za ovaj materijal
                try {
                    const knjizenja = await apiCall(`materijal-knjizenja/${m.id}`, 'GET', null, userId);
                    setHasKnjizenja(knjizenja && knjizenja.length > 0);
                } catch (e) {
                    setHasKnjizenja(false);
                }
                
                setFormData({
                    naziv: m.naziv || '',
                    kategorija: m.kategorija || '',
                    jedinicaMjere: m.jedinicaMjere || 'kom',
                    cijena: m.cijena || '',
                    zaliha: m.zaliha || '',
                    minZaliha: m.minZaliha || ''
                });
                setEditingId(m.id);
            };

            const resetForm = () => {
                setFormData({ naziv: '', kategorija: '', jedinicaMjere: 'kom', cijena: '', zaliha: '', minZaliha: '' });
                setEditingId(null);
                setHasKnjizenja(false);
                setShowForm(false);
            };

            const renderMaterijalForm = (isInline = false) => (
                <div className={isInline ? "bg-blue-50 border-2 border-blue-300 p-3" : "bg-white rounded-lg shadow-sm border p-4"}>
                    <h3 className="text-sm font-semibold mb-2">{editingId ? 'Uredi Materijal' : 'Novi Materijal'}</h3>
                    {editingId && hasKnjizenja && (
                        <div className="mb-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800">
                            ‚ö†Ô∏è Materijal ima knji≈æenja - naziv i jedinica mjere su zakljuƒçani
                        </div>
                    )}
                    <form onSubmit={handleSubmit} className="space-y-2">
                        <div className="grid grid-cols-6 gap-2">
                            <div className="col-span-2">
                                <label className="block text-xs font-medium mb-0.5">Naziv *</label>
                                <input
                                    type="text"
                                    value={formData.naziv}
                                    onChange={(e) => setFormData({ ...formData, naziv: e.target.value })}
                                    className={`w-full border rounded px-2 py-1 text-sm ${editingId && hasKnjizenja ? 'bg-gray-100 text-gray-500' : ''}`}
                                    required
                                    disabled={saving || (editingId && hasKnjizenja)}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium mb-0.5">Kategorija</label>
                                <input
                                    type="text"
                                    value={formData.kategorija}
                                    onChange={(e) => setFormData({ ...formData, kategorija: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    list="kategorije-materijala"
                                    disabled={saving}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium mb-0.5">Jed. mjere</label>
                                <input
                                    type="text"
                                    value={formData.jedinicaMjere}
                                    onChange={(e) => setFormData({ ...formData, jedinicaMjere: e.target.value })}
                                    className={`w-full border rounded px-2 py-1 text-sm ${editingId && hasKnjizenja ? 'bg-gray-100 text-gray-500' : ''}`}
                                    disabled={saving || (editingId && hasKnjizenja)}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium mb-0.5">Cijena ‚Ç¨</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    value={formData.cijena}
                                    onChange={(e) => setFormData({ ...formData, cijena: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    disabled={saving}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium mb-0.5">Min. zaliha</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    value={formData.minZaliha}
                                    onChange={(e) => setFormData({ ...formData, minZaliha: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    disabled={saving}
                                />
                            </div>
                        </div>
                        
                        {/* Datalist za autocomplete kategorija */}
                        <datalist id="kategorije-materijala">
                            {kategorije.map((kat, idx) => (
                                <option key={idx} value={kat}>{kat}</option>
                            ))}
                        </datalist>
                        
                        <div className="flex justify-end space-x-2 pt-1">
                            <button
                                type="button"
                                onClick={resetForm}
                                className="px-3 py-1 border rounded hover:bg-gray-100 text-sm"
                                disabled={saving}
                            >
                                Odustani
                            </button>
                            <button
                                type="submit"
                                className="px-3 py-1 bg-primary-600 text-white rounded hover:bg-primary-700 text-sm"
                                disabled={saving}
                            >
                                {saving ? 'Spremanje...' : 'Spremi'}
                            </button>
                        </div>
                    </form>
                </div>
            );

            return (
                <div className="space-y-3">
                    {/* Header */}
                    <div className="flex justify-between items-center gap-4">
                        <h2 className="text-xl font-semibold text-gray-800">üß± Materijali ({materijali.length})</h2>
                        <div className="flex-1 flex gap-2 max-w-xl">
                            <input
                                type="text"
                                placeholder="üîç Pretra≈æi materijale..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="flex-1 border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none"
                            />
                            <select
                                value={filterKategorija}
                                onChange={(e) => setFilterKategorija(e.target.value)}
                                className="border rounded px-3 py-2 text-sm"
                            >
                                <option value="">Sve kategorije</option>
                                {kategorije.map(k => (
                                    <option key={k} value={k}>{k}</option>
                                ))}
                            </select>
                        </div>
                        <button
                            onClick={() => { resetForm(); setShowForm(true); }}
                            className="bg-primary-600 text-white px-4 py-2 rounded hover:bg-primary-700 text-sm font-medium"
                        >
                            + Novo
                        </button>
                    </div>

                    {/* Forma za NOVI materijal - na vrhu */}
                    {showForm && !editingId && renderMaterijalForm(false)}

                    {/* Lista materijala */}
                    <div className="space-y-3">
                        {sortedKategorije.length === 0 ? (
                            <div className="bg-white rounded-lg shadow-sm border p-4 text-center text-gray-500">
                                Nema materijala
                            </div>
                        ) : (
                            sortedKategorije.map(kategorija => (
                                <div key={kategorija} className="bg-white rounded-lg shadow overflow-hidden">
                                    <div className="bg-primary-100 px-4 py-2 font-semibold text-primary-800 border-b">
                                        üß± {kategorija} ({groupedMaterijali[kategorija].length})
                                    </div>
                                    <table className="min-w-full">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-4 py-2 text-left font-medium text-gray-600 text-sm">NAZIV</th>
                                                <th className="px-4 py-2 text-left font-medium text-gray-600 text-sm w-24">JED.</th>
                                                <th className="px-4 py-2 text-right font-medium text-gray-600 text-sm w-24">CIJENA</th>
                                                <th className="px-4 py-2 text-right font-medium text-gray-600 text-sm w-28">ZALIHA</th>
                                                <th className="px-4 py-2 text-right font-medium text-gray-600 text-sm w-48">AKCIJE</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {groupedMaterijali[kategorija].map(m => (
                                                <React.Fragment key={m.id}>
                                                    <tr className={`hover:bg-primary-50 ${m.zaliha <= m.minZaliha ? 'bg-red-50' : ''}`}>
                                                        <td className="px-4 py-2 text-gray-900">
                                                            {m.naziv}
                                                            {m.zaliha <= m.minZaliha && (
                                                                <span className="ml-2 text-red-600 text-sm">‚ö†Ô∏è Niska zaliha!</span>
                                                            )}
                                                        </td>
                                                        <td className="px-4 py-2 text-gray-600">{m.jedinicaMjere || '-'}</td>
                                                        <td className="px-4 py-2 text-right text-gray-900">
                                                            {parseFloat(m.cijena || 0).toFixed(2)} ‚Ç¨
                                                        </td>
                                                        <td className="px-4 py-2 text-right text-gray-900 font-medium">
                                                            {parseFloat(m.zaliha || 0).toFixed(2)}
                                                        </td>
                                                        <td className="px-4 py-2 text-right whitespace-nowrap">
                                                            <button
                                                                onClick={() => openKartica(m)}
                                                                className="text-primary-600 hover:text-primary-800 mr-2 bg-primary-100 px-2 py-1 rounded font-medium"
                                                                title="Otvori karticu materijala"
                                                            >
                                                                üìã Kartica
                                                            </button>
                                                            <button
                                                                onClick={() => handleEdit(m)}
                                                                className="text-primary-600 hover:text-blue-900 mr-2"
                                                            >
                                                                Uredi
                                                            </button>
                                                            <button
                                                                onClick={() => handleDelete(m.id)}
                                                                className="text-red-600 hover:text-red-900"
                                                            >
                                                                Obri≈°i
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    {/* Inline edit forma */}
                                                    {editingId === m.id && (
                                                        <tr>
                                                            <td colSpan="5" className="p-0">
                                                                {renderMaterijalForm(true)}
                                                            </td>
                                                        </tr>
                                                    )}
                                                </React.Fragment>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            ))
                        )}
                    </div>

                    {/* KARTICA MATERIJALA */}
                    {showKartica && karticaMaterijal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                                {/* Header */}
                                <div className="p-4 bg-primary-600 text-white flex justify-between items-start">
                                    <div>
                                        <h3 className="text-xl font-bold">üì¶ {karticaMaterijal.naziv}</h3>
                                        <p className="text-primary-100">
                                            {karticaMaterijal.kategorija || 'Bez kategorije'} ‚Ä¢ {karticaMaterijal.jedinicaMjere}
                                        </p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button 
                                            onClick={() => {
                                                const printWindow = window.open('', '_blank');
                                                printWindow.document.write(`
                                                    <!DOCTYPE html>
                                                    <html>
                                                    <head>
                                                        <title>Kartica: ${karticaMaterijal.naziv}</title>
                                                        <style>
                                                            body { font-family: Arial, sans-serif; font-size: 10px; margin: 10px; }
                                                            h1 { font-size: 14px; margin: 0 0 5px 0; }
                                                            .info { font-size: 9px; color: #666; margin-bottom: 10px; }
                                                            .stats { display: flex; gap: 15px; margin-bottom: 10px; padding: 5px; background: #f5f5f5; }
                                                            .stat { text-align: center; }
                                                            .stat-label { font-size: 8px; color: #666; }
                                                            .stat-value { font-size: 12px; font-weight: bold; }
                                                            table { width: 100%; border-collapse: collapse; font-size: 9px; }
                                                            th, td { border: 1px solid #ccc; padding: 3px 5px; text-align: left; }
                                                            th { background: #f0f0f0; font-size: 8px; }
                                                            .right { text-align: right; }
                                                            .green { color: green; }
                                                            .red { color: red; }
                                                            .small { font-size: 8px; color: #666; }
                                                            @media print { body { margin: 5mm; } }
                                                        </style>
                                                    </head>
                                                    <body>
                                                        <h1>KARTICA MATERIJALA: ${karticaMaterijal.naziv}</h1>
                                                        <div class="info">${karticaMaterijal.kategorija || ''} | ${karticaMaterijal.jedinicaMjere} | Ispis: ${new Date().toLocaleString('hr-HR')}</div>
                                                        <div class="stats">
                                                            <div class="stat"><div class="stat-label">CIJENA</div><div class="stat-value">${parseFloat(karticaMaterijal.cijena || 0).toFixed(2)} ‚Ç¨</div></div>
                                                            <div class="stat"><div class="stat-label">ZALIHA</div><div class="stat-value">${parseFloat(karticaMaterijal.zaliha || 0).toFixed(2)}</div></div>
                                                            <div class="stat"><div class="stat-label">MIN</div><div class="stat-value">${parseFloat(karticaMaterijal.minZaliha || 0).toFixed(2)}</div></div>
                                                        </div>
                                                        <table>
                                                            <thead>
                                                                <tr>
                                                                    <th>Datum</th>
                                                                    <th>Tip</th>
                                                                    <th>Opis / Nalog / Artikl</th>
                                                                    <th>Operater</th>
                                                                    <th class="right">Koliƒçina</th>
                                                                    <th class="right">Stanje</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                ${povijest.map(p => `
                                                                    <tr>
                                                                        <td>${p.datum ? new Date(p.datum).toLocaleString('hr-HR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit'}) : '-'}</td>
                                                                        <td>${p.tip}</td>
                                                                        <td>${p.napomena || (p.nalogBroj ? p.nalogBroj + (p.artiklNaziv ? ' / ' + p.artiklNaziv : '') : '-')}${p.klijent ? '<div class="small">' + p.klijent + '</div>' : ''}</td>
                                                                        <td>${p.korisnik || '-'}</td>
                                                                        <td class="right ${parseFloat(p.kolicina) >= 0 ? 'green' : 'red'}">${parseFloat(p.kolicina) >= 0 ? '+' : ''}${parseFloat(p.kolicina).toFixed(2)}</td>
                                                                        <td class="right">${parseFloat(p.stanjePoslije).toFixed(2)}</td>
                                                                    </tr>
                                                                `).join('')}
                                                            </tbody>
                                                        </table>
                                                    </body>
                                                    </html>
                                                `);
                                                printWindow.document.close();
                                                printWindow.print();
                                            }}
                                            className="bg-white text-primary-600 px-3 py-1 rounded text-sm hover:bg-primary-100"
                                        >
                                            üñ®Ô∏è Print
                                        </button>
                                        <button 
                                            onClick={() => setShowKartica(false)}
                                            className="text-white hover:text-primary-200 text-2xl"
                                        >
                                            ‚úï
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="p-4 overflow-y-auto max-h-[75vh]">
                                    {/* Info kartice */}
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                        <div className="bg-gray-50 rounded-lg p-3 text-center">
                                            <div className="text-xs text-gray-500 uppercase">Cijena</div>
                                            <div className="text-xl font-bold text-gray-800">
                                                {parseFloat(karticaMaterijal.cijena || 0).toFixed(2)} ‚Ç¨
                                            </div>
                                        </div>
                                        <div className={`rounded-lg p-3 text-center ${parseFloat(karticaMaterijal.zaliha || 0) <= parseFloat(karticaMaterijal.minZaliha || 0) ? 'bg-red-100' : 'bg-green-100'}`}>
                                            <div className="text-xs text-gray-500 uppercase">Trenutna zaliha</div>
                                            <div className={`text-xl font-bold ${parseFloat(karticaMaterijal.zaliha || 0) <= parseFloat(karticaMaterijal.minZaliha || 0) ? 'text-red-700' : 'text-green-700'}`}>
                                                {parseFloat(karticaMaterijal.zaliha || 0).toFixed(2)} {karticaMaterijal.jedinicaMjere}
                                            </div>
                                        </div>
                                        <div className="bg-gray-50 rounded-lg p-3 text-center">
                                            <div className="text-xs text-gray-500 uppercase">Min. zaliha</div>
                                            <div className="text-xl font-bold text-gray-800">
                                                {parseFloat(karticaMaterijal.minZaliha || 0).toFixed(2)} {karticaMaterijal.jedinicaMjere}
                                            </div>
                                        </div>
                                        <div className="bg-primary-50 rounded-lg p-3 text-center">
                                            <div className="text-xs text-gray-500 uppercase">Ukupno utro≈°eno</div>
                                            <div className="text-xl font-bold text-primary-700">
                                                {povijest.filter(p => !p.stornirano).reduce((sum, p) => sum + parseFloat(p.kolicina || 0), 0).toFixed(2)} {karticaMaterijal.jedinicaMjere}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Novo knji≈æenje */}
                                    <div className="bg-primary-50 border border-blue-200 rounded-lg p-4 mb-6">
                                        <h4 className="font-bold text-primary-800 mb-3">üìù Novo knji≈æenje</h4>
                                        <div className="flex gap-3 items-end flex-wrap">
                                            <div className="w-36">
                                                <label className="block text-xs text-gray-600 mb-1">Tip</label>
                                                <select
                                                    value={tipKnjizenja}
                                                    onChange={(e) => setTipKnjizenja(e.target.value)}
                                                    className="w-full border rounded px-3 py-2"
                                                >
                                                    <option value="ULAZ">‚ûï ULAZ (nabava)</option>
                                                    <option value="KOREKCIJA">üîß KOREKCIJA</option>
                                                </select>
                                            </div>
                                            <div className="w-32">
                                                <label className="block text-xs text-gray-600 mb-1">Koliƒçina</label>
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    value={dodajZalihuKol}
                                                    onChange={(e) => setDodajZalihuKol(e.target.value)}
                                                    className="w-full border rounded px-3 py-2"
                                                    placeholder={tipKnjizenja === 'KOREKCIJA' ? '+/- kol.' : 'Koliƒçina'}
                                                />
                                            </div>
                                            <div className="flex-1 min-w-48">
                                                <label className="block text-xs text-gray-600 mb-1">Napomena</label>
                                                <input
                                                    type="text"
                                                    value={dodajZalihuNapomena}
                                                    onChange={(e) => setDodajZalihuNapomena(e.target.value)}
                                                    className="w-full border rounded px-3 py-2"
                                                    placeholder={tipKnjizenja === 'ULAZ' ? 'Dobavljaƒç, br. raƒçuna...' : 'Razlog korekcije...'}
                                                />
                                            </div>
                                            <button
                                                onClick={handleDodajKnjizenje}
                                                disabled={savingZaliha || !dodajZalihuKol}
                                                className={`px-6 py-2 text-white rounded font-medium disabled:opacity-50 ${tipKnjizenja === 'ULAZ' ? 'bg-green-600 hover:bg-green-700' : 'bg-yellow-600 hover:bg-yellow-700'}`}
                                            >
                                                {savingZaliha ? '‚è≥' : 'Spremi'}
                                            </button>
                                        </div>
                                        {dodajZalihuKol && (
                                            <div className={`mt-2 text-sm ${parseFloat(dodajZalihuKol) >= 0 ? 'text-green-700' : 'text-red-700'}`}>
                                                Nova zaliha ƒáe biti: <span className="font-bold">
                                                    {(parseFloat(karticaMaterijal.zaliha || 0) + parseFloat(dodajZalihuKol || 0)).toFixed(2)} {karticaMaterijal.jedinicaMjere}
                                                </span>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Povijest knji≈æenja */}
                                    <div>
                                        <h4 className="font-bold text-primary-800 mb-3">üìã Knji≈æenja materijala</h4>
                                        {loadingPovijest ? (
                                            <div className="text-center py-8 text-gray-500">Uƒçitavanje...</div>
                                        ) : povijest.length === 0 ? (
                                            <div className="text-center py-8 text-gray-400 bg-gray-50 rounded-lg">
                                                Nema knji≈æenja za ovaj materijal
                                            </div>
                                        ) : (
                                            <table className="w-full text-sm border">
                                                <thead className="bg-primary-100">
                                                    <tr>
                                                        <th className="px-2 py-2 text-left">Datum</th>
                                                        <th className="px-2 py-2 text-center">Tip</th>
                                                        <th className="px-2 py-2 text-left">Opis / Nalog / Artikl</th>
                                                        <th className="px-2 py-2 text-right">Koliƒçina</th>
                                                        <th className="px-2 py-2 text-right">Stanje</th>
                                                        <th className="px-2 py-2 text-center w-20">Akcije</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y">
                                                    {povijest.map((p, idx) => (
                                                        <tr key={idx} className="hover:bg-primary-50">
                                                            <td className="px-2 py-2 text-gray-600 text-xs">
                                                                {p.datum ? new Date(p.datum).toLocaleString('hr-HR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'}) : '-'}
                                                                <div className="text-gray-400">{p.datum ? new Date(p.datum).toLocaleTimeString('hr-HR', {hour: '2-digit', minute: '2-digit', second: '2-digit'}) : ''}</div>
                                                                {p.korisnik && <div className="text-[10px] text-blue-500">{p.korisnik}</div>}
                                                            </td>
                                                            <td className="px-2 py-2 text-center">
                                                                {p.tip === 'ULAZ' && <span className="inline-block px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded font-medium">‚ûï ULAZ</span>}
                                                                {p.tip === 'IZLAZ' && <span className="inline-block px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded font-medium">‚ûñ IZLAZ</span>}
                                                                {p.tip === 'KOREKCIJA' && <span className="inline-block px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded font-medium">üîß KOR.</span>}
                                                                {p.tip === 'STORNO' && <span className="inline-block px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded font-medium">‚Ü©Ô∏è STORNO</span>}
                                                            </td>
                                                            <td className="px-2 py-2">
                                                                {p.napomena ? (
                                                                    <div>
                                                                        <span className="font-medium">{p.napomena}</span>
                                                                        {p.klijent && <div className="text-xs text-gray-400">{p.klijent}</div>}
                                                                    </div>
                                                                ) : p.nalogBroj ? (
                                                                    <div>
                                                                        <span className="font-medium">{p.nalogBroj}</span>
                                                                        {p.artiklNaziv && (
                                                                            <span className="text-xs text-purple-600 ml-1">
                                                                                / {p.artiklNaziv}
                                                                                {p.artiklKolicina && <span className="text-gray-500"> ({p.artiklKolicina} {p.artiklJedinica || 'kom'})</span>}
                                                                            </span>
                                                                        )}
                                                                        {p.klijent && <div className="text-xs text-gray-400">{p.klijent}</div>}
                                                                    </div>
                                                                ) : (
                                                                    <span className="text-gray-500">-</span>
                                                                )}
                                                            </td>
                                                            <td className={`px-2 py-2 text-right font-bold ${p.kolicina >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                                {p.kolicina >= 0 ? '+' : ''}{parseFloat(p.kolicina).toFixed(2)}
                                                            </td>
                                                            <td className="px-2 py-2 text-right text-gray-600">
                                                                {parseFloat(p.stanjePoslije).toFixed(2)}
                                                            </td>
                                                            <td className="px-2 py-2 text-center">
                                                                {(p.tip === 'ULAZ' || p.tip === 'KOREKCIJA') && (
                                                                    <button
                                                                        onClick={async () => {
                                                                            if (!confirm(`Stornirati ${p.tip} od ${parseFloat(p.kolicina).toFixed(2)}?`)) return;
                                                                            try {
                                                                                await apiCall('materijal-knjizenja', 'POST', {
                                                                                    materijalId: karticaMaterijal.id,
                                                                                    tip: 'STORNO',
                                                                                    kolicina: -parseFloat(p.kolicina),
                                                                                    napomena: `Storno ${p.tip}: ${p.napomena || ''}`
                                                                                }, userId);
                                                                                // Osvje≈æi
                                                                                const data = await apiCall(`materijal-knjizenja/${karticaMaterijal.id}`, 'GET', null, userId);
                                                                                setPovijest(data || []);
                                                                                const freshMat = await apiCall('materijali', 'GET', null, userId);
                                                                                setMaterijali(freshMat);
                                                                                const updMat = freshMat.find(x => x.id === karticaMaterijal.id);
                                                                                if (updMat) setKarticaMaterijal(updMat);
                                                                            } catch (error) {
                                                                                alert('Gre≈°ka: ' + error.message);
                                                                            }
                                                                        }}
                                                                        className="text-purple-600 hover:text-purple-800 text-xs"
                                                                        title="Storniraj"
                                                                    >
                                                                        ‚Ü©Ô∏è Storno
                                                                    </button>
                                                                )}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Footer */}
                                <div className="p-3 bg-gray-50 border-t flex justify-between">
                                    <button
                                        onClick={() => {
                                            const mat = karticaMaterijal;
                                            const imaKnjizenja = povijest && povijest.length > 0;
                                            setShowKartica(false);
                                            setKarticaMaterijal(null);
                                            // Otvori formu za ureƒëivanje
                                            setFormData({
                                                naziv: mat.naziv || '',
                                                kategorija: mat.kategorija || '',
                                                jedinicaMjere: mat.jedinicaMjere || 'kom',
                                                cijena: mat.cijena || '',
                                                minZaliha: mat.minZaliha || ''
                                            });
                                            setEditingId(mat.id);
                                            setHasKnjizenja(imaKnjizenja);
                                            setShowForm(true);
                                        }}
                                        className="px-4 py-2 bg-primary-600 text-white rounded hover:bg-primary-700"
                                    >
                                        ‚úèÔ∏è Uredi podatke
                                    </button>
                                    <button
                                        onClick={() => setShowKartica(false)}
                                        className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
                                    >
                                        Zatvori
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // KorisniciTab komponenta (samo za admina)
        function KorisniciTab({ korisnici, setKorisnici, currentUser, userId }) {
            const [showForm, setShowForm] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [saving, setSaving] = useState(false);
            const [formData, setFormData] = useState({
                ime: '',
                prezime: '',
                korisnickoIme: '',
                lozinka: '',
                uloga: 'radnik'
            });

            const handleSubmit = async (e) => {
                e.preventDefault();
                setSaving(true);
                
                try {
                    if (editingId) {
                        await apiCall(`korisnici/${editingId}`, 'PUT', formData, userId);
                        setKorisnici(korisnici.map(k => k.id === editingId ? { ...formData, id: editingId } : k));
                    } else {
                        const result = await apiCall('korisnici', 'POST', formData, userId);
                        setKorisnici([...korisnici, { ...formData, id: result.id }]);
                    }
                    resetForm();
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                } finally {
                    setSaving(false);
                }
            };

            const handleDelete = async (id) => {
                if (id === currentUser.id) {
                    alert('Ne mo≈æete obrisati sami sebe!');
                    return;
                }
                if (!confirm('Jeste li sigurni?')) return;
                
                try {
                    await apiCall(`korisnici/${id}`, 'DELETE', null, userId);
                    setKorisnici(korisnici.filter(k => k.id !== id));
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleEdit = (korisnik) => {
                setFormData({...korisnik, lozinka: ''});
                setEditingId(korisnik.id);
                setShowForm(true);
            };

            const resetForm = () => {
                setFormData({ ime: '', prezime: '', korisnickoIme: '', lozinka: '', uloga: 'radnik' });
                setEditingId(null);
                setShowForm(false);
            };

            return (
                <div className="space-y-4">
                    <div className="flex justify-between items-center">
                        <h2 className="text-xl font-semibold text-gray-800">üîê Korisnici</h2>
                        <button
                            onClick={() => setShowForm(true)}
                            className="bg-primary-600 text-white px-4 py-2 rounded hover:bg-primary-700 text-sm font-medium"
                        >
                            + Novo
                        </button>
                    </div>

                    {showForm && (
                        <div className="bg-white rounded-lg shadow-sm border p-6">
                            <h3 className="text-lg font-semibold mb-4">{editingId ? 'Uredi Korisnika' : 'Novi Korisnik'}</h3>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Ime *</label>
                                        <input
                                            type="text"
                                            value={formData.ime}
                                            onChange={(e) => setFormData({ ...formData, ime: e.target.value })}
                                            className="w-full border rounded-lg px-3 py-2"
                                            required
                                            disabled={saving}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Prezime *</label>
                                        <input
                                            type="text"
                                            value={formData.prezime}
                                            onChange={(e) => setFormData({ ...formData, prezime: e.target.value })}
                                            className="w-full border rounded-lg px-3 py-2"
                                            required
                                            disabled={saving}
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Korisniƒçko ime *</label>
                                    <input
                                        type="text"
                                        value={formData.korisnickoIme}
                                        onChange={(e) => setFormData({ ...formData, korisnickoIme: e.target.value })}
                                        className="w-full border rounded-lg px-3 py-2"
                                        required
                                        disabled={saving}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">
                                        Lozinka {editingId ? '(ostavi prazno da ne mijenjate)' : '*'}
                                    </label>
                                    <input
                                        type="password"
                                        value={formData.lozinka}
                                        onChange={(e) => setFormData({ ...formData, lozinka: e.target.value })}
                                        className="w-full border rounded-lg px-3 py-2"
                                        required={!editingId}
                                        disabled={saving}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Uloga *</label>
                                    <select
                                        value={formData.uloga}
                                        onChange={(e) => setFormData({ ...formData, uloga: e.target.value })}
                                        className="w-full border rounded-lg px-3 py-2"
                                        required
                                        disabled={saving}
                                    >
                                        <option value="radnik">Radnik</option>
                                        <option value="admin">Administrator</option>
                                    </select>
                                </div>
                                <div className="flex justify-end space-x-2">
                                    <button
                                        type="button"
                                        onClick={resetForm}
                                        className="px-4 py-2 border rounded-lg hover:bg-gray-100"
                                        disabled={saving}
                                    >
                                        Odustani
                                    </button>
                                    <button
                                        type="submit"
                                        className="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50"
                                        disabled={saving}
                                    >
                                        {saving ? 'Spremanje...' : 'Spremi'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ime</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Korisniƒçko ime</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Uloga</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Akcije</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {korisnici.length === 0 ? (
                                    <tr>
                                        <td colSpan="4" className="px-6 py-4 text-center text-gray-500">
                                            Nema korisnika
                                        </td>
                                    </tr>
                                ) : (
                                    korisnici.map(korisnik => (
                                        <tr key={korisnik.id} className="hover:bg-gray-50">
                                            <td className="px-6 py-4 font-medium">{korisnik.ime} {korisnik.prezime}</td>
                                            <td className="px-6 py-4">{korisnik.korisnickoIme}</td>
                                            <td className="px-6 py-4">
                                                <span className={`px-2 py-1 text-xs rounded ${korisnik.uloga === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}`}>
                                                    {korisnik.uloga === 'admin' ? 'Admin' : 'Radnik'}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 text-right text-sm">
                                                <button
                                                    onClick={() => handleEdit(korisnik)}
                                                    className="text-primary-600 hover:text-blue-900 mr-3"
                                                >
                                                    Uredi
                                                </button>
                                                {korisnik.id !== currentUser.id && (
                                                    <button
                                                        onClick={() => handleDelete(korisnik.id)}
                                                        className="text-red-600 hover:text-red-900"
                                                    >
                                                        Obri≈°i
                                                    </button>
                                                )}
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // RadniNaloziTab komponenta  - Pojednostavljena verzija
        // ZavrseniNaloziTab komponenta - sa moguƒáno≈°ƒáu ureƒëivanja
        function ZavrseniNaloziTab({ radniNalozi, setRadniNalozi, kupci, artikli, postupci, userId }) {
            const [viewingNalog, setViewingNalog] = useState(null);
            const [expandedRows, setExpandedRows] = useState([]);
            const [loadingRows, setLoadingRows] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [saving, setSaving] = useState(false);
            const [formData, setFormData] = useState({
                broj: '',
                nazivNaloga: '',
                datum: new Date().toISOString().split('T')[0],
                rokIzrade: '',
                klijentId: '',
                klijentNaziv: '',
                kontaktOsoba: '',
                telefon: '',
                email: '',
                opisProblema: '',
                brojRacuna: '',
                status: 'zavrsen',
                artikli: [],
                postupci: []
            });

            // Print otpremnica/predraƒçun
            const printOtpremnica = (nalog) => {
                const ukupnoBezPDV = (nalog.artikli || []).reduce((sum, a) => sum + (parseFloat(a.cijena || 0) * parseFloat(a.kolicina || 0)), 0);
                const pdv = ukupnoBezPDV * 0.25;
                const ukupnoSaPDV = ukupnoBezPDV + pdv;
                
                let artikliRows = '';
                (nalog.artikli || []).forEach(art => {
                    const cijenaBezPDV = parseFloat(art.cijena) || 0;
                    const kol = parseFloat(art.kolicina) || 0;
                    const pdvIznos = cijenaBezPDV * 0.25;
                    const cijenaSaPDV = cijenaBezPDV + pdvIznos;
                    const vrijednost = cijenaSaPDV * kol;
                    const napomena = [art.format, art.opis].filter(Boolean).join(' - ');
                    
                    artikliRows += '<tr><td>' + 
                        (art.sifra ? '<span style="color:#666;">(' + art.sifra + ')</span> ' : '') +
                        '<strong>' + (art.naziv || '') + '</strong>' + 
                        (art.kpdSifra ? '<div style="font-size:8px;color:#888;">KPD: ' + art.kpdSifra + '</div>' : '') +
                        (napomena ? '<div class="napomena">' + napomena + '</div>' : '') +
                        '</td><td class="right">' + kol.toFixed(2) + ' ' + (art.jedinica || 'kom') + 
                        '</td><td class="right">' + cijenaBezPDV.toFixed(2) + 
                        '</td><td class="right">' + pdvIznos.toFixed(2) + ' (25%)' +
                        '</td><td class="right">' + cijenaSaPDV.toFixed(2) + 
                        '</td><td class="right">' + vrijednost.toFixed(2) + '</td></tr>';
                });
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(
                    '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Otpremnica ' + nalog.broj + '</title>' +
                    '<style>' +
                    '* { margin: 0; padding: 0; box-sizing: border-box; }' +
                    'body { font-family: Arial, sans-serif; font-size: 11px; padding: 15mm; color: #333; }' +
                    '.header { display: flex; justify-content: space-between; margin-bottom: 20px; }' +
                    '.logo { font-size: 24px; font-weight: bold; }' +
                    '.logo-sub { font-size: 10px; color: #666; }' +
                    '.company-info { font-size: 9px; line-height: 1.4; }' +
                    '.document-title { font-size: 22px; font-weight: bold; text-align: center; margin: 20px 0 10px 0; }' +
                    '.client-box { border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; min-height: 80px; }' +
                    '.client-name { font-weight: bold; font-size: 13px; margin-bottom: 5px; }' +
                    '.doc-info { margin-bottom: 15px; }' +
                    '.doc-info-row { display: flex; margin-bottom: 3px; }' +
                    '.doc-info-label { width: 100px; font-weight: bold; }' +
                    'table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }' +
                    'th { background: #f5f5f5; border: 1px solid #ccc; padding: 8px 5px; text-align: left; font-size: 10px; font-weight: bold; }' +
                    'td { border: 1px solid #ccc; padding: 6px 5px; vertical-align: top; }' +
                    '.right { text-align: right; }' +
                    '.napomena { font-size: 9px; color: #555; font-style: italic; margin-top: 3px; }' +
                    '.totals { margin-left: auto; width: 250px; }' +
                    '.total-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #eee; }' +
                    '.total-row.final { font-weight: bold; font-size: 14px; border-bottom: 2px solid #333; border-top: 2px solid #333; padding: 8px 0; }' +
                    '.footer { margin-top: 30px; font-size: 9px; }' +
                    '.signatures { display: flex; justify-content: space-between; margin-top: 40px; }' +
                    '.signature-box { width: 200px; text-align: center; }' +
                    '.signature-line { border-top: 1px solid #333; margin-top: 40px; padding-top: 5px; }' +
                    '.footer-note { font-size: 8px; color: #666; text-align: center; margin-top: 20px; padding-top: 10px; border-top: 1px solid #eee; }' +
                    '.contact-footer { text-align: center; font-size: 8px; color: #666; margin-top: 10px; }' +
                    '@media print { body { padding: 10mm; } @page { margin: 10mm; } }' +
                    '</style></head><body>' +
                    '<div class="header"><div>' +
                    '<div class="logo">SIGNALprint</div>' +
                    '<div class="logo-sub">trgovina, usluge, proizvodnja</div>' +
                    '<div class="company-info" style="margin-top: 5px;">vl. Tihomir Borovƒçak<br>Naselje Borovƒçaki 8<br>HR-49210 Zabok<br><br>OIB 52276562396<br><br>IBAN ZABA: HR8923600001101163526<br>IBAN PBZ: HR7723400091160234176</div>' +
                    '</div><div style="text-align: right;"><div class="client-box">' +
                    '<div class="client-name">' + (nalog.klijentNaziv || '') + '</div>' +
                    (nalog.kontaktOsoba ? '<div>' + nalog.kontaktOsoba + '</div>' : '') +
                    (nalog.telefon ? '<div>Tel: ' + nalog.telefon + '</div>' : '') +
                    (nalog.email ? '<div>' + nalog.email + '</div>' : '') +
                    '</div></div></div>' +
                    '<div class="document-title">OTPREMNICA</div>' +
                    '<div style="display: flex; justify-content: space-between;"><div class="doc-info">' +
                    '<div class="doc-info-row"><span class="doc-info-label">BROJ:</span> <span>' + nalog.broj + '</span></div>' +
                    '<div class="doc-info-row"><span class="doc-info-label">Mjesto:</span> <span>Zabok</span></div>' +
                    '<div class="doc-info-row"><span class="doc-info-label">Datum:</span> <span>' + new Date(nalog.datum).toLocaleDateString('hr-HR') + '</span></div>' +
                    (nalog.rokIzrade ? '<div class="doc-info-row"><span class="doc-info-label">Rok izrade:</span> <span>' + new Date(nalog.rokIzrade).toLocaleDateString('hr-HR') + '</span></div>' : '') +
                    '</div><div class="doc-info">' +
                    (nalog.brojRacuna ? '<div class="doc-info-row"><span class="doc-info-label">Broj raƒçuna:</span> <span>' + nalog.brojRacuna + '</span></div>' : '') +
                    '<div class="doc-info-row"><span class="doc-info-label">Naziv:</span> <span>' + (nalog.nazivNaloga || '') + '</span></div>' +
                    '</div></div>' +
                    '<table><thead><tr>' +
                    '<th style="width: 40%;">Vrsta robe odnosno usluga</th>' +
                    '<th class="right" style="width: 12%;">Koliƒçina</th>' +
                    '<th class="right" style="width: 12%;">Cijena</th>' +
                    '<th class="right" style="width: 12%;">PDV</th>' +
                    '<th class="right" style="width: 12%;">Cijena + PDV</th>' +
                    '<th class="right" style="width: 12%;">Vrijednost EUR</th>' +
                    '</tr></thead><tbody>' + artikliRows + '</tbody></table>' +
                    '<div class="totals">' +
                    '<div class="total-row"><span>Ukupno:</span><span>' + ukupnoBezPDV.toFixed(2) + '</span></div>' +
                    '<div class="total-row"><span>PDV 25,00% od ' + ukupnoBezPDV.toFixed(2) + ':</span><span>' + pdv.toFixed(2) + '</span></div>' +
                    '<div class="total-row final"><span>Ukupno EUR:</span><span>' + ukupnoSaPDV.toFixed(2) + '</span></div>' +
                    '</div>' +
                    '<div class="footer"><p>Odgovorna osoba: Tihomir Borovƒçak</p></div>' +
                    '<div class="signatures">' +
                    '<div class="signature-box"><div>Operater:</div><div class="signature-line">_______________________</div></div>' +
                    '<div class="signature-box"><div>Preuzeo:</div><div class="signature-line">_______________________</div></div>' +
                    '</div>' +
                    '<div class="footer-note">Dokument je pravovaljan bez peƒçata i potpisa jer je ispisan elektroniƒçkim putem.</div>' +
                    '<div class="contact-footer">TEL: 049/500-005, E-MAIL: info@signalprint.hr, WEB: www.signalprint.hr, FB: signal.print.zabok, IG: signalprint_zabok</div>' +
                    '</body></html>'
                );
                printWindow.document.close();
                printWindow.print();
            };

            // Filtriraj samo zavr≈°ene naloge koji imaju broj raƒçuna
            const zavrseniNalozi = radniNalozi.filter(nalog => 
                nalog.status === 'zavrsen' && nalog.brojRacuna && nalog.brojRacuna.trim() !== ''
            );

            const toggleRow = async (id) => {
                if (expandedRows.includes(id)) {
                    setExpandedRows(prev => prev.filter(rowId => rowId !== id));
                } else {
                    const nalog = radniNalozi.find(n => n.id === id);
                    if (nalog && (!nalog.artikli || !nalog.postupci)) {
                        setLoadingRows(prev => [...prev, id]);
                        try {
                            const fullNalog = await apiCall(`nalozi/${id}`, 'GET', null, userId);
                            setRadniNalozi(prev => prev.map(n => 
                                n.id === id ? { ...n, artikli: fullNalog.artikli, postupci: fullNalog.postupci } : n
                            ));
                        } catch (error) {
                            console.error('Gre≈°ka pri uƒçitavanju detalja naloga:', error);
                        } finally {
                            setLoadingRows(prev => prev.filter(rowId => rowId !== id));
                        }
                    }
                    setExpandedRows(prev => [...prev, id]);
                }
            };

            const handleView = async (nalog) => {
                try {
                    const completeNalog = await apiCall(`nalozi/${nalog.id}`, 'GET', null, userId);
                    setViewingNalog(completeNalog);
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleEdit = async (nalog) => {
                try {
                    const completeNalog = await apiCall(`nalozi/${nalog.id}`, 'GET', null, userId);
                    
                    // Izraƒçunaj ukupnaCijena za svaki artikl
                    const artikliSaUkupnom = (completeNalog.artikli || []).map(art => ({
                        ...art,
                        ukupnaCijena: (parseFloat(art.kolicina) || 0) * (parseFloat(art.cijena) || 0)
                    }));
                    
                    setFormData({
                        broj: completeNalog.broj,
                        nazivNaloga: completeNalog.nazivNaloga || '',
                        datum: completeNalog.datum,
                        rokIzrade: completeNalog.rokIzrade,
                        klijentId: completeNalog.klijentId,
                        klijentNaziv: completeNalog.klijentNaziv,
                        kontaktOsoba: completeNalog.kontaktOsoba || '',
                        telefon: completeNalog.telefon || '',
                        email: completeNalog.email || '',
                        opisProblema: completeNalog.opisProblema,
                        brojRacuna: completeNalog.brojRacuna || '',
                        status: completeNalog.status,
                        artikli: artikliSaUkupnom,
                        postupci: completeNalog.postupci || []
                    });
                    setEditingId(nalog.id);
                    setShowForm(true);
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleDelete = async (id) => {
                if (!confirm('Jeste li sigurni da ≈æelite obrisati ovaj nalog?')) return;
                try {
                    await apiCall(`nalozi/${id}`, 'DELETE', null, userId);
                    setRadniNalozi(radniNalozi.filter(n => n.id !== id));
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                // Validacija - mora imati klijenta (u zavr≈°enim nalozima klijent je uvijek zakljuƒçan)
                if (!formData.klijentNaziv) {
                    alert('Nalog nema klijenta!');
                    return;
                }
                
                // Validacija - mora imati barem jedan artikl
                if (!formData.artikli || formData.artikli.length === 0) {
                    alert('Morate dodati barem jedan artikl!');
                    return;
                }
                
                // Provjeri da svi artikli imaju naziv
                const artiklBezNaziva = formData.artikli.find(a => !a.naziv && !a.artiklId);
                if (artiklBezNaziva) {
                    alert('Svi artikli moraju imati naziv!');
                    return;
                }
                
                setSaving(true);
                
                const artikliZaSpremanje = formData.artikli.map(a => {
                    const { ukupnaCijena, ...artiklBezUkupne } = a;
                    return artiklBezUkupne;
                });
                
                const nalogData = {
                    broj: formData.broj,
                    nazivNaloga: formData.nazivNaloga,
                    datum: formData.datum,
                    rokIzrade: formData.rokIzrade,
                    klijentId: formData.klijentId,
                    klijentNaziv: formData.klijentNaziv,
                    kontaktOsoba: formData.kontaktOsoba,
                    telefon: formData.telefon,
                    email: formData.email,
                    opisProblema: formData.opisProblema,
                    brojRacuna: formData.brojRacuna,
                    status: formData.status,
                    artikli: artikliZaSpremanje,
                    postupci: formData.postupci
                };
                
                try {
                    await apiCall(`nalozi/${editingId}`, 'PUT', nalogData, userId);
                    const updated = await apiCall(`nalozi/${editingId}`, 'GET', null, userId);
                    const klijent = kupci.find(k => k.id == updated.klijentId);
                    const updatedSaKontaktom = {
                        ...updated,
                        kontaktOsoba: klijent?.kontakt || updated.kontaktOsoba || '',
                        telefon: klijent?.telefon || updated.telefon || '',
                        email: klijent?.email || updated.email || ''
                    };
                    setRadniNalozi(radniNalozi.map(n => n.id === editingId ? updatedSaKontaktom : n));
                    resetForm();
                    setShowForm(false);
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                } finally {
                    setSaving(false);
                }
            };

            const resetForm = () => {
                setFormData({
                    broj: '',
                    nazivNaloga: '',
                    datum: new Date().toISOString().split('T')[0],
                    rokIzrade: '',
                    klijentId: '',
                    klijentNaziv: '',
                    kontaktOsoba: '',
                    telefon: '',
                    email: '',
                    opisProblema: '',
                    brojRacuna: '',
                    status: 'zavrsen',
                    artikli: [],
                    postupci: []
                });
                setEditingId(null);
            };

            const handleKlijentChange = (klijentId) => {
                const klijent = kupci.find(k => String(k.id) === String(klijentId));
                if (klijent) {
                    setFormData({
                        ...formData,
                        klijentId: klijent.id,
                        klijentNaziv: klijent.naziv,
                        kontaktOsoba: klijent.kontakt || '',
                        telefon: klijent.telefon || '',
                        email: klijent.email || ''
                    });
                }
            };

            const addArtikl = () => {
                setFormData({
                    ...formData,
                    artikli: [...formData.artikli, { artiklId: '', naziv: '', kolicina: 1, cijena: 0, ukupnaCijena: 0, format: '', opis: '', napomena: '' }]
                });
            };

            const removeArtikl = async (index) => {
                const artikl = formData.artikli[index];
                
                // Provjeri ima li artikl spremljene materijale (s id-em)
                const spremljeniMaterijali = (artikl.materijali || []).filter(m => m.id);
                
                if (spremljeniMaterijali.length > 0) {
                    if (!confirm(`Artikl "${artikl.naziv}" ima ${spremljeniMaterijali.length} utro≈°enih materijala.\n\nMaknuti artikl i vratiti materijale na zalihu?`)) {
                        return;
                    }
                    
                    // Storniraj sve materijale ovog artikla
                    for (const mat of spremljeniMaterijali) {
                        try {
                            await apiCall(`nalog-materijali/${mat.id}`, 'DELETE', null, userId);
                        } catch (error) {
                            console.error('Gre≈°ka pri storniranju materijala:', error);
                        }
                    }
                    
                    // Osvje≈æi listu materijala
                    const freshMaterijali = await apiCall('materijali', 'GET', null, userId);
                    setMaterijali(freshMaterijali);
                }
                
                // Makni artikl iz liste
                setFormData({
                    ...formData,
                    artikli: formData.artikli.filter((_, i) => i !== index)
                });
            };

            const updateArtikl = (index, field, value) => {
                const updated = [...formData.artikli];
                updated[index][field] = value;
                
                if (field === 'artiklId') {
                    const artikl = artikli.find(a => a.id == value);
                    if (artikl) {
                        updated[index].naziv = artikl.naziv;
                        updated[index].cijena = artikl.cijena || 0;
                        const kolicina = parseFloat(updated[index].kolicina) || 1;
                        updated[index].ukupnaCijena = kolicina * (parseFloat(artikl.cijena) || 0);
                    }
                }
                
                if (field === 'ukupnaCijena') {
                    const kolicina = parseFloat(updated[index].kolicina) || 1;
                    const ukupna = parseFloat(value) || 0;
                    updated[index].cijena = kolicina > 0 ? (ukupna / kolicina).toFixed(2) : 0;
                }
                
                if (field === 'kolicina') {
                    const ukupna = parseFloat(updated[index].ukupnaCijena) || 0;
                    const kolicina = parseFloat(value) || 1;
                    updated[index].cijena = kolicina > 0 ? (ukupna / kolicina).toFixed(2) : 0;
                }
                
                setFormData({ ...formData, artikli: updated });
            };

            const addPostupak = () => {
                setFormData({
                    ...formData,
                    postupci: [...formData.postupci, { postupakId: '', naziv: '', kolicina: 1, cijena: 0, trajanjeMin: '' }]
                });
            };

            const removePostupak = (index) => {
                setFormData({
                    ...formData,
                    postupci: formData.postupci.filter((_, i) => i !== index)
                });
            };

            const updatePostupak = (index, field, value) => {
                const updated = [...formData.postupci];
                if (field === 'postupakId') {
                    const postupak = postupci.find(p => p.id == value);
                    updated[index] = {
                        ...updated[index],
                        postupakId: value,
                        naziv: postupak ? postupak.naziv : '',
                        cijena: postupak && postupak.defaultCijena ? parseFloat(postupak.defaultCijena) : updated[index].cijena
                    };
                } else {
                    updated[index] = { ...updated[index], [field]: value };
                }
                setFormData({ ...formData, postupci: updated });
            };

            const getUkupnaCijenaPostupaka = (postupciList) => {
                if (!postupciList || postupciList.length === 0) return 0;
                return postupciList.reduce((sum, p) => {
                    const cijena = parseFloat(p.cijena) || 0;
                    const kolicina = parseFloat(p.kolicina) || 1;
                    return sum + (cijena * kolicina);
                }, 0);
            };

            const getUkupnaCijena = (nalog) => {
                if (!nalog.artikli || nalog.artikli.length === 0) return 0;
                return nalog.artikli.reduce((sum, art) => {
                    const cijena = parseFloat(art.cijena) || 0;
                    const kolicina = parseFloat(art.kolicina) || 0;
                    return sum + (cijena * kolicina);
                }, 0);
            };

            return (
                <div className="space-y-4">
                    <div className="flex justify-between items-center">
                        <h2 className="text-xl font-semibold text-gray-800">‚úÖ Zavr≈°eni Nalozi</h2>
                        <div className="text-sm text-gray-600">
                            Ukupno zavr≈°enih naloga s raƒçunom: {zavrseniNalozi.length}
                        </div>
                    </div>

                    {showForm && (
                        <div className="bg-white rounded-lg shadow-sm border p-6">
                            <h3 className="text-lg font-semibold mb-4">Uredi Zavr≈°eni Nalog</h3>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Broj *</label>
                                        <input
                                            type="text"
                                            value={formData.broj}
                                            className="w-full border rounded-lg px-3 py-2 bg-gray-100"
                                            required
                                            disabled
                                            readOnly
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Naziv naloga</label>
                                        <input
                                            type="text"
                                            value={formData.nazivNaloga}
                                            onChange={(e) => setFormData({ ...formData, nazivNaloga: e.target.value })}
                                            className="w-full border rounded-lg px-3 py-2"
                                            placeholder="Kratki naziv naloga"
                                            disabled={saving}
                                        />
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Datum *</label>
                                        <input
                                            type="date"
                                            value={formData.datum}
                                            onChange={(e) => setFormData({ ...formData, datum: e.target.value })}
                                            className="w-full border rounded-lg px-3 py-2"
                                            required
                                            disabled={saving}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Rok izrade</label>
                                        <input
                                            type="date"
                                            value={formData.rokIzrade}
                                            onChange={(e) => setFormData({ ...formData, rokIzrade: e.target.value })}
                                            className="w-full border rounded-lg px-3 py-2"
                                            disabled={saving}
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Klijent *</label>
                                    <div className="w-full border rounded-lg px-3 py-2 bg-gray-100 text-gray-700">
                                        {formData.klijentNaziv || 'Nije odabran'}
                                    </div>
                                </div>

                                <div className="grid grid-cols-3 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Kontakt osoba</label>
                                        <input
                                            type="text"
                                            value={formData.kontaktOsoba}
                                            onChange={(e) => setFormData({ ...formData, kontaktOsoba: e.target.value })}
                                            className="w-full border rounded-lg px-3 py-2"
                                            disabled={saving}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Telefon</label>
                                        <input
                                            type="text"
                                            value={formData.telefon}
                                            onChange={(e) => setFormData({ ...formData, telefon: e.target.value })}
                                            className="w-full border rounded-lg px-3 py-2"
                                            disabled={saving}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Email</label>
                                        <input
                                            type="email"
                                            value={formData.email}
                                            onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                                            className="w-full border rounded-lg px-3 py-2"
                                            disabled={saving}
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Opis problema</label>
                                    <textarea
                                        value={formData.opisProblema}
                                        onChange={(e) => setFormData({ ...formData, opisProblema: e.target.value })}
                                        className="w-full border rounded-lg px-3 py-2"
                                        rows="3"
                                        disabled={saving}
                                    ></textarea>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Status *</label>
                                        <select
                                            value={formData.status}
                                            onChange={(e) => setFormData({ ...formData, status: e.target.value })}
                                            className="w-full border rounded-lg px-3 py-2"
                                            required
                                            disabled={saving}
                                        >
                                            <option value="u_tijeku">U tijeku</option>
                                            <option value="zavrsen">Zavr≈°en</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Broj raƒçuna</label>
                                        <input
                                            type="text"
                                            value={formData.brojRacuna}
                                            onChange={(e) => setFormData({ ...formData, brojRacuna: e.target.value })}
                                            className="w-full border rounded-lg px-3 py-2"
                                            disabled={saving}
                                        />
                                    </div>
                                </div>

                                <div>
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="block text-sm font-medium">Artikli</label>
                                        <button
                                            type="button"
                                            onClick={addArtikl}
                                            className="text-primary-600 hover:text-blue-900 text-sm"
                                            disabled={saving}
                                        >
                                            + Dodaj artikl
                                        </button>
                                    </div>
                                    {formData.artikli.map((artikl, index) => (
                                        <div key={index} className="border p-4 rounded-lg mb-2 bg-gray-50">
                                            <div className="grid grid-cols-12 gap-2 mb-2">
                                                <div className="col-span-4">
                                                    <label className="block text-xs font-medium mb-1">Artikl:</label>
                                                    <ArtiklAutocomplete
                                                        artikli={artikli}
                                                        value={artikl.artiklId}
                                                        onChange={(artiklId) => updateArtikl(index, 'artiklId', artiklId)}
                                                        disabled={saving}
                                                    />
                                                </div>
                                                <div className="col-span-2">
                                                    <label className="block text-xs font-medium mb-1">Koliƒçina:</label>
                                                    <input
                                                        type="number"
                                                        value={artikl.kolicina}
                                                        onChange={(e) => updateArtikl(index, 'kolicina', e.target.value)}
                                                        className="w-full border rounded px-2 py-1 text-sm"
                                                        min="1"
                                                        disabled={saving}
                                                    />
                                                </div>
                                                <div className="col-span-2">
                                                    <label className="block text-xs font-medium mb-1">Ukupna cijena:</label>
                                                    <input
                                                        type="number"
                                                        step="0.01"
                                                        value={artikl.ukupnaCijena || 0}
                                                        onChange={(e) => updateArtikl(index, 'ukupnaCijena', e.target.value)}
                                                        className="w-full border rounded px-2 py-1 text-sm"
                                                        disabled={saving}
                                                    />
                                                    <div className="text-xs text-gray-500 mt-1">
                                                        Cijena po komadu: {(parseFloat(artikl.cijena) || 0).toFixed(2)} EUR
                                                    </div>
                                                </div>
                                                <div className="col-span-3">
                                                    <label className="block text-xs font-medium mb-1">Napomena:</label>
                                                    <input
                                                        type="text"
                                                        value={artikl.napomena || ''}
                                                        onChange={(e) => updateArtikl(index, 'napomena', e.target.value)}
                                                        className="w-full border rounded px-2 py-1 text-sm"
                                                        disabled={saving}
                                                    />
                                                </div>
                                                <div className="col-span-1 flex items-end">
                                                    <button
                                                        type="button"
                                                        onClick={() => removeArtikl(index)}
                                                        className="w-full bg-red-500 text-white rounded px-2 py-1 text-sm hover:bg-red-600"
                                                        disabled={saving}
                                                    >
                                                        Obri≈°i
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div>
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="block text-sm font-medium">Postupci</label>
                                        <button
                                            type="button"
                                            onClick={addPostupak}
                                            className="text-primary-600 hover:text-blue-900 text-sm"
                                            disabled={saving}
                                        >
                                            + Dodaj postupak
                                        </button>
                                    </div>
                                    {formData.postupci.map((postupak, index) => (
                                        <div key={index} className="border rounded-lg p-3 mb-2 bg-gray-50">
                                            <div className="flex gap-2 mb-2">
                                                <select
                                                    value={postupak.postupakId}
                                                    onChange={(e) => updatePostupak(index, 'postupakId', e.target.value)}
                                                    className="flex-1 border rounded-lg px-3 py-2"
                                                    disabled={saving}
                                                >
                                                    <option value="">Odaberi postupak</option>
                                                    {postupci.map(p => (
                                                        <option key={p.id} value={p.id}>{p.naziv}</option>
                                                    ))}
                                                </select>
                                                <button
                                                    type="button"
                                                    onClick={() => removePostupak(index)}
                                                    className="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600"
                                                    disabled={saving}
                                                >
                                                    ‚úï
                                                </button>
                                            </div>
                                            <div className="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label className="block text-xs text-gray-600 mb-1">Koliƒçina</label>
                                                    <input
                                                        type="number"
                                                        step="0.01"
                                                        min="0"
                                                        value={postupak.kolicina || 1}
                                                        onChange={(e) => updatePostupak(index, 'kolicina', e.target.value)}
                                                        className="w-full border rounded px-2 py-1 text-sm"
                                                        disabled={saving}
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs text-gray-600 mb-1">Cijena (EUR)</label>
                                                    <input
                                                        type="number"
                                                        step="0.01"
                                                        min="0"
                                                        value={postupak.cijena || 0}
                                                        onChange={(e) => updatePostupak(index, 'cijena', e.target.value)}
                                                        className="w-full border rounded px-2 py-1 text-sm"
                                                        disabled={saving}
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs text-gray-600 mb-1">Trajanje (min)</label>
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        value={postupak.trajanjeMin || ''}
                                                        onChange={(e) => updatePostupak(index, 'trajanjeMin', e.target.value)}
                                                        className="w-full border rounded px-2 py-1 text-sm"
                                                        placeholder="opt."
                                                        disabled={saving}
                                                    />
                                                </div>
                                            </div>
                                            {(parseFloat(postupak.kolicina) > 0 && parseFloat(postupak.cijena) > 0) && (
                                                <div className="text-right text-sm font-medium text-primary-600 mt-2">
                                                    = {(parseFloat(postupak.kolicina || 1) * parseFloat(postupak.cijena || 0)).toFixed(2)} EUR
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                    {formData.postupci.length > 0 && getUkupnaCijenaPostupaka(formData.postupci) > 0 && (
                                        <div className="text-right font-semibold text-gray-700 pt-2 border-t">
                                            Ukupno postupci: {getUkupnaCijenaPostupaka(formData.postupci).toFixed(2)} EUR
                                        </div>
                                    )}
                                </div>

                                <div className="flex gap-2 justify-end">
                                    <button
                                        type="button"
                                        onClick={() => { resetForm(); setShowForm(false); }}
                                        className="px-4 py-2 border rounded-lg hover:bg-gray-50"
                                        disabled={saving}
                                    >
                                        Odustani
                                    </button>
                                    <button
                                        type="submit"
                                        className="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700"
                                        disabled={saving}
                                    >
                                        {saving ? 'Spremanje...' : 'Spremi'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    {viewingNalog && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                                <div className="p-6">
                                    <h3 className="text-xl font-bold mb-4">Radni Nalog #{viewingNalog.broj}</h3>
                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        <div><strong>Datum:</strong> {formatDate(viewingNalog.datum)}</div>
                                        <div><strong>Rok:</strong> {formatDate(viewingNalog.rokIzrade)}</div>
                                        <div><strong>Klijent:</strong> {viewingNalog.klijentNaziv}</div>
                                        <div><strong>Status:</strong> <span className="px-2 py-1 bg-green-100 text-green-800 rounded">Zavr≈°en</span></div>
                                        <div><strong>Broj raƒçuna:</strong> {viewingNalog.brojRacuna}</div>
                                    </div>
                                    <div className="mb-4">
                                        <strong>Opis problema:</strong>
                                        <p className="mt-1 text-gray-700">{viewingNalog.opisProblema}</p>
                                    </div>
                                    {viewingNalog.artikli && viewingNalog.artikli.length > 0 && (
                                        <div className="mb-4">
                                            <strong>Artikli:</strong>
                                            <table className="w-full mt-2 text-sm">
                                                <thead>
                                                    <tr className="border-b">
                                                        <th className="text-left py-2">Naziv</th>
                                                        <th className="text-right py-2">Koliƒçina</th>
                                                        <th className="text-right py-2">Cijena</th>
                                                        <th className="text-right py-2">Ukupno</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {viewingNalog.artikli.map((art, i) => (
                                                        <tr key={i} className="border-b">
                                                            <td className="py-2">{art.naziv}</td>
                                                            <td className="text-right">{art.kolicina}</td>
                                                            <td className="text-right">{parseFloat(art.cijena).toFixed(2)} EUR</td>
                                                            <td className="text-right">{(parseFloat(art.cijena) * parseFloat(art.kolicina)).toFixed(2)} EUR</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                    {viewingNalog.postupci && viewingNalog.postupci.length > 0 && (
                                        <div className="mb-4">
                                            <strong>Postupci:</strong>
                                            <ul className="list-disc list-inside mt-2">
                                                {viewingNalog.postupci.map((post, i) => (
                                                    <li key={i}>{post.naziv}</li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}
                                    <button onClick={() => setViewingNalog(null)} className="px-4 py-2 bg-primary-600 text-white rounded">Zatvori</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-8"></th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Broj</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Naziv naloga</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Datum</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Rok izrade</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Klijent</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Kontakt</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Telefon</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Broj raƒçuna</th>
                                    <th className="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Ukupno</th>
                                    <th className="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Akcije</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {zavrseniNalozi.length === 0 ? (
                                    <tr>
                                        <td colSpan="11" className="px-6 py-4 text-center text-gray-500">
                                            Nema zavr≈°enih naloga s brojem raƒçuna
                                        </td>
                                    </tr>
                                ) : (
                                    zavrseniNalozi.map(nalog => (
                                        <React.Fragment key={nalog.id}>
                                            <tr className="hover:bg-gray-50 text-xs">
                                                <td className="px-3 py-2 text-center">
                                                    <button
                                                        onClick={() => toggleRow(nalog.id)}
                                                        className="text-primary-600 font-bold text-lg hover:text-blue-900"
                                                    >
                                                        {expandedRows.includes(nalog.id) ? '‚àí' : '+'}
                                                    </button>
                                                </td>
                                                <td className="px-3 py-2 font-medium">{nalog.broj}</td>
                                                <td className="px-3 py-2">
                                                    <span className="text-gray-700 font-medium">
                                                        {nalog.nazivNaloga || <span className="text-gray-400">-</span>}
                                                    </span>
                                                </td>
                                                <td className="px-3 py-2">
                                                    <div>{formatDate(nalog.datum)}</div>
                                                    {nalog.createdAt && (
                                                        <div className="text-[10px] text-gray-400">
                                                            {new Date(nalog.createdAt).toLocaleString('hr-HR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit'})}
                                                            {nalog.createdByName && ` ‚Ä¢ ${nalog.createdByName}`}
                                                        </div>
                                                    )}
                                                </td>
                                                <td className="px-3 py-2">{formatDate(nalog.rokIzrade)}</td>
                                                <td className="px-3 py-2">{nalog.klijentNaziv}</td>
                                                <td className="px-3 py-2">{nalog.kontaktOsoba || <span className="text-gray-400">-</span>}</td>
                                                <td className="px-3 py-2">{nalog.telefon || <span className="text-gray-400">-</span>}</td>
                                                <td className="px-3 py-2">
                                                    <span className="font-medium text-gray-900">{nalog.brojRacuna}</span>
                                                </td>
                                                <td className="px-3 py-2 text-right">{getUkupnaCijena(nalog).toFixed(2)} EUR</td>
                                                <td className="px-3 py-2 text-right">
                                                    <button
                                                        onClick={async () => {
                                                            let fullNalog = nalog;
                                                            if (!nalog.artikli || nalog.artikli.length === 0) {
                                                                fullNalog = await apiCall('nalozi/' + nalog.id, 'GET', null, userId);
                                                            }
                                                            printOtpremnica(fullNalog);
                                                        }}
                                                        className="text-blue-600 hover:text-blue-900 mr-2"
                                                        title="Print otpremnica"
                                                    >
                                                        üñ®Ô∏è
                                                    </button>
                                                    <button
                                                        onClick={() => handleView(nalog)}
                                                        className="text-green-600 hover:text-green-900 mr-2"
                                                    >
                                                        Pregled
                                                    </button>
                                                    <button
                                                        onClick={() => handleEdit(nalog)}
                                                        className="text-primary-600 hover:text-blue-900 mr-2"
                                                    >
                                                        Uredi
                                                    </button>
                                                    <button
                                                        onClick={() => handleDelete(nalog.id)}
                                                        className="text-red-600 hover:text-red-900"
                                                    >
                                                        Obri≈°i
                                                    </button>
                                                </td>
                                            </tr>
                                            {expandedRows.includes(nalog.id) && (
                                                <tr>
                                                    <td colSpan="11" className="px-3 py-4 bg-gray-50">
                                                        <div className="space-y-4">
                                                            {nalog.artikli && nalog.artikli.length > 0 && (
                                                                <div>
                                                                    <h4 className="font-semibold text-sm mb-2">Artikli:</h4>
                                                                    <table className="w-full text-xs">
                                                                        <thead>
                                                                            <tr className="bg-gray-100">
                                                                                <th className="px-2 py-1 text-left">Naziv</th>
                                                                                <th className="px-2 py-1 text-right">Koliƒçina</th>
                                                                                <th className="px-2 py-1 text-left">Format</th>
                                                                                <th className="px-2 py-1 text-left">Opis</th>
                                                                                <th className="px-2 py-1 text-right">Cijena/kom</th>
                                                                                <th className="px-2 py-1 text-right">Ukupno</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            {nalog.artikli.map((art, i) => (
                                                                                <tr key={i} className="border-t">
                                                                                    <td className="px-2 py-1">{art.naziv}</td>
                                                                                    <td className="px-2 py-1 text-right">{art.kolicina}</td>
                                                                                    <td className="px-2 py-1 text-gray-600">{art.format || '-'}</td>
                                                                                    <td className="px-2 py-1 text-gray-600">{art.opis || art.napomena || '-'}</td>
                                                                                    <td className="px-2 py-1 text-right">{parseFloat(art.cijena).toFixed(2)} EUR</td>
                                                                                    <td className="px-2 py-1 text-right font-medium">{(parseFloat(art.cijena) * parseFloat(art.kolicina)).toFixed(2)} EUR</td>
                                                                                </tr>
                                                                            ))}
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            )}
                                                            {nalog.postupci && nalog.postupci.length > 0 && nalog.postupci.some(p => p.naziv) && (
                                                                <div>
                                                                    <h4 className="font-semibold text-sm mb-2">Postupci:</h4>
                                                                    <ul className="list-disc list-inside text-xs text-gray-700">
                                                                        {nalog.postupci.filter(p => p.naziv).map((post, i) => (
                                                                            <li key={i}>{post.naziv}</li>
                                                                        ))}
                                                                    </ul>
                                                                </div>
                                                            )}
                                                            <div>
                                                                <h4 className="font-semibold text-sm mb-1">Opis problema:</h4>
                                                                <p className="text-xs text-gray-700">{nalog.opisProblema || '-'}</p>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            )}
                                        </React.Fragment>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // TaskoviSekcija komponenta - Opƒái podsjetnici (kompaktna verzija)
        function TaskoviSekcija({ userId, isAdmin }) {
            const [taskovi, setTaskovi] = useState([]);
            const [zavrseniTaskovi, setZavrseniTaskovi] = useState([]);
            const [showZavrsene, setShowZavrsene] = useState(false);
            const [noviTask, setNoviTask] = useState('');
            const [showInput, setShowInput] = useState(false);
            const [editingTaskId, setEditingTaskId] = useState(null);
            const [editingText, setEditingText] = useState('');
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const loadTaskovi = async () => {
                    try {
                        const data = await apiCall('taskovi', 'GET', null, userId);
                        setTaskovi(data || []);
                        if (isAdmin) {
                            const zavrseni = await apiCall('taskovi/zavrseni', 'GET', null, userId);
                            setZavrseniTaskovi(zavrseni || []);
                        }
                    } catch (error) {
                        console.error('Gre≈°ka pri uƒçitavanju taskova:', error);
                    } finally {
                        setLoading(false);
                    }
                };
                loadTaskovi();
            }, [userId, isAdmin]);

            const handleAddTask = async () => {
                if (!noviTask.trim()) return;
                try {
                    const result = await apiCall('taskovi', 'POST', { tekst: noviTask.trim() }, userId);
                    if (result.success) {
                        setTaskovi([{ id: result.id, tekst: result.tekst, kreiraoIme: result.kreiraoIme, createdAt: result.createdAt }, ...taskovi]);
                        setNoviTask('');
                        setShowInput(false);
                    }
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleFinishTask = async (id) => {
                try {
                    await apiCall('taskovi/' + id, 'DELETE', null, userId);
                    const task = taskovi.find(t => t.id === id);
                    setTaskovi(taskovi.filter(t => t.id !== id));
                    if (isAdmin && task) {
                        setZavrseniTaskovi([{ ...task, zavrsioIme: 'Ti', zavrsenAt: new Date().toISOString() }, ...zavrseniTaskovi]);
                    }
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleDeletePermanent = async (id) => {
                if (!confirm('Trajno obrisati ovaj task?')) return;
                try {
                    await apiCall('taskovi/' + id + '?permanent=1', 'DELETE', null, userId);
                    setZavrseniTaskovi(zavrseniTaskovi.filter(t => t.id !== id));
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleEditTask = async (id) => {
                if (!editingText.trim()) return;
                try {
                    await apiCall('taskovi/' + id, 'PUT', { tekst: editingText.trim() }, userId);
                    setTaskovi(taskovi.map(t => t.id === id ? { ...t, tekst: editingText.trim() } : t));
                    setEditingTaskId(null);
                    setEditingText('');
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            if (loading) return null;
            if (taskovi.length === 0 && zavrseniTaskovi.length === 0 && !showInput) {
                return (
                    <div className="mb-2 flex items-center gap-2">
                        <button onClick={() => setShowInput(true)} className="text-xs text-primary-600 hover:text-primary-800">
                            üìå + Dodaj opƒái podsjetnik
                        </button>
                    </div>
                );
            }

            return (
                <div className="mb-3 px-2 py-1 bg-yellow-50 border-l-4 border-yellow-400 rounded text-xs">
                    <div className="flex items-center gap-2 mb-1">
                        <span className="font-semibold text-yellow-800">üìå Opƒái podsjetnici ({taskovi.length})</span>
                        <button onClick={() => setShowInput(!showInput)} className="text-yellow-600 hover:text-yellow-800 text-xs">
                            {showInput ? '‚úï' : '+'}
                        </button>
                        {isAdmin && zavrseniTaskovi.length > 0 && (
                            <button onClick={() => setShowZavrsene(!showZavrsene)} className="text-gray-500 hover:text-gray-700 text-xs ml-auto">
                                {showZavrsene ? 'Sakrij zavr≈°ene' : 'Prika≈æi zavr≈°ene (' + zavrseniTaskovi.length + ')'}
                            </button>
                        )}
                    </div>
                    
                    {showInput && (
                        <div className="flex items-center gap-1 mb-1">
                            <input
                                type="text"
                                value={noviTask}
                                onChange={(e) => setNoviTask(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleAddTask()}
                                placeholder="Novi podsjetnik..."
                                className="flex-1 border rounded px-2 py-0.5 text-xs"
                                autoFocus
                            />
                            <button onClick={handleAddTask} disabled={!noviTask.trim()} className="text-green-600 hover:text-green-800 disabled:opacity-50">Dodaj</button>
                            <button onClick={() => { setShowInput(false); setNoviTask(''); }} className="text-gray-500 hover:text-gray-700">Odustani</button>
                        </div>
                    )}

                    {taskovi.map(task => (
                        <div key={task.id} className="flex items-center gap-1 py-0.5">
                            {editingTaskId === task.id ? (
                                <>
                                    <input
                                        type="text"
                                        value={editingText}
                                        onChange={(e) => setEditingText(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleEditTask(task.id)}
                                        className="flex-1 border rounded px-1 py-0.5 text-xs"
                                        autoFocus
                                    />
                                    <button onClick={() => handleEditTask(task.id)} className="text-green-600">Spremi</button>
                                    <button onClick={() => { setEditingTaskId(null); setEditingText(''); }} className="text-gray-500">Odustani</button>
                                </>
                            ) : (
                                <>
                                    <span className="text-yellow-800">{task.tekst}</span>
                                    <span className="text-gray-400">({task.kreiraoIme}, {new Date(task.createdAt).toLocaleString('hr-HR', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'})})</span>
                                    <button onClick={() => { setEditingTaskId(task.id); setEditingText(task.tekst); }} className="text-blue-500 hover:text-blue-700">Uredi</button>
                                    <button onClick={() => handleFinishTask(task.id)} className="text-green-500 hover:text-green-700">Zavr≈°i</button>
                                </>
                            )}
                        </div>
                    ))}

                    {/* Zavr≈°eni taskovi - samo admin */}
                    {isAdmin && showZavrsene && zavrseniTaskovi.length > 0 && (
                        <div className="mt-2 pt-2 border-t border-yellow-300">
                            <div className="text-gray-500 font-semibold mb-1">‚úì Zavr≈°eni:</div>
                            {zavrseniTaskovi.map(task => (
                                <div key={task.id} className="flex items-center gap-1 py-0.5 text-gray-400 line-through">
                                    <span>{task.tekst}</span>
                                    <span className="no-underline">({task.zavrsioIme}, {new Date(task.zavrsenAt).toLocaleString('hr-HR', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'})})</span>
                                    <button onClick={() => handleDeletePermanent(task.id)} className="text-red-400 hover:text-red-600 no-underline">Obri≈°i</button>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        function RadniNaloziTab({ radniNalozi, setRadniNalozi, kupci, artikli, postupci, materijali, setMaterijali, userId, isAdmin }) {
            const [showForm, setShowForm] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [saving, setSaving] = useState(false);
            const [viewingNalog, setViewingNalog] = useState(null);
            const [expandedRows, setExpandedRows] = useState([]);
            const [loadingRows, setLoadingRows] = useState([]);
            const [rasknjizavanje, setRasknjizavanje] = useState(false);
            const [utroseniMaterijali, setUtroseniMaterijali] = useState([]);
            
            // Rasknji≈æenje modal state
            const [showRasknjizenjeModal, setShowRasknjizenjeModal] = useState(false);
            const [rasknjizenjeNalog, setRasknjizenjeNalog] = useState(null);
            const [rasknjizenjeMaterijali, setRasknjizenjeMaterijali] = useState({});
            
            const [formData, setFormData] = useState({
                broj: '',
                nazivNaloga: '',
                datum: new Date().toISOString().split('T')[0],
                rokIzrade: '',
                klijentId: '',
                klijentNaziv: '',
                kontaktOsoba: '',
                telefon: '',
                email: '',
                opisProblema: '',
                brojRacuna: '',
                status: 'u_tijeku',
                artikli: [],
                postupci: []
            });

            // Print RADNI NALOG - za naloge u tijeku (s podsjetnicima i materijalima)
            const printRadniNalog = (nalog) => {
                let artikliHTML = '';
                (nalog.artikli || []).forEach((art, idx) => {
                    const kol = parseFloat(art.kolicina) || 0;
                    const cijena = parseFloat(art.cijena) || 0;
                    const ukupno = kol * cijena;
                    const napomena = [art.format, art.opis].filter(Boolean).join(' - ');
                    
                    artikliHTML += '<div class="artikl-box">';
                    artikliHTML += '<div class="artikl-header">';
                    artikliHTML += '<span class="artikl-num">' + (idx + 1) + '.</span> ';
                    artikliHTML += (art.sifra ? '<span class="artikl-sifra">(' + art.sifra + ')</span> ' : '');
                    artikliHTML += '<strong>' + (art.naziv || '') + '</strong>';
                    artikliHTML += '<span class="artikl-qty">' + kol + ' ' + (art.jedinica || 'kom') + ' √ó ' + cijena.toFixed(2) + ' = <strong>' + ukupno.toFixed(2) + ' EUR</strong></span>';
                    artikliHTML += '</div>';
                    
                    if (napomena) {
                        artikliHTML += '<div class="artikl-napomena">üìù ' + napomena + '</div>';
                    }
                    
                    // Podsjetnici
                    if (art.podsjetnici && art.podsjetnici.length > 0) {
                        artikliHTML += '<div class="podsjetnici-section"><strong>üìå Podsjetnici:</strong><ul>';
                        art.podsjetnici.forEach(p => {
                            const status = p.zavrsen ? '‚úì' : '‚óã';
                            artikliHTML += '<li class="' + (p.zavrsen ? 'done' : '') + '">' + status + ' ' + p.tekst + '</li>';
                        });
                        artikliHTML += '</ul></div>';
                    }
                    
                    // Materijali
                    if (art.materijali && art.materijali.length > 0) {
                        artikliHTML += '<div class="materijali-section"><strong>üß± Materijali:</strong><ul>';
                        art.materijali.forEach(m => {
                            artikliHTML += '<li>' + m.naziv + ': ' + m.kolicina + ' ' + (m.jedinicaMjere || '') + '</li>';
                        });
                        artikliHTML += '</ul></div>';
                    }
                    
                    artikliHTML += '</div>';
                });
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(
                    '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Radni nalog ' + nalog.broj + '</title>' +
                    '<style>' +
                    '* { margin: 0; padding: 0; box-sizing: border-box; }' +
                    'body { font-family: Arial, sans-serif; font-size: 11px; padding: 10mm; color: #333; }' +
                    '.header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; }' +
                    '.logo { font-size: 20px; font-weight: bold; }' +
                    '.document-title { font-size: 24px; font-weight: bold; text-align: center; margin: 15px 0; background: #f0f0f0; padding: 10px; }' +
                    '.info-grid { display: flex; justify-content: space-between; margin-bottom: 15px; }' +
                    '.info-box { flex: 1; padding: 10px; border: 1px solid #ddd; margin-right: 10px; }' +
                    '.info-box:last-child { margin-right: 0; }' +
                    '.info-box h4 { margin-bottom: 5px; color: #666; font-size: 10px; text-transform: uppercase; }' +
                    '.info-box p { font-size: 12px; margin: 2px 0; }' +
                    '.artikl-box { border: 1px solid #ccc; margin-bottom: 10px; padding: 10px; background: #fafafa; }' +
                    '.artikl-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }' +
                    '.artikl-num { background: #333; color: #fff; padding: 2px 8px; border-radius: 3px; font-weight: bold; }' +
                    '.artikl-sifra { color: #666; font-size: 10px; }' +
                    '.artikl-qty { color: #333; }' +
                    '.artikl-napomena { font-style: italic; color: #555; margin: 5px 0; padding: 5px; background: #fff3cd; border-radius: 3px; }' +
                    '.podsjetnici-section, .materijali-section { margin-top: 8px; padding: 8px; background: #fff; border-radius: 3px; }' +
                    '.podsjetnici-section { border-left: 3px solid #ffc107; }' +
                    '.materijali-section { border-left: 3px solid #17a2b8; }' +
                    'ul { margin-left: 20px; margin-top: 5px; }' +
                    'li { margin: 3px 0; }' +
                    'li.done { text-decoration: line-through; color: #888; }' +
                    '.footer { margin-top: 20px; display: flex; justify-content: space-between; }' +
                    '.signature-box { width: 200px; text-align: center; }' +
                    '.signature-line { border-top: 1px solid #333; margin-top: 30px; padding-top: 5px; }' +
                    '@media print { body { padding: 5mm; } @page { margin: 5mm; } }' +
                    '</style></head><body>' +
                    '<div class="header"><div>' +
                    '<div class="logo">SIGNALprint</div>' +
                    '<div style="font-size:9px;">vl. Tihomir Borovƒçak | Naselje Borovƒçaki 8, 49210 Zabok | Tel: 049/500-005</div>' +
                    '</div><div style="text-align:right;">' +
                    '<div style="font-size:10px;">Datum ispisa: ' + new Date().toLocaleDateString('hr-HR') + '</div>' +
                    '</div></div>' +
                    '<div class="document-title">RADNI NALOG ' + nalog.broj + '</div>' +
                    '<div class="info-grid">' +
                    '<div class="info-box"><h4>Klijent</h4>' +
                    '<p><strong>' + (nalog.klijentNaziv || '-') + '</strong></p>' +
                    '<p>' + (nalog.kontaktOsoba || '') + '</p>' +
                    '<p>' + (nalog.telefon || '') + '</p>' +
                    '</div>' +
                    '<div class="info-box"><h4>Nalog</h4>' +
                    '<p><strong>' + (nalog.nazivNaloga || '-') + '</strong></p>' +
                    '<p>Datum: ' + new Date(nalog.datum).toLocaleDateString('hr-HR') + '</p>' +
                    (nalog.rokIzrade ? '<p>Rok: <strong>' + new Date(nalog.rokIzrade).toLocaleDateString('hr-HR') + '</strong></p>' : '') +
                    '</div>' +
                    '<div class="info-box"><h4>Status</h4>' +
                    '<p style="font-size:14px;"><strong>' + (nalog.status === 'zavrsen' ? '‚úì Zavr≈°en' : '‚öôÔ∏è U tijeku') + '</strong></p>' +
                    (nalog.brojRacuna ? '<p>Raƒçun: ' + nalog.brojRacuna + '</p>' : '') +
                    '</div>' +
                    '</div>' +
                    '<h3 style="margin-bottom:10px;">Artikli:</h3>' +
                    artikliHTML +
                    '<div class="footer">' +
                    '<div class="signature-box"><div>Izradio:</div><div class="signature-line">_______________________</div></div>' +
                    '<div class="signature-box"><div>Kontrolirao:</div><div class="signature-line">_______________________</div></div>' +
                    '</div>' +
                    '</body></html>'
                );
                printWindow.document.close();
                printWindow.print();
            };

            // Print OTPREMNICA - za zavr≈°ene naloge (samo artikli i cijene)
            const printOtpremnica = (nalog) => {
                const ukupnoBezPDV = (nalog.artikli || []).reduce((sum, a) => sum + (parseFloat(a.cijena || 0) * parseFloat(a.kolicina || 0)), 0);
                const pdv = ukupnoBezPDV * 0.25;
                const ukupnoSaPDV = ukupnoBezPDV + pdv;
                
                let artikliRows = '';
                (nalog.artikli || []).forEach(art => {
                    const cijenaBezPDV = parseFloat(art.cijena) || 0;
                    const kol = parseFloat(art.kolicina) || 0;
                    const pdvIznos = cijenaBezPDV * 0.25;
                    const cijenaSaPDV = cijenaBezPDV + pdvIznos;
                    const vrijednost = cijenaSaPDV * kol;
                    const napomena = [art.format, art.opis].filter(Boolean).join(' - ');
                    
                    artikliRows += '<tr><td>' + 
                        (art.sifra ? '<span style="color:#666;">(' + art.sifra + ')</span> ' : '') +
                        '<strong>' + (art.naziv || '') + '</strong>' + 
                        (art.kpdSifra ? '<div style="font-size:8px;color:#888;">KPD: ' + art.kpdSifra + '</div>' : '') +
                        (napomena ? '<div class="napomena">' + napomena + '</div>' : '') +
                        '</td><td class="right">' + kol.toFixed(2) + ' ' + (art.jedinica || 'kom') + 
                        '</td><td class="right">' + cijenaBezPDV.toFixed(2) + 
                        '</td><td class="right">' + pdvIznos.toFixed(2) + ' (25%)' +
                        '</td><td class="right">' + cijenaSaPDV.toFixed(2) + 
                        '</td><td class="right">' + vrijednost.toFixed(2) + '</td></tr>';
                });
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(
                    '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Otpremnica ' + nalog.broj + '</title>' +
                    '<style>' +
                    '* { margin: 0; padding: 0; box-sizing: border-box; }' +
                    'body { font-family: Arial, sans-serif; font-size: 11px; padding: 15mm; color: #333; }' +
                    '.header { display: flex; justify-content: space-between; margin-bottom: 20px; }' +
                    '.logo { font-size: 24px; font-weight: bold; }' +
                    '.logo-sub { font-size: 10px; color: #666; }' +
                    '.company-info { font-size: 9px; line-height: 1.4; }' +
                    '.document-title { font-size: 22px; font-weight: bold; text-align: center; margin: 20px 0 10px 0; }' +
                    '.client-box { border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; min-height: 80px; }' +
                    '.client-name { font-weight: bold; font-size: 13px; margin-bottom: 5px; }' +
                    '.doc-info { margin-bottom: 15px; }' +
                    '.doc-info-row { display: flex; margin-bottom: 3px; }' +
                    '.doc-info-label { width: 100px; font-weight: bold; }' +
                    'table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }' +
                    'th { background: #f5f5f5; border: 1px solid #ccc; padding: 8px 5px; text-align: left; font-size: 10px; font-weight: bold; }' +
                    'td { border: 1px solid #ccc; padding: 6px 5px; vertical-align: top; }' +
                    '.right { text-align: right; }' +
                    '.napomena { font-size: 9px; color: #555; font-style: italic; margin-top: 3px; }' +
                    '.totals { margin-left: auto; width: 250px; }' +
                    '.total-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #eee; }' +
                    '.total-row.final { font-weight: bold; font-size: 14px; border-bottom: 2px solid #333; border-top: 2px solid #333; padding: 8px 0; }' +
                    '.footer { margin-top: 30px; font-size: 9px; }' +
                    '.signatures { display: flex; justify-content: space-between; margin-top: 40px; }' +
                    '.signature-box { width: 200px; text-align: center; }' +
                    '.signature-line { border-top: 1px solid #333; margin-top: 40px; padding-top: 5px; }' +
                    '.footer-note { font-size: 8px; color: #666; text-align: center; margin-top: 20px; padding-top: 10px; border-top: 1px solid #eee; }' +
                    '.contact-footer { text-align: center; font-size: 8px; color: #666; margin-top: 10px; }' +
                    '@media print { body { padding: 10mm; } @page { margin: 10mm; } }' +
                    '</style></head><body>' +
                    '<div class="header"><div>' +
                    '<div class="logo">SIGNALprint</div>' +
                    '<div class="logo-sub">trgovina, usluge, proizvodnja</div>' +
                    '<div class="company-info" style="margin-top: 5px;">vl. Tihomir Borovƒçak<br>Naselje Borovƒçaki 8<br>HR-49210 Zabok<br><br>OIB 52276562396<br><br>IBAN ZABA: HR8923600001101163526<br>IBAN PBZ: HR7723400091160234176</div>' +
                    '</div><div style="text-align: right;"><div class="client-box">' +
                    '<div class="client-name">' + (nalog.klijentNaziv || '') + '</div>' +
                    (nalog.kontaktOsoba ? '<div>' + nalog.kontaktOsoba + '</div>' : '') +
                    (nalog.telefon ? '<div>Tel: ' + nalog.telefon + '</div>' : '') +
                    (nalog.email ? '<div>' + nalog.email + '</div>' : '') +
                    '</div></div></div>' +
                    '<div class="document-title">OTPREMNICA</div>' +
                    '<div style="display: flex; justify-content: space-between;"><div class="doc-info">' +
                    '<div class="doc-info-row"><span class="doc-info-label">BROJ:</span> <span>' + nalog.broj + '</span></div>' +
                    '<div class="doc-info-row"><span class="doc-info-label">Mjesto:</span> <span>Zabok</span></div>' +
                    '<div class="doc-info-row"><span class="doc-info-label">Datum:</span> <span>' + new Date(nalog.datum).toLocaleDateString('hr-HR') + '</span></div>' +
                    (nalog.rokIzrade ? '<div class="doc-info-row"><span class="doc-info-label">Rok izrade:</span> <span>' + new Date(nalog.rokIzrade).toLocaleDateString('hr-HR') + '</span></div>' : '') +
                    '</div><div class="doc-info">' +
                    (nalog.brojRacuna ? '<div class="doc-info-row"><span class="doc-info-label">Broj raƒçuna:</span> <span>' + nalog.brojRacuna + '</span></div>' : '') +
                    '<div class="doc-info-row"><span class="doc-info-label">Naziv:</span> <span>' + (nalog.nazivNaloga || '') + '</span></div>' +
                    '</div></div>' +
                    '<table><thead><tr>' +
                    '<th style="width: 40%;">Vrsta robe odnosno usluga</th>' +
                    '<th class="right" style="width: 12%;">Koliƒçina</th>' +
                    '<th class="right" style="width: 12%;">Cijena</th>' +
                    '<th class="right" style="width: 12%;">PDV</th>' +
                    '<th class="right" style="width: 12%;">Cijena + PDV</th>' +
                    '<th class="right" style="width: 12%;">Vrijednost EUR</th>' +
                    '</tr></thead><tbody>' + artikliRows + '</tbody></table>' +
                    '<div class="totals">' +
                    '<div class="total-row"><span>Ukupno:</span><span>' + ukupnoBezPDV.toFixed(2) + '</span></div>' +
                    '<div class="total-row"><span>PDV 25,00% od ' + ukupnoBezPDV.toFixed(2) + ':</span><span>' + pdv.toFixed(2) + '</span></div>' +
                    '<div class="total-row final"><span>Ukupno EUR:</span><span>' + ukupnoSaPDV.toFixed(2) + '</span></div>' +
                    '</div>' +
                    '<div class="footer"><p>Odgovorna osoba: Tihomir Borovƒçak</p></div>' +
                    '<div class="signatures">' +
                    '<div class="signature-box"><div>Operater:</div><div class="signature-line">_______________________</div></div>' +
                    '<div class="signature-box"><div>Preuzeo:</div><div class="signature-line">_______________________</div></div>' +
                    '</div>' +
                    '<div class="footer-note">Dokument je pravovaljan bez peƒçata i potpisa jer je ispisan elektroniƒçkim putem.</div>' +
                    '<div class="contact-footer">TEL: 049/500-005, E-MAIL: info@signalprint.hr, WEB: www.signalprint.hr, FB: signal.print.zabok, IG: signalprint_zabok</div>' +
                    '</body></html>'
                );
                printWindow.document.close();
                printWindow.print();
            };

            // Otvori modal za rasknji≈æenje
            const openRasknjizenjeModal = async (nalog) => {
                // Uƒçitaj kompletan nalog ako treba
                let fullNalog = nalog;
                if (!nalog.artikli) {
                    fullNalog = await apiCall(`nalozi/${nalog.id}`, 'GET', null, userId);
                }
                
                setRasknjizenjeNalog(fullNalog);
                // Inicijaliziraj materijale za svaki artikl
                const inicijalniMaterijali = {};
                (fullNalog.artikli || []).forEach((a, idx) => {
                    inicijalniMaterijali[idx] = [];
                });
                setRasknjizenjeMaterijali(inicijalniMaterijali);
                setShowRasknjizenjeModal(true);
            };

            // Dodaj materijal za odreƒëeni artikl
            const addRasknjizenjeMaterijal = (artiklIndex) => {
                setRasknjizenjeMaterijali(prev => ({
                    ...prev,
                    [artiklIndex]: [...(prev[artiklIndex] || []), { materijalId: '', kolicina: '', napomena: '' }]
                }));
            };

            // A≈æuriraj materijal za odreƒëeni artikl
            const updateRasknjizenjeMaterijal = (artiklIndex, matIndex, field, value) => {
                setRasknjizenjeMaterijali(prev => {
                    const updated = { ...prev };
                    const artiklMats = [...(updated[artiklIndex] || [])];
                    artiklMats[matIndex] = { ...artiklMats[matIndex], [field]: value };
                    
                    if (field === 'materijalId' && value) {
                        const mat = materijali.find(m => String(m.id) === String(value));
                        if (mat) {
                            artiklMats[matIndex].naziv = mat.naziv;
                            artiklMats[matIndex].jedinicaMjere = mat.jedinicaMjere;
                            artiklMats[matIndex].cijena = mat.cijena;
                            artiklMats[matIndex].zaliha = mat.zaliha;
                        }
                    }
                    
                    updated[artiklIndex] = artiklMats;
                    return updated;
                });
            };

            // Postavi cijeli materijal odjednom (za MaterijalSelect)
            const setRasknjizenjeMat = (artiklIndex, matIndex, materijalObj) => {
                setRasknjizenjeMaterijali(prev => {
                    const updated = { ...prev };
                    const artiklMats = [...(updated[artiklIndex] || [])];
                    artiklMats[matIndex] = { 
                        ...artiklMats[matIndex],
                        materijalId: materijalObj.id,
                        naziv: materijalObj.naziv,
                        jedinicaMjere: materijalObj.jedinicaMjere,
                        cijena: materijalObj.cijena,
                        zaliha: materijalObj.zaliha
                    };
                    updated[artiklIndex] = artiklMats;
                    return updated;
                });
            };

            // Ukloni materijal
            const removeRasknjizenjeMaterijal = (artiklIndex, matIndex) => {
                setRasknjizenjeMaterijali(prev => ({
                    ...prev,
                    [artiklIndex]: (prev[artiklIndex] || []).filter((_, i) => i !== matIndex)
                }));
            };

            // Izvr≈°i rasknji≈æenje
            const executeRasknjizenje = async () => {
                // Spoji sve materijale iz svih artikala
                const sviMaterijali = [];
                Object.keys(rasknjizenjeMaterijali).forEach(artiklIdx => {
                    const artikl = rasknjizenjeNalog.artikli[artiklIdx];
                    (rasknjizenjeMaterijali[artiklIdx] || []).forEach(m => {
                        if (m.materijalId && parseFloat(m.kolicina) > 0) {
                            sviMaterijali.push({
                                materijalId: m.materijalId,
                                kolicina: parseFloat(m.kolicina),
                                cijena: m.cijena || 0,
                                artiklNaziv: artikl?.naziv || '',
                                napomena: m.napomena || ''
                            });
                        }
                    });
                });
                
                if (sviMaterijali.length === 0) {
                    alert('Dodajte barem jedan materijal za rasknji≈æenje!');
                    return;
                }
                
                if (!confirm(`Rasknji≈æiti ${sviMaterijali.length} materijala?\n\nOvo ƒáe skinuti materijale sa zalihe.`)) return;
                
                setRasknjizavanje(true);
                try {
                    const result = await apiCall(`rasknjizi/${rasknjizenjeNalog.id}`, 'POST', {
                        materijali: sviMaterijali
                    }, userId);
                    
                    // A≈æuriraj nalog u listi
                    setRadniNalozi(prev => prev.map(n => 
                        n.id === rasknjizenjeNalog.id ? { ...n, rasknjizen: true } : n
                    ));
                    
                    setShowRasknjizenjeModal(false);
                    alert(`Uspje≈°no rasknji≈æeno ${result.rasknji≈æenoMaterijala} materijala!`);
                    
                } catch (error) {
                    alert('Gre≈°ka pri rasknji≈æenju: ' + error.message);
                } finally {
                    setRasknjizavanje(false);
                }
            };

            // Funkcija za storno rasknji≈æenja
            const handleStornoRasknjizi = async (nalogId) => {
                if (!confirm('Jeste li sigurni da ≈æelite stornirati rasknji≈æenje?\n\nOvo ƒáe vratiti SVE materijale na zalihu.')) return;
                
                setRasknjizavanje(true);
                try {
                    await apiCall(`storno-rasknjizi/${nalogId}`, 'POST', {}, userId);
                    
                    setRadniNalozi(prev => prev.map(n => 
                        n.id === nalogId ? { ...n, rasknjizen: false } : n
                    ));
                    
                    if (viewingNalog && viewingNalog.id === nalogId) {
                        setViewingNalog({ ...viewingNalog, rasknjizen: false });
                        setUtroseniMaterijali([]);
                    }
                    
                    alert('Storno uspje≈°an - materijali vraƒáeni na zalihu!');
                } catch (error) {
                    alert('Gre≈°ka pri stornu: ' + error.message);
                } finally {
                    setRasknjizavanje(false);
                }
            };

            // Funkcija za brisanje jednog materijala s naloga
            const handleDeleteMaterijal = async (nmId, naziv) => {
                if (!confirm(`Obrisati "${naziv}" s naloga?\n\nKoliƒçina ƒáe biti vraƒáena na zalihu.`)) return;
                
                try {
                    await apiCall(`nalog-materijali/${nmId}`, 'DELETE', null, userId);
                    
                    // Osvje≈æi popis utro≈°enih materijala
                    const noviUtroseni = utroseniMaterijali.filter(m => m.id !== nmId);
                    setUtroseniMaterijali(noviUtroseni);
                    
                    // Ako nema vi≈°e materijala, makni oznaku rasknji≈æenja
                    if (noviUtroseni.length === 0) {
                        setRadniNalozi(prev => prev.map(n => 
                            n.id === viewingNalog.id ? { ...n, rasknjizen: false } : n
                        ));
                        setViewingNalog({ ...viewingNalog, rasknjizen: false });
                    }
                    
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            // Funkcija za dodavanje materijala na postojeƒái nalog
            const handleDodajMaterijal = async (nalogId, materijalId, kolicina) => {
                if (!materijalId || !kolicina || parseFloat(kolicina) <= 0) {
                    alert('Odaberi materijal i unesi koliƒçinu!');
                    return;
                }
                
                const mat = materijali.find(m => String(m.id) === String(materijalId));
                
                try {
                    await apiCall('nalog-materijali', 'POST', {
                        nalogId: nalogId,
                        materijalId: materijalId,
                        kolicina: parseFloat(kolicina),
                        cijena: mat?.cijena || 0
                    }, userId);
                    
                    // Osvje≈æi popis utro≈°enih materijala
                    const utroseni = await apiCall(`rasknjizi/${nalogId}`, 'GET', null, userId);
                    setUtroseniMaterijali(utroseni);
                    
                    // Oznaƒçi nalog kao rasknji≈æen
                    setRadniNalozi(prev => prev.map(n => 
                        n.id === nalogId ? { ...n, rasknjizen: true } : n
                    ));
                    setViewingNalog({ ...viewingNalog, rasknjizen: true });
                    
                    // Resetiraj formu
                    setNoviMaterijalId('');
                    setNoviMaterijalKol('');
                    
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            // State za dodavanje novog materijala
            const [noviMaterijalId, setNoviMaterijalId] = useState('');
            const [noviMaterijalKol, setNoviMaterijalKol] = useState('');

            const toggleRow = async (id) => {
                if (expandedRows.includes(id)) {
                    setExpandedRows(prev => prev.filter(rowId => rowId !== id));
                } else {
                    const nalog = radniNalozi.find(n => n.id === id);
                    if (nalog && (!nalog.artikli || !nalog.postupci)) {
                        setLoadingRows(prev => [...prev, id]);
                        try {
                            const fullNalog = await apiCall(`nalozi/${id}`, 'GET', null, userId);
                            setRadniNalozi(prev => prev.map(n => 
                                n.id === id ? { ...n, artikli: fullNalog.artikli, postupci: fullNalog.postupci } : n
                            ));
                        } catch (error) {
                            console.error('Gre≈°ka pri uƒçitavanju detalja naloga:', error);
                        } finally {
                            setLoadingRows(prev => prev.filter(rowId => rowId !== id));
                        }
                    }
                    setExpandedRows(prev => [...prev, id]);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                // Validacija - mora imati klijenta (za novi nalog klijentId, za ureƒëivanje klijentNaziv)
                if (!editingId && !formData.klijentId) {
                    alert('Morate odabrati klijenta!');
                    return;
                }
                if (editingId && !formData.klijentNaziv) {
                    alert('Nalog nema klijenta!');
                    return;
                }
                
                // Validacija - mora imati barem jedan artikl
                if (!formData.artikli || formData.artikli.length === 0) {
                    alert('Morate dodati barem jedan artikl!');
                    return;
                }
                
                // Provjeri da svi artikli imaju naziv
                const artiklBezNaziva = formData.artikli.find(a => !a.naziv && !a.artiklId);
                if (artiklBezNaziva) {
                    alert('Svi artikli moraju imati naziv!');
                    return;
                }
                
                setSaving(true);
                
                // Oƒçisti ukupnaCijena iz artikala (to je samo za UI)
                const artikliZaSpremanje = formData.artikli.map(a => {
                    const { ukupnaCijena, ...artiklBezUkupne } = a;
                    return artiklBezUkupne;
                });
                
                const nalogData = {
                    broj: formData.broj,
                    nazivNaloga: formData.nazivNaloga,
                    datum: formData.datum,
                    rokIzrade: formData.rokIzrade,
                    klijentId: formData.klijentId,
                    klijentNaziv: formData.klijentNaziv,
                    kontaktOsoba: formData.kontaktOsoba,
                    telefon: formData.telefon,
                    email: formData.email,
                    opisProblema: formData.opisProblema,
                    brojRacuna: formData.brojRacuna,
                    status: formData.status,
                    artikli: artikliZaSpremanje,
                    postupci: formData.postupci
                };
                
                try {
                    if (editingId) {
                        await apiCall(`nalozi/${editingId}`, 'PUT', nalogData, userId);
                        const updated = await apiCall(`nalozi/${editingId}`, 'GET', null, userId);
                        // Dodaj kontakt podatke iz klijenta
                        const klijent = kupci.find(k => k.id == updated.klijentId);
                        const updatedSaKontaktom = {
                            ...updated,
                            kontaktOsoba: klijent?.kontakt || updated.kontaktOsoba || '',
                            telefon: klijent?.telefon || updated.telefon || '',
                            email: klijent?.email || updated.email || ''
                        };
                        setRadniNalozi(radniNalozi.map(n => n.id === editingId ? updatedSaKontaktom : n));
                    } else {
                        const result = await apiCall('nalozi', 'POST', nalogData, userId);
                        const newNalog = await apiCall(`nalozi/${result.id}`, 'GET', null, userId);
                        // Dodaj kontakt podatke iz klijenta
                        const klijent = kupci.find(k => k.id == newNalog.klijentId);
                        const newNalogSaKontaktom = {
                            ...newNalog,
                            kontaktOsoba: klijent?.kontakt || newNalog.kontaktOsoba || '',
                            telefon: klijent?.telefon || newNalog.telefon || '',
                            email: klijent?.email || newNalog.email || ''
                        };
                        setRadniNalozi([newNalogSaKontaktom, ...radniNalozi]);
                    }
                    resetForm();
                    setShowForm(false);
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                } finally {
                    setSaving(false);
                }
            };

            const handleDelete = async (id) => {
                if (!confirm('Jeste li sigurni?')) return;
                try {
                    await apiCall(`nalozi/${id}`, 'DELETE', null, userId);
                    // Za usera: ukloni iz liste (ne zna da je soft delete)
                    // Za admina: oznaƒçi kao obrisan
                    if (isAdmin) {
                        setRadniNalozi(radniNalozi.map(n => 
                            n.id === id ? { ...n, obrisan: true, obrisanAt: new Date().toISOString() } : n
                        ));
                    } else {
                        setRadniNalozi(radniNalozi.filter(n => n.id !== id));
                    }
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleRestore = async (id) => {
                try {
                    await apiCall(`nalozi/${id}?restore=1`, 'PUT', {}, userId);
                    // Ponovo uƒçitaj nalog s artiklima
                    const restoredNalog = await apiCall(`nalozi/${id}`, 'GET', null, userId);
                    // Dodaj kontakt podatke iz klijenta
                    const klijent = kupci.find(k => k.id == restoredNalog.klijentId);
                    const restoredSaKontaktom = {
                        ...restoredNalog,
                        kontaktOsoba: klijent?.kontakt || restoredNalog.kontaktOsoba || '',
                        telefon: klijent?.telefon || restoredNalog.telefon || '',
                        email: klijent?.email || restoredNalog.email || '',
                        obrisan: false,
                        obrisanAt: null,
                        obrisanBy: null
                    };
                    setRadniNalozi(radniNalozi.map(n => 
                        n.id === id ? restoredSaKontaktom : n
                    ));
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleView = async (nalog) => {
                try {
                    const completeNalog = await apiCall(`nalozi/${nalog.id}`, 'GET', null, userId);
                    setViewingNalog(completeNalog);
                    
                    // Uvijek uƒçitaj utro≈°ene materijale
                    try {
                        const utroseni = await apiCall(`rasknjizi/${nalog.id}`, 'GET', null, userId);
                        setUtroseniMaterijali(utroseni || []);
                    } catch (e) {
                        setUtroseniMaterijali([]);
                    }
                    
                    // Reset forme za novi materijal
                    setNoviMaterijalId('');
                    setNoviMaterijalKol('');
                } catch (error) {
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const handleEdit = async (nalog) => {
                try {
                    console.log('üîß Otvaranje naloga za ureƒëivanje:', nalog.id);
                    
                    const completeNalog = await apiCall(`nalozi/${nalog.id}`, 'GET', null, userId);
                    
                    console.log('üì¶ Uƒçitani nalog:', completeNalog);
                    console.log('üìã Artikli u nalogu:', completeNalog.artikli);
                    console.log('‚öôÔ∏è Postupci u nalogu:', completeNalog.postupci);
                    
                    // Izraƒçunaj ukupnaCijena za svaki artikl
                    const artikliSaUkupnom = (completeNalog.artikli || []).map(a => ({
                        ...a,
                        ukupnaCijena: (parseFloat(a.cijena || 0) * parseFloat(a.kolicina || 0)).toFixed(2)
                    }));
                    
                    setFormData({
                        broj: completeNalog.broj,
                        nazivNaloga: completeNalog.nazivNaloga || '',
                        datum: completeNalog.datum,
                        rokIzrade: completeNalog.rokIzrade || '',
                        klijentId: completeNalog.klijentId,
                        klijentNaziv: completeNalog.klijentNaziv,
                        kontaktOsoba: completeNalog.kontaktOsoba || '',
                        telefon: completeNalog.telefon || '',
                        email: completeNalog.email || '',
                        opisProblema: completeNalog.opisProblema || '',
                        brojRacuna: completeNalog.brojRacuna || '',
                        status: completeNalog.status,
                        artikli: artikliSaUkupnom,
                        postupci: completeNalog.postupci || [],
                        sviMaterijali: completeNalog.sviMaterijali || []
                    });
                    
                    setEditingId(nalog.id);
                    setShowForm(true);
                    
                    console.log('‚úÖ FormData postavljen');
                } catch (error) {
                    console.error('‚ùå Gre≈°ka pri uƒçitavanju naloga:', error);
                    alert('Gre≈°ka: ' + error.message);
                }
            };

            const resetForm = () => {
                setFormData({
                    broj: getNextNalogBroj(radniNalozi),
                    nazivNaloga: '',
                    datum: new Date().toISOString().split('T')[0],
                    rokIzrade: '',
                    klijentId: '',
                    klijentNaziv: '',
                    kontaktOsoba: '',
                    telefon: '',
                    email: '',
                    opisProblema: '',
                    brojRacuna: '',
                    status: 'u_tijeku',
                    artikli: [],
                    postupci: [],
                    sviMaterijali: []
                });
                setEditingId(null);
            };

            const handleNewForm = () => {
                resetForm();
                setFormData(prev => ({ ...prev, broj: getNextNalogBroj(radniNalozi) }));
                setShowForm(true);
            };

            const handleKlijentChange = (klijentId) => {
                const klijent = kupci.find(k => k.id == klijentId);
                setFormData({
                    ...formData,
                    klijentId: klijentId,
                    klijentNaziv: klijent ? klijent.naziv : '',
                    kontaktOsoba: klijent ? klijent.kontaktOsoba : '',
                    telefon: klijent ? klijent.telefon : '',
                    email: klijent ? klijent.email : ''
                });
            };

            const addArtikl = () => {
                setFormData({
                    ...formData,
                    artikli: [...formData.artikli, { artiklId: '', naziv: '', kolicina: 1, cijena: 0, ukupnaCijena: 0, format: '', opis: '', napomena: '' }]
                });
            };

            const removeArtikl = async (index) => {
                const artikl = formData.artikli[index];
                const spremljeniMaterijali = (artikl.materijali || []).filter(m => m.id);
                
                if (spremljeniMaterijali.length > 0) {
                    if (!confirm(`Artikl ima ${spremljeniMaterijali.length} utro≈°enih materijala.\n\nMaknuti i vratiti na zalihu?`)) {
                        return;
                    }
                    for (const mat of spremljeniMaterijali) {
                        try {
                            await apiCall(`nalog-materijali/${mat.id}`, 'DELETE', null, userId);
                        } catch (error) {
                            console.error('Gre≈°ka:', error);
                        }
                    }
                }
                
                setFormData({
                    ...formData,
                    artikli: formData.artikli.filter((_, i) => i !== index)
                });
            };

            const updateArtikl = (index, field, value) => {
                const updated = [...formData.artikli];
                updated[index] = { ...updated[index], [field]: value };
                
                if (field === 'artiklId' && value) {
                    const artikl = artikli.find(a => a.id == value);
                    if (artikl) {
                        updated[index].naziv = artikl.naziv;
                        updated[index].cijena = artikl.cijena;
                        // Ako artikl ima cijenu, postavi ukupnu cijenu
                        const kolicina = parseFloat(updated[index].kolicina) || 1;
                        updated[index].ukupnaCijena = (artikl.cijena * kolicina).toFixed(2);
                        
                        // Dodaj predefinirane postupke artikla
                        if (artikl.postupci && artikl.postupci.length > 0) {
                            updated[index].postupci = artikl.postupci.map(p => ({
                                postupakId: p.postupakId,
                                naziv: p.naziv,
                                kolicina: p.defaultKolicina || 1,
                                cijena: p.defaultCijena || 0,
                                zavrsen: false
                            }));
                        } else {
                            updated[index].postupci = [];
                        }
                    }
                }
                
                // Ako se mijenja ukupna cijena, izraƒçunaj cijenu po komadu
                if (field === 'ukupnaCijena') {
                    const kolicina = parseFloat(updated[index].kolicina) || 1;
                    const ukupna = parseFloat(value) || 0;
                    updated[index].cijena = kolicina > 0 ? (ukupna / kolicina).toFixed(2) : 0;
                }
                
                // Ako se mijenja koliƒçina, ponovo izraƒçunaj cijenu po komadu iz ukupne cijene
                if (field === 'kolicina') {
                    const ukupna = parseFloat(updated[index].ukupnaCijena) || 0;
                    const kolicina = parseFloat(value) || 1;
                    updated[index].cijena = kolicina > 0 ? (ukupna / kolicina).toFixed(2) : 0;
                }
                
                setFormData({ ...formData, artikli: updated });
            };

            // Funkcije za postupke artikla na nalogu
            const addArtiklPostupakNaNalogu = (artiklIndex) => {
                const updated = [...formData.artikli];
                if (!updated[artiklIndex].postupci) updated[artiklIndex].postupci = [];
                updated[artiklIndex].postupci.push({ postupakId: '', naziv: '', kolicina: 1, cijena: 0, zavrsen: false });
                setFormData({ ...formData, artikli: updated });
            };

            const updateArtiklPostupakNaNalogu = (artiklIndex, postupakIndex, field, value) => {
                const updated = [...formData.artikli];
                updated[artiklIndex].postupci[postupakIndex][field] = value;
                
                if (field === 'postupakId' && value) {
                    const postupak = postupci.find(p => String(p.id) === String(value));
                    if (postupak) {
                        updated[artiklIndex].postupci[postupakIndex].naziv = postupak.naziv;
                        updated[artiklIndex].postupci[postupakIndex].cijena = postupak.cijena || 0;
                    }
                }
                
                setFormData({ ...formData, artikli: updated });
            };

            const removeArtiklPostupakNaNalogu = (artiklIndex, postupakIndex) => {
                const updated = [...formData.artikli];
                updated[artiklIndex].postupci = updated[artiklIndex].postupci.filter((_, i) => i !== postupakIndex);
                setFormData({ ...formData, artikli: updated });
            };

            // Funkcije za materijale artikla na nalogu
            const addArtiklMaterijal = (artiklIndex) => {
                const updated = [...formData.artikli];
                if (!updated[artiklIndex].materijali) updated[artiklIndex].materijali = [];
                updated[artiklIndex].materijali.push({ materijalId: '', naziv: '', kolicina: '', jedinicaMjere: '', cijena: 0 });
                setFormData({ ...formData, artikli: updated });
            };

            const updateArtiklMaterijal = (artiklIndex, matIndex, field, value) => {
                const updated = [...formData.artikli];
                if (!updated[artiklIndex].materijali) updated[artiklIndex].materijali = [];
                updated[artiklIndex].materijali[matIndex][field] = value;
                setFormData({ ...formData, artikli: updated });
            };

            const setArtiklMaterijal = (artiklIndex, matIndex, materijalObj) => {
                const updated = [...formData.artikli];
                if (!updated[artiklIndex].materijali) updated[artiklIndex].materijali = [];
                updated[artiklIndex].materijali[matIndex] = {
                    ...updated[artiklIndex].materijali[matIndex],
                    materijalId: materijalObj.id,
                    naziv: materijalObj.naziv,
                    jedinicaMjere: materijalObj.jedinicaMjere,
                    cijena: materijalObj.cijena
                };
                setFormData({ ...formData, artikli: updated });
            };

            const removeArtiklMaterijal = (artiklIndex, matIndex) => {
                const updated = [...formData.artikli];
                updated[artiklIndex].materijali = updated[artiklIndex].materijali.filter((_, i) => i !== matIndex);
                setFormData({ ...formData, artikli: updated });
            };

            const addPostupak = () => {
                setFormData({
                    ...formData,
                    postupci: [...formData.postupci, { postupakId: '', naziv: '', kolicina: 1, cijena: 0, trajanjeMin: '' }]
                });
            };

            const removePostupak = (index) => {
                setFormData({
                    ...formData,
                    postupci: formData.postupci.filter((_, i) => i !== index)
                });
            };

            const updatePostupak = (index, field, value) => {
                const updated = [...formData.postupci];
                if (field === 'postupakId') {
                    const postupak = postupci.find(p => p.id == value);
                    updated[index] = {
                        ...updated[index],
                        postupakId: value,
                        naziv: postupak ? postupak.naziv : '',
                        cijena: postupak && postupak.defaultCijena ? parseFloat(postupak.defaultCijena) : updated[index].cijena
                    };
                } else {
                    updated[index] = { ...updated[index], [field]: value };
                }
                setFormData({ ...formData, postupci: updated });
            };

            const getUkupnaCijenaPostupaka = (postupciList) => {
                if (!postupciList || postupciList.length === 0) return 0;
                return postupciList.reduce((sum, p) => {
                    const cijena = parseFloat(p.cijena) || 0;
                    const kolicina = parseFloat(p.kolicina) || 1;
                    return sum + (cijena * kolicina);
                }, 0);
            };

            // Renderiranje forme za nalog (koristi se i za novi i za edit)
            const renderNalogForm = (isInline = false) => (
                <div className={isInline ? "bg-blue-50 border-2 border-blue-300 p-4" : "bg-white rounded-lg shadow-sm border p-4"}>
                    <h3 className="text-base font-semibold mb-3">{editingId ? `Uredi Nalog ${formData.broj}` : 'Novi Nalog'}</h3>
                    <form onSubmit={handleSubmit} className="space-y-2">
                        <div className="grid grid-cols-4 gap-2">
                            <div>
                                <label className="block text-xs font-medium mb-1">Broj *</label>
                                <input
                                    type="text"
                                    value={formData.broj}
                                    onChange={(e) => setFormData({ ...formData, broj: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm bg-gray-100"
                                    required
                                    disabled={saving}
                                    readOnly={editingId !== null}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium mb-1">Naziv naloga</label>
                                <input
                                    type="text"
                                    value={formData.nazivNaloga}
                                    onChange={(e) => setFormData({ ...formData, nazivNaloga: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    placeholder="Kratki naziv"
                                    disabled={saving}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium mb-1">Datum *</label>
                                <input
                                    type="date"
                                    value={formData.datum}
                                    onChange={(e) => setFormData({ ...formData, datum: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    required
                                    disabled={saving}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium mb-1">Rok izrade *</label>
                                <input
                                    type="date"
                                    value={formData.rokIzrade}
                                    onChange={(e) => setFormData({ ...formData, rokIzrade: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    required
                                    disabled={saving}
                                />
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-2">
                            <div className="col-span-2">
                                <label className="block text-xs font-medium mb-1">Klijent *</label>
                                {editingId ? (
                                    <div className="w-full border rounded-lg px-3 py-2 bg-gray-100 text-gray-700">
                                        {formData.klijentNaziv || 'Nije odabrano'}
                                    </div>
                                ) : (
                                    <KlijentSelect
                                        kupci={kupci}
                                        value={formData.klijentId}
                                        onChange={(klijentId) => {
                                            const klijent = kupci.find(k => String(k.id) === String(klijentId));
                                            setFormData({
                                                ...formData,
                                                klijentId: klijentId,
                                                klijentNaziv: klijent?.naziv || '',
                                                kontaktOsoba: klijent?.kontakt || '',
                                                telefon: klijent?.telefon || '',
                                                email: klijent?.email || ''
                                            });
                                        }}
                                        disabled={saving}
                                        required
                                        small
                                    />
                                )}
                            </div>
                            <div>
                                <label className="block text-xs font-medium mb-1">Status</label>
                                <select
                                    value={formData.status}
                                    onChange={(e) => setFormData({ ...formData, status: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    disabled={saving}
                                >
                                    <option value="u_tijeku">U tijeku</option>
                                    <option value="zavrsen">Zavr≈°en</option>
                                </select>
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-2">
                            <div>
                                <label className="block text-xs font-medium mb-1">Kontakt osoba</label>
                                <input
                                    type="text"
                                    value={formData.kontaktOsoba}
                                    onChange={(e) => setFormData({ ...formData, kontaktOsoba: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    disabled={saving}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium mb-1">Telefon</label>
                                <input
                                    type="text"
                                    value={formData.telefon}
                                    onChange={(e) => setFormData({ ...formData, telefon: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    disabled={saving}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium mb-1">Broj raƒçuna</label>
                                <input
                                    type="text"
                                    value={formData.brojRacuna}
                                    onChange={(e) => setFormData({ ...formData, brojRacuna: e.target.value })}
                                    className="w-full border rounded px-2 py-1 text-sm"
                                    placeholder="Unesi broj nakon fakturiranja"
                                    disabled={saving}
                                />
                            </div>
                        </div>

                        {/* Artikli sekcija */}
                        <div className="border-t pt-2 mt-2">
                            <div className="flex items-center gap-2 mb-2">
                                <label className="text-sm font-semibold">üì¶ Artikli</label>
                                <button
                                    type="button"
                                    onClick={addArtikl}
                                    className="bg-primary-100 text-primary-700 px-2 py-1 rounded text-xs hover:bg-primary-200"
                                    disabled={saving}
                                >
                                    + Dodaj
                                </button>
                            </div>
                            {formData.artikli.length > 0 && (
                                <div className="space-y-2 max-h-[50vh] overflow-y-auto">
                                    {formData.artikli.map((artikl, index) => (
                                        <div key={index} className="bg-gray-50 rounded p-2 border">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="text-sm font-bold text-gray-500 w-6">{index + 1}.</span>
                                                <span className="text-xs text-gray-600 flex-1">{artikl.naziv || 'Novi artikl'}</span>
                                                <button
                                                    type="button"
                                                    onClick={() => removeArtikl(index)}
                                                    className="text-red-500 hover:text-red-700 text-sm"
                                                    disabled={saving}
                                                >
                                                    ‚úï
                                                </button>
                                            </div>
                                            <div className="grid grid-cols-12 gap-1 items-end ml-6">
                                                <div className="col-span-3">
                                                    <label className="block text-xs text-gray-500 mb-0.5">Artikl</label>
                                                    <ArtiklAutocomplete
                                                        artikli={artikli}
                                                        value={artikl.artiklId}
                                                        onChange={(artiklId) => updateArtikl(index, 'artiklId', artiklId)}
                                                        disabled={saving}
                                                    />
                                                </div>
                                                <div className="col-span-1">
                                                    <label className="block text-xs text-gray-500 mb-0.5">Kol.</label>
                                                    <input
                                                        type="number"
                                                        value={artikl.kolicina}
                                                        onChange={(e) => updateArtikl(index, 'kolicina', e.target.value)}
                                                        className="w-full border rounded px-1 py-1 text-xs"
                                                        min="0.01"
                                                        step="0.01"
                                                        disabled={saving}
                                                    />
                                                </div>
                                                <div className="col-span-2">
                                                    <label className="block text-xs text-gray-500 mb-0.5">Format</label>
                                                    <input
                                                        type="text"
                                                        value={artikl.format || ''}
                                                        onChange={(e) => updateArtikl(index, 'format', e.target.value)}
                                                        className="w-full border rounded px-1 py-1 text-xs"
                                                        placeholder="A4, 15x33..."
                                                        disabled={saving}
                                                    />
                                                </div>
                                                <div className="col-span-3">
                                                    <label className="block text-xs text-gray-500 mb-0.5">Opis</label>
                                                    <input
                                                        type="text"
                                                        value={artikl.opis || ''}
                                                        onChange={(e) => updateArtikl(index, 'opis', e.target.value)}
                                                        className="w-full border rounded px-1 py-1 text-xs"
                                                        placeholder="4+0, sjajni papir..."
                                                        disabled={saving}
                                                    />
                                                </div>
                                                <div className="col-span-1">
                                                    <label className="block text-xs text-gray-500 mb-0.5">Cijena</label>
                                                    <input
                                                        type="number"
                                                        value={artikl.cijena}
                                                        onChange={(e) => updateArtikl(index, 'cijena', e.target.value)}
                                                        className="w-full border rounded px-1 py-1 text-xs"
                                                        step="0.01"
                                                        disabled={saving}
                                                    />
                                                </div>
                                                <div className="col-span-2 text-right">
                                                    <label className="block text-xs text-gray-500 mb-0.5">Ukupno</label>
                                                    <span className="text-xs font-medium">{((artikl.kolicina || 0) * (artikl.cijena || 0)).toFixed(2)} EUR</span>
                                                </div>
                                            </div>
                                            
                                            {/* Materijali za ovaj artikl */}
                                            {editingId && artikl.id && (
                                                <div className="mt-2 ml-6 border-l-2 border-blue-200 pl-3">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className="text-xs font-medium text-blue-600">üß± Materijali</span>
                                                        <button
                                                            type="button"
                                                            onClick={() => {
                                                                const updated = [...formData.artikli];
                                                                updated[index].materijali = [...(updated[index].materijali || []), { materijalId: '', kolicina: '', napomena: '' }];
                                                                setFormData({ ...formData, artikli: updated });
                                                            }}
                                                            className="text-xs text-blue-600 hover:text-blue-800 bg-blue-100 px-1.5 py-0.5 rounded"
                                                            disabled={saving}
                                                        >
                                                            + Dodaj
                                                        </button>
                                                    </div>
                                                    {(artikl.materijali || []).map((m, mIdx) => (
                                                        <div key={mIdx} className="flex items-center gap-1 mb-1">
                                                            <select
                                                                value={m.materijalId || ''}
                                                                onChange={(e) => {
                                                                    const mat = materijali.find(x => String(x.id) === e.target.value);
                                                                    const updated = [...formData.artikli];
                                                                    updated[index].materijali[mIdx] = {
                                                                        ...updated[index].materijali[mIdx],
                                                                        materijalId: e.target.value,
                                                                        naziv: mat?.naziv || '',
                                                                        jedinicaMjere: mat?.jedinicaMjere || ''
                                                                    };
                                                                    setFormData({ ...formData, artikli: updated });
                                                                }}
                                                                className="flex-1 border rounded px-1 py-0.5 text-xs"
                                                                disabled={saving}
                                                            >
                                                                <option value="">-- materijal --</option>
                                                                {materijali.map(mat => (
                                                                    <option key={mat.id} value={mat.id}>{mat.naziv}</option>
                                                                ))}
                                                            </select>
                                                            <input
                                                                type="number"
                                                                value={m.kolicina || ''}
                                                                onChange={(e) => {
                                                                    const updated = [...formData.artikli];
                                                                    updated[index].materijali[mIdx].kolicina = e.target.value;
                                                                    setFormData({ ...formData, artikli: updated });
                                                                }}
                                                                className="w-16 border rounded px-1 py-0.5 text-xs"
                                                                placeholder="Kol."
                                                                step="0.01"
                                                                disabled={saving}
                                                            />
                                                            <span className="text-xs text-gray-400 w-8">{m.jedinicaMjere || ''}</span>
                                                            <button
                                                                type="button"
                                                                onClick={() => {
                                                                    const updated = [...formData.artikli];
                                                                    updated[index].materijali = updated[index].materijali.filter((_, i) => i !== mIdx);
                                                                    setFormData({ ...formData, artikli: updated });
                                                                }}
                                                                className="text-red-400 hover:text-red-600 text-xs"
                                                                disabled={saving}
                                                            >
                                                                ‚úï
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                            
                                            {/* Podsjetnici za ovaj artikl */}
                                            {editingId && artikl.id && (
                                                <div className="mt-2 ml-6 border-l-2 border-yellow-200 pl-3">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className="text-xs font-medium text-yellow-600">üìå Podsjetnici</span>
                                                        <button
                                                            type="button"
                                                            onClick={() => {
                                                                const updated = [...formData.artikli];
                                                                updated[index].podsjetnici = [...(updated[index].podsjetnici || []), { tekst: '', prioritet: 'srednji', isNew: true }];
                                                                setFormData({ ...formData, artikli: updated });
                                                            }}
                                                            className="text-xs text-yellow-600 hover:text-yellow-800 bg-yellow-100 px-1.5 py-0.5 rounded"
                                                            disabled={saving}
                                                        >
                                                            + Dodaj
                                                        </button>
                                                    </div>
                                                    {(artikl.podsjetnici || []).map((p, pIdx) => (
                                                        <div key={pIdx} className={`flex items-center gap-1 mb-1 ${p.zavrsen ? 'opacity-50' : ''}`}>
                                                            {!p.zavrsen ? (
                                                                <>
                                                                    <select
                                                                        value={p.prioritet || 'srednji'}
                                                                        onChange={(e) => {
                                                                            const updated = [...formData.artikli];
                                                                            updated[index].podsjetnici[pIdx].prioritet = e.target.value;
                                                                            setFormData({ ...formData, artikli: updated });
                                                                        }}
                                                                        className="w-20 border rounded px-1 py-0.5 text-xs"
                                                                        disabled={saving}
                                                                    >
                                                                        <option value="nizak">Nizak</option>
                                                                        <option value="srednji">Srednji</option>
                                                                        <option value="visok">Visok</option>
                                                                    </select>
                                                                    <input
                                                                        type="text"
                                                                        value={p.tekst || ''}
                                                                        onChange={(e) => {
                                                                            const updated = [...formData.artikli];
                                                                            updated[index].podsjetnici[pIdx].tekst = e.target.value;
                                                                            setFormData({ ...formData, artikli: updated });
                                                                        }}
                                                                        className="flex-1 border rounded px-1 py-0.5 text-xs"
                                                                        placeholder="Tekst podsjetnika..."
                                                                        disabled={saving}
                                                                    />
                                                                    <button
                                                                        type="button"
                                                                        onClick={async () => {
                                                                            if (p.id) {
                                                                                await apiCall(`podsjetnici/${p.id}`, 'DELETE', null, userId);
                                                                            }
                                                                            const updated = [...formData.artikli];
                                                                            updated[index].podsjetnici = updated[index].podsjetnici.filter((_, i) => i !== pIdx);
                                                                            setFormData({ ...formData, artikli: updated });
                                                                        }}
                                                                        className="text-red-400 hover:text-red-600 text-xs"
                                                                        disabled={saving}
                                                                    >
                                                                        ‚úï
                                                                    </button>
                                                                </>
                                                            ) : (
                                                                <span className="text-xs text-gray-400 line-through flex-1">‚úì {p.tekst}</span>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Buttons */}
                        <div className="flex gap-2 pt-2 border-t">
                            <button
                                type="button"
                                onClick={() => { resetForm(); setShowForm(false); }}
                                className="px-3 py-1 border rounded hover:bg-gray-100 text-sm"
                                disabled={saving}
                            >
                                Odustani
                            </button>
                            <button
                                type="submit"
                                className="px-3 py-1 bg-primary-600 text-white rounded hover:bg-primary-700 text-sm"
                                disabled={saving}
                            >
                                {saving ? 'Spremanje...' : 'Spremi'}
                            </button>
                        </div>
                    </form>
                </div>
            );

            return (
                <div className="space-y-4">
                    <div className="flex justify-between items-center">
                        <h2 className="text-xl font-semibold text-gray-800">üìã Radni Nalozi</h2>
                        <button
                            onClick={handleNewForm}
                            className="bg-primary-600 text-white px-4 py-2 rounded hover:bg-primary-700 text-sm font-medium"
                        >
                            + Novi Nalog
                        </button>
                    </div>

                    {showForm && !editingId && renderNalogForm(false)}

                    {viewingNalog && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setViewingNalog(null)}>
                            <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                                <div className="p-6">
                                    <div className="flex justify-between items-start mb-6">
                                        <div>
                                            <h2 className="text-2xl font-bold text-gray-800">{viewingNalog.broj}</h2>
                                            <p className="text-gray-600">Datum: {formatDate(viewingNalog.datum)}</p>
                                            {viewingNalog.klijentNaziv && (
                                                <p className="text-gray-800 font-medium">üë• {viewingNalog.klijentNaziv}</p>
                                            )}
                                            {viewingNalog.rasknjizen && (
                                                <span className="inline-block mt-1 px-2 py-1 bg-green-100 text-green-800 text-xs rounded">
                                                    ‚úì Rasknji≈æeno
                                                </span>
                                            )}
                                        </div>
                                        <button onClick={() => setViewingNalog(null)} className="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
                                    </div>
                                    
                                    {viewingNalog.artikli && viewingNalog.artikli.length > 0 && (
                                        <div className="mb-6">
                                            <h3 className="font-bold mb-3">üì¶ Artikli:</h3>
                                            <table className="w-full border">
                                                <thead className="bg-gray-50">
                                                    <tr>
                                                        <th className="px-4 py-2 text-left">Naziv</th>
                                                        <th className="px-4 py-2 text-right">Koliƒçina</th>
                                                        <th className="px-4 py-2 text-right">Cijena</th>
                                                        <th className="px-4 py-2 text-right">Ukupno</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {viewingNalog.artikli.map((a, i) => (
                                                        <React.Fragment key={i}>
                                                            <tr>
                                                                <td className="px-4 py-2">{a.naziv}</td>
                                                                <td className="px-4 py-2 text-right">{a.kolicina}</td>
                                                                <td className="px-4 py-2 text-right">{parseFloat(a.cijena || 0).toFixed(2)} EUR</td>
                                                                <td className="px-4 py-2 text-right font-bold">{(parseFloat(a.kolicina || 0) * parseFloat(a.cijena || 0)).toFixed(2)} EUR</td>
                                                            </tr>
                                                            {a.napomena && (
                                                                <tr>
                                                                    <td colSpan="4" className="px-4 py-2 text-sm bg-gray-50 italic text-gray-600">
                                                                        <span className="font-medium">Napomena: </span>
                                                                        {a.napomena}
                                                                    </td>
                                                                </tr>
                                                            )}
                                                        </React.Fragment>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                    
                                    {/* Podsjetnici */}
                                    {viewingNalog.artikli && viewingNalog.artikli.some(a => a.podsjetnici && a.podsjetnici.length > 0) && (
                                        <div className="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                            <h3 className="font-bold mb-3 text-yellow-800">üìå Podsjetnici:</h3>
                                            {viewingNalog.artikli.filter(a => a.podsjetnici && a.podsjetnici.length > 0).map((artikl, aIdx) => (
                                                <div key={aIdx} className="mb-2">
                                                    <div className="text-sm text-gray-600 font-medium">{artikl.naziv}:</div>
                                                    {artikl.podsjetnici.map((p, pIdx) => (
                                                        <div key={pIdx} className={`ml-4 text-sm ${p.zavrsen ? 'line-through text-gray-400' : p.prioritet === 'visok' ? 'text-red-700 font-medium' : 'text-gray-700'}`}>
                                                            {p.zavrsen ? '‚úì' : ''}{p.prioritet === 'visok' && !p.zavrsen ? '‚ö° ' : ''}{p.tekst}
                                                        </div>
                                                    ))}
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {/* Gumbi */}
                                    <div className="flex gap-2 flex-wrap">
                                        <button 
                                            onClick={() => { setViewingNalog(null); handleEdit(viewingNalog); }}
                                            className="px-4 py-2 bg-primary-600 text-white rounded hover:bg-primary-700"
                                        >
                                            ‚úèÔ∏è Uredi nalog
                                        </button>
                                        <button onClick={() => setViewingNalog(null)} className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                                            Zatvori
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL ZA RASKNJI≈ΩENJE */}
                    {showRasknjizenjeModal && rasknjizenjeNalog && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                                <div className="p-6">
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <h2 className="text-xl font-bold text-primary-800">üß± Rasknji≈æenje materijala</h2>
                                            <p className="text-gray-600">Nalog: {rasknjizenjeNalog.broj} - {rasknjizenjeNalog.nazivNaloga}</p>
                                        </div>
                                        <button onClick={() => setShowRasknjizenjeModal(false)} className="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
                                    </div>

                                    {/* Artikli s materijalima */}
                                    {rasknjizenjeNalog.artikli && rasknjizenjeNalog.artikli.length > 0 ? (
                                        <div className="space-y-4">
                                            {rasknjizenjeNalog.artikli.map((artikl, artiklIdx) => (
                                                <div key={artiklIdx} className="border rounded-lg overflow-hidden">
                                                    {/* Zaglavlje artikla */}
                                                    <div className="bg-primary-100 px-4 py-2 flex justify-between items-center">
                                                        <div>
                                                            <span className="font-bold text-blue-900">üì¶ {artikl.naziv}</span>
                                                            <span className="ml-2 text-primary-700">√ó {artikl.kolicina}</span>
                                                            {artikl.cijena > 0 && (
                                                                <span className="ml-2 text-primary-600 text-sm">({parseFloat(artikl.cijena).toFixed(2)} EUR)</span>
                                                            )}
                                                        </div>
                                                        <button
                                                            onClick={() => addRasknjizenjeMaterijal(artiklIdx)}
                                                            className="px-2 py-1 bg-primary-500 text-white rounded text-sm hover:bg-primary-600"
                                                        >
                                                            + Materijal
                                                        </button>
                                                    </div>
                                                    
                                                    {/* Materijali za ovaj artikl */}
                                                    <div className="p-3 bg-primary-50">
                                                        {(!rasknjizenjeMaterijali[artiklIdx] || rasknjizenjeMaterijali[artiklIdx].length === 0) ? (
                                                            <p className="text-gray-500 text-sm text-center py-2">
                                                                Nema materijala - klikni "+ Materijal" za dodavanje
                                                            </p>
                                                        ) : (
                                                            <div className="space-y-2">
                                                                {rasknjizenjeMaterijali[artiklIdx].map((m, matIdx) => (
                                                                    <div key={matIdx} className="flex items-center gap-2 bg-white rounded px-2 py-1 border border-primary-200">
                                                                        <MaterijalSelect
                                                                            materijali={materijali}
                                                                            value={m.materijalId || ''}
                                                                            onChange={(mat) => setRasknjizenjeMat(artiklIdx, matIdx, mat)}
                                                                        />
                                                                        <input
                                                                            type="number"
                                                                            step="0.01"
                                                                            min="0"
                                                                            value={m.kolicina || ''}
                                                                            onChange={(e) => updateRasknjizenjeMaterijal(artiklIdx, matIdx, 'kolicina', e.target.value)}
                                                                            className="w-24 border rounded px-2 py-1 text-sm text-right"
                                                                            placeholder="Koliƒçina"
                                                                        />
                                                                        {m.jedinicaMjere && (
                                                                            <span className="text-xs text-gray-500 w-8">{m.jedinicaMjere}</span>
                                                                        )}
                                                                        {m.cijena > 0 && m.kolicina > 0 && (
                                                                            <span className="text-sm text-primary-700 font-medium w-20 text-right">
                                                                                {(parseFloat(m.kolicina) * parseFloat(m.cijena)).toFixed(2)} ‚Ç¨
                                                                            </span>
                                                                        )}
                                                                        <button
                                                                            onClick={() => removeRasknjizenjeMaterijal(artiklIdx, matIdx)}
                                                                            className="text-red-500 hover:text-red-700"
                                                                        >
                                                                            ‚úï
                                                                        </button>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="text-center py-8 text-gray-500">
                                            Nema artikala na nalogu
                                        </div>
                                    )}

                                    {/* Ukupno */}
                                    {(() => {
                                        let ukupno = 0;
                                        Object.values(rasknjizenjeMaterijali).forEach(mats => {
                                            (mats || []).forEach(m => {
                                                if (m.kolicina > 0 && m.cijena > 0) {
                                                    ukupno += parseFloat(m.kolicina) * parseFloat(m.cijena);
                                                }
                                            });
                                        });
                                        if (ukupno > 0) {
                                            return (
                                                <div className="mt-4 text-right font-bold text-primary-800 text-lg">
                                                    Ukupna vrijednost materijala: {ukupno.toFixed(2)} EUR
                                                </div>
                                            );
                                        }
                                        return null;
                                    })()}

                                    {/* Gumbi */}
                                    <div className="flex justify-end gap-2 pt-4 mt-4 border-t">
                                        <button
                                            onClick={() => setShowRasknjizenjeModal(false)}
                                            className="px-4 py-2 border rounded hover:bg-gray-100"
                                        >
                                            Odustani
                                        </button>
                                        <button
                                            onClick={executeRasknjizenje}
                                            disabled={rasknjizavanje}
                                            className="px-4 py-2 bg-primary-600 text-white rounded hover:bg-primary-700 disabled:opacity-50"
                                        >
                                            {rasknjizavanje ? '‚è≥ Rasknji≈æenje...' : '‚úì Raskni≈æi'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* TASKOVI - Opƒái podsjetnici */}
                    <TaskoviSekcija userId={userId} isAdmin={isAdmin} />

                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Broj</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Naziv naloga</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Datum</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Rok izrade</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Klijent</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Kontakt</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Telefon</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Broj raƒçuna</th>
                                    <th className="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Ukupno</th>
                                    <th className="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Akcije</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {(() => {
                                    // Filtriraj aktivne naloge (bez zavr≈°enih s brojem raƒçuna i bez obrisanih)
                                    const aktivniNalozi = radniNalozi.filter(nalog => 
                                        !nalog.obrisan && !(nalog.status === 'zavrsen' && nalog.brojRacuna && nalog.brojRacuna.trim() !== '')
                                    );
                                    
                                    // Obrisani nalozi (samo admin ih vidi)
                                    const obrisaniNalozi = radniNalozi.filter(nalog => nalog.obrisan);
                                    
                                    if (aktivniNalozi.length === 0 && obrisaniNalozi.length === 0) {
                                        return (
                                            <tr>
                                                <td colSpan="11" className="px-6 py-4 text-center text-gray-500">
                                                    Nema radnih naloga
                                                </td>
                                            </tr>
                                        );
                                    }
                                    
                                    // Grupiraj po statusu (samo u_tijeku i zavrsen)
                                    const uTijeku = aktivniNalozi.filter(n => n.status === 'u_tijeku' || n.status === 'otvoren' || !n.status);
                                    const zavrseni = aktivniNalozi.filter(n => n.status === 'zavrsen');
                                    
                                    return (
                                        <>
                                            {/* NALOZI U TIJEKU */}
                                            {uTijeku.length > 0 && (
                                                <>
                                                    <tr className="bg-yellow-100">
                                                        <td colSpan="11" className="px-4 py-3">
                                                            <h3 className="text-base font-bold text-yellow-900">‚öôÔ∏è NALOZI U TIJEKU ({uTijeku.length})</h3>
                                                        </td>
                                                    </tr>
                                                    {uTijeku.map((nalog, nalogIdx) => {
                                                        return (
                                        <React.Fragment key={nalog.id}>
                                            <tr className={`bg-green-50 hover:bg-green-100 text-xs ${!nalog.artikli || nalog.artikli.length === 0 ? 'nalog-divider' : ''}`}>
                                                <td className="px-3 py-2 font-medium">{nalog.broj}</td>
                                                <td className="px-3 py-2">
                                                    <span className="text-gray-700 font-medium">
                                                        {nalog.nazivNaloga || <span className="text-gray-400">-</span>}
                                                    </span>
                                                </td>
                                                <td className="px-3 py-2">
                                                    <div>{formatDate(nalog.datum)}</div>
                                                    {nalog.createdAt && (
                                                        <div className="text-[10px] text-gray-400">
                                                            {new Date(nalog.createdAt).toLocaleString('hr-HR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit'})}
                                                            {nalog.createdByName && ` ‚Ä¢ ${nalog.createdByName}`}
                                                        </div>
                                                    )}
                                                </td>
                                                <td className="px-3 py-2">
                                                    {nalog.rokIzrade ? (
                                                        <div>
                                                            <span className={
                                                                new Date(nalog.rokIzrade) < new Date() && nalog.status !== 'zavrsen' 
                                                                ? 'text-red-600 font-medium' 
                                                                : 'text-gray-900'
                                                            }>
                                                                {formatDate(nalog.rokIzrade)}
                                                            </span>
                                                            {(() => {
                                                                const rok = new Date(nalog.rokIzrade);
                                                                const danas = new Date();
                                                                danas.setHours(0,0,0,0);
                                                                rok.setHours(0,0,0,0);
                                                                const diffDays = Math.floor((danas - rok) / (1000 * 60 * 60 * 24));
                                                                if (diffDays > 0) {
                                                                    return <div className="text-red-600 font-bold text-xs mt-1">‚ö†Ô∏è KASNI - {diffDays} {diffDays === 1 ? 'dan' : 'dana'}</div>;
                                                                }
                                                                return null;
                                                            })()}
                                                        </div>
                                                    ) : (
                                                        <span className="text-gray-400">-</span>
                                                    )}
                                                </td>
                                                <td className="px-3 py-2">{nalog.klijentNaziv}</td>
                                                <td className="px-3 py-2">{nalog.kontaktOsoba || <span className="text-gray-400">-</span>}</td>
                                                <td className="px-3 py-2">{nalog.telefon || <span className="text-gray-400">-</span>}</td>
                                                <td className="px-3 py-2">
                                                    <span className="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-800">
                                                        U tijeku
                                                    </span>
                                                </td>
                                                <td className="px-3 py-2">
                                                    {nalog.brojRacuna ? (
                                                        <span className="font-medium text-gray-900">{nalog.brojRacuna}</span>
                                                    ) : (
                                                        <span className="text-gray-400">-</span>
                                                    )}
                                                </td>
                                                <td className="px-3 py-2 text-right">{getUkupnaCijena(nalog).toFixed(2)} EUR</td>
                                                <td className="px-3 py-2 text-right whitespace-nowrap">
                                                <button
                                                    onClick={async () => {
                                                        let fullNalog = nalog;
                                                        if (!nalog.artikli || nalog.artikli.length === 0) {
                                                            fullNalog = await apiCall('nalozi/' + nalog.id, 'GET', null, userId);
                                                        }
                                                        printRadniNalog(fullNalog);
                                                    }}
                                                    className="text-blue-600 hover:text-blue-900 mr-2"
                                                    title="Print otpremnica"
                                                >
                                                    üñ®Ô∏è
                                                </button>
                                                <button
                                                    onClick={() => handleView(nalog)}
                                                    className="text-green-600 hover:text-green-900 mr-2"
                                                >
                                                    Pregled
                                                </button>
                                                <button
                                                    onClick={() => handleEdit(nalog)}
                                                    className="text-primary-600 hover:text-blue-900 mr-2"
                                                >
                                                    Uredi
                                                </button>
                                                <button
                                                    onClick={() => handleDelete(nalog.id)}
                                                    className="text-red-600 hover:text-red-900"
                                                >
                                                    Obri≈°i
                                                </button>
                                            </td>
                                        </tr>
                                        {/* Artikli s podsjetnicima - prikazani odmah ispod naloga */}
                                        {nalog.artikli && nalog.artikli.length > 0 && (
                                            <tr className="border-l-4 border-primary-300 nalog-divider">
                                                <td colSpan="11" className="px-3 py-2">
                                                    {nalog.artikli.map((artikl, idx) => (
                                                        <div key={artikl.id} className={`mb-1 px-2 py-1 rounded ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-100'}`}>
                                                            <div className="flex items-center gap-2">
                                                                <span className="text-xs text-gray-500 font-medium w-5">{idx + 1}.</span>
                                                                <span className="text-xs text-gray-800 font-medium">{artikl.naziv}</span>
                                                                {artikl.format && (
                                                                    <span className="text-xs text-blue-600">| Format: {artikl.format}</span>
                                                                )}
                                                                {artikl.opis && (
                                                                    <span className="text-xs text-gray-600">| Opis: {artikl.opis}</span>
                                                                )}
                                                                <span className="text-xs text-gray-500">| Koliƒçina: {artikl.kolicina} {artikl.jedinica || 'kom'}</span>
                                                                <span className="text-xs text-gray-600">| Cijena: {artikl.cijena} EUR</span>
                                                                <span className="text-xs text-green-600 font-medium">| Ukupno: {(artikl.kolicina * artikl.cijena).toFixed(2)} EUR</span>
                                                            </div>
                                                            {artikl.napomena && (
                                                                <div className="ml-7 text-xs text-gray-600 italic">
                                                                    üìù {artikl.napomena}
                                                                </div>
                                                            )}
                                                            {artikl.materijali && artikl.materijali.length > 0 && (
                                                                <div className="ml-7 mt-0.5">
                                                                    {artikl.materijali.map((m, mIdx) => (
                                                                        <div key={mIdx} className="text-xs text-blue-600">
                                                                            üß± {m.naziv || m.materijalNaziv}: {m.kolicina} {m.jedinica || m.jedinicaMjere || 'kom'}
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            )}
                                                            {artikl.podsjetnici && artikl.podsjetnici.length > 0 && (
                                                                <div className="ml-7 mt-0.5">
                                                                    {artikl.podsjetnici.map((p, pIdx) => (
                                                                        <div key={pIdx} className={`text-xs ${p.zavrsen ? 'line-through text-gray-400' : p.prioritet === 'visok' ? 'text-red-600 font-semibold' : 'text-yellow-700'}`}>
                                                                            {p.zavrsen ? '‚úì' : 'üìå'} {p.prioritet === 'visok' && !p.zavrsen && '‚ö°'}{p.tekst}
                                                                            {(p.kreiraoIme || p.createdAt) && (
                                                                                <span className="text-gray-400 font-normal ml-2">
                                                                                    ({p.kreiraoIme}{p.createdAt && `, ${new Date(p.createdAt).toLocaleString('hr-HR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'})}`})
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>
                                                    ))}
                                                </td>
                                            </tr>
                                        )}
                                        {/* INLINE EDIT FORMA */}
                                        {editingId === nalog.id && (
                                            <tr>
                                                <td colSpan="11" className="p-0">
                                                    {renderNalogForm(true)}
                                                </td>
                                            </tr>
                                        )}
                                        </React.Fragment>
                                    );
                                    })}
                                                </>
                                            )}
                                            
                                            {/* ZAVR≈†ENI NALOZI */}
                                            {zavrseni.length > 0 && (
                                                <>
                                                    <tr className="bg-red-100">
                                                        <td colSpan="11" className="px-4 py-3">
                                                            <h3 className="text-base font-bold text-red-900">‚ö†Ô∏è ZAVR≈†ENI - HITNO NAPRAVITI RAƒåUNE!!!!! ({zavrseni.length})</h3>
                                                        </td>
                                                    </tr>
                                                    {zavrseni.map((nalog, nalogIdx) => {
                                                        return (
                                                        <React.Fragment key={nalog.id}>
                                            <tr className={`bg-green-50 hover:bg-green-100 text-xs ${!nalog.artikli || nalog.artikli.length === 0 ? 'nalog-divider' : ''}`}>
                                                <td className="px-3 py-2 font-medium">{nalog.broj}</td>
                                                <td className="px-3 py-2">
                                                    <span className="text-gray-700 font-medium">
                                                        {nalog.nazivNaloga || <span className="text-gray-400">-</span>}
                                                    </span>
                                                </td>
                                                <td className="px-3 py-2">
                                                    <div>{formatDate(nalog.datum)}</div>
                                                    {nalog.createdAt && (
                                                        <div className="text-[10px] text-gray-400">
                                                            {new Date(nalog.createdAt).toLocaleString('hr-HR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit'})}
                                                            {nalog.createdByName && ` ‚Ä¢ ${nalog.createdByName}`}
                                                        </div>
                                                    )}
                                                </td>
                                                <td className="px-3 py-2">
                                                    {nalog.rokIzrade ? (
                                                        <span className="text-gray-900">
                                                            {formatDate(nalog.rokIzrade)}
                                                        </span>
                                                    ) : (
                                                        <span className="text-gray-400">-</span>
                                                    )}
                                                </td>
                                                <td className="px-3 py-2">{nalog.klijentNaziv}</td>
                                                <td className="px-3 py-2">{nalog.kontaktOsoba || <span className="text-gray-400">-</span>}</td>
                                                <td className="px-3 py-2">{nalog.telefon || <span className="text-gray-400">-</span>}</td>
                                                <td className="px-3 py-2">
                                                    <span className="px-2 py-1 text-xs rounded bg-green-100 text-green-800">
                                                        Zavr≈°en
                                                    </span>
                                                </td>
                                                <td className="px-3 py-2">
                                                    <span className="text-red-600 font-bold">NEDOSTAJE!</span>
                                                </td>
                                                <td className="px-3 py-2 text-right">{getUkupnaCijena(nalog).toFixed(2)} EUR</td>
                                                <td className="px-3 py-2 text-right">
                                                <button
                                                    onClick={async () => {
                                                        let fullNalog = nalog;
                                                        if (!nalog.artikli || nalog.artikli.length === 0) {
                                                            fullNalog = await apiCall('nalozi/' + nalog.id, 'GET', null, userId);
                                                        }
                                                        printOtpremnica(fullNalog);
                                                    }}
                                                    className="text-blue-600 hover:text-blue-900 mr-2"
                                                    title="Print otpremnica"
                                                >
                                                    üñ®Ô∏è
                                                </button>
                                                <button
                                                    onClick={() => handleView(nalog)}
                                                    className="text-green-600 hover:text-green-900 mr-2"
                                                >
                                                    Pregled
                                                </button>
                                                <button
                                                    onClick={() => handleEdit(nalog)}
                                                    className="text-primary-600 hover:text-blue-900 mr-2"
                                                >
                                                    Uredi
                                                </button>
                                                <button
                                                    onClick={() => handleDelete(nalog.id)}
                                                    className="text-red-600 hover:text-red-900"
                                                >
                                                    Obri≈°i
                                                </button>
                                            </td>
                                            </tr>
                                            {/* Artikli s podsjetnicima - prikazani odmah ispod naloga */}
                                            {nalog.artikli && nalog.artikli.length > 0 && (
                                                <tr className="border-l-4 border-primary-300 nalog-divider">
                                                    <td colSpan="11" className="px-3 py-2">
                                                        {nalog.artikli.map((artikl, idx) => (
                                                            <div key={artikl.id} className={`mb-1 px-2 py-1 rounded ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-100'}`}>
                                                                <div className="flex items-center gap-2">
                                                                    <span className="text-xs text-gray-500 font-medium w-5">{idx + 1}.</span>
                                                                    <span className="text-xs text-gray-800 font-medium">{artikl.naziv}</span>
                                                                    {artikl.format && (
                                                                        <span className="text-xs text-blue-600">| Format: {artikl.format}</span>
                                                                    )}
                                                                    {artikl.opis && (
                                                                        <span className="text-xs text-gray-600">| Opis: {artikl.opis}</span>
                                                                    )}
                                                                    <span className="text-xs text-gray-500">| Koliƒçina: {artikl.kolicina} {artikl.jedinica || 'kom'}</span>
                                                                    <span className="text-xs text-gray-600">| Cijena: {artikl.cijena} EUR</span>
                                                                    <span className="text-xs text-green-600 font-medium">| Ukupno: {(artikl.kolicina * artikl.cijena).toFixed(2)} EUR</span>
                                                                </div>
                                                                {artikl.napomena && (
                                                                    <div className="ml-7 text-xs text-gray-600 italic">
                                                                        üìù {artikl.napomena}
                                                                    </div>
                                                                )}
                                                                {artikl.materijali && artikl.materijali.length > 0 && (
                                                                    <div className="ml-7 mt-0.5">
                                                                        {artikl.materijali.map((m, mIdx) => (
                                                                            <div key={mIdx} className="text-xs text-blue-600">
                                                                                üß± {m.naziv || m.materijalNaziv}: {m.kolicina} {m.jedinica || m.jedinicaMjere || 'kom'}
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                )}
                                                                {artikl.podsjetnici && artikl.podsjetnici.length > 0 && (
                                                                    <div className="ml-7 mt-0.5">
                                                                        {artikl.podsjetnici.map((p, pIdx) => (
                                                                            <div key={pIdx} className={`text-xs ${p.zavrsen ? 'line-through text-gray-400' : p.prioritet === 'visok' ? 'text-red-600 font-semibold' : 'text-yellow-700'}`}>
                                                                                {p.zavrsen ? '‚úì' : 'üìå'} {p.prioritet === 'visok' && !p.zavrsen && '‚ö°'}{p.tekst}
                                                                                {(p.kreiraoIme || p.createdAt) && (
                                                                                    <span className="text-gray-400 font-normal ml-2">
                                                                                        ({p.kreiraoIme}{p.createdAt && `, ${new Date(p.createdAt).toLocaleString('hr-HR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'})}`})
                                                                                    </span>
                                                                                )}
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </td>
                                                </tr>
                                            )}
                                            {/* INLINE EDIT FORMA */}
                                            {editingId === nalog.id && (
                                                <tr>
                                                    <td colSpan="11" className="p-0">
                                                        {renderNalogForm(true)}
                                                    </td>
                                                </tr>
                                            )}
                                                        </React.Fragment>
                                                    );
                                                    })}
                                                </>
                                            )}
                                            
                                            {/* OBRISANI NALOZI - samo admin vidi */}
                                            {isAdmin && obrisaniNalozi.length > 0 && (
                                                <>
                                                    <tr className="bg-gray-300">
                                                        <td colSpan="11" className="px-4 py-3">
                                                            <h3 className="text-base font-bold text-gray-700">üóëÔ∏è OBRISANI NALOZI ({obrisaniNalozi.length})</h3>
                                                        </td>
                                                    </tr>
                                                    {obrisaniNalozi.map((nalog, nalogIdx) => {
                                                        const rowBg = 'bg-gray-100';
                                                        return (
                                                            <tr key={nalog.id} className={`${rowBg} text-xs opacity-60`}>
                                                                <td className="px-3 py-2 font-medium line-through">{nalog.broj}</td>
                                                                <td className="px-3 py-2 line-through">{nalog.nazivNaloga || '-'}</td>
                                                                <td className="px-3 py-2">{formatDate(nalog.datum)}</td>
                                                                <td className="px-3 py-2">{nalog.rokIzrade ? formatDate(nalog.rokIzrade) : '-'}</td>
                                                                <td className="px-3 py-2">{nalog.klijentNaziv}</td>
                                                                <td className="px-3 py-2">{nalog.kontaktOsoba || '-'}</td>
                                                                <td className="px-3 py-2">{nalog.telefon || '-'}</td>
                                                                <td className="px-3 py-2">
                                                                    <span className="px-2 py-1 text-xs rounded bg-gray-200 text-gray-600">
                                                                        Obrisan
                                                                    </span>
                                                                </td>
                                                                <td className="px-3 py-2 text-gray-500">
                                                                    {nalog.obrisaoIme && `${nalog.obrisaoIme}`}
                                                                    {nalog.obrisanAt && (
                                                                        <div className="text-[10px]">
                                                                            {new Date(nalog.obrisanAt).toLocaleString('hr-HR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'})}
                                                                        </div>
                                                                    )}
                                                                </td>
                                                                <td className="px-3 py-2 text-right">{getUkupnaCijena(nalog).toFixed(2)} EUR</td>
                                                                <td className="px-3 py-2 text-right">
                                                                    <button
                                                                        onClick={() => handleRestore(nalog.id)}
                                                                        className="text-green-600 hover:text-green-800 font-medium"
                                                                    >
                                                                        ‚Ü©Ô∏è Vrati
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </>
                                            )}
                                        </>
                                    );
                                })()}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // Renderiranje aplikacije
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
